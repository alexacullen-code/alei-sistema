<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALEI - Sistema Integral de Gestión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
        .gradient-bg { background: linear-gradient(135deg, #00247D 0%, #1e40af 100%); }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-primary { background: #00247D; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: all 0.3s; border: none; cursor: pointer; }
        .btn-primary:hover { background: #1e3a8a; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,36,125,0.3); }
        .btn-danger { background: #dc2626; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; }
        .btn-success { background: #059669; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; }
        .btn-warning { background: #d97706; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; }
        .tab { padding: 12px 24px; cursor: pointer; font-weight: 500; color: #64748b; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab.active { color: #00247D; border-bottom-color: #dc2626; background: #eff6ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-paid { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-overdue { background: #fee2e2; color: #991b1b; }
        .status-partial { background: #dbeafe; color: #1e40af; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; max-height: 90vh; overflow-y: auto; max-width: 900px; width: 90%; }
        .input-field { width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; transition: all 0.3s; }
        .input-field:focus { outline: none; border-color: #00247D; box-shadow: 0 0 0 3px rgba(0,36,125,0.1); }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 16px 24px; background: #00247D; color: white; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); display: none; z-index: 2000; animation: slideIn 0.3s; }
        .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #00247D; transition: width 0.3s; }
        .alert-box { padding: 16px; border-radius: 8px; margin-bottom: 16px; }
        .alert-warning { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; }
        .alert-danger { background: #fee2e2; border: 1px solid #dc2626; color: #991b1b; }
        .alert-success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        .debt-card { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid #dc2626; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .search-box { position: relative; }
        .search-box input { padding-left: 40px; }
        .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .quick-action { transition: all 0.2s; cursor: pointer; }
        .quick-action:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header -->
    <div class="gradient-bg text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <svg class="w-12 h-8" viewBox="0 0 60 30" xmlns="http://www.w3.org/2000/svg">
                    <rect width="60" height="30" fill="#012169"/>
                    <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
                    <path d="M0,0 L60,30 M60,0 L0,30" stroke="#C8102E" stroke-width="4"/>
                    <path d="M30,0 V30 M0,15 H60" stroke="#fff" stroke-width="10"/>
                    <path d="M30,0 V30 M0,15 H60" stroke="#C8102E" stroke-width="6"/>
                </svg>
                <div>
                    <h1 class="text-xl font-bold">ALEI - Sistema Integral</h1>
                    <p class="text-xs opacity-90" id="header-info">Instituto de Inglés</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <select id="year-selector" class="bg-white/20 text-white border border-white/30 rounded-lg px-4 py-2 text-sm font-medium backdrop-blur" onchange="cambiarAnio()">
                    <option value="2025" class="text-gray-900">Año 2025</option>
                    <option value="2026" class="text-gray-900" selected>Año 2026</option>
                    <option value="2027" class="text-gray-900">Año 2027</option>
                </select>
                
                <div class="relative">
                    <button onclick="toggleNotificaciones()" class="relative p-2 hover:bg-white/20 rounded-lg transition">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notif-badge" class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                    <div id="notificaciones-panel" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 text-gray-800 z-50 max-h-96 overflow-y-auto">
                        <div class="p-4 border-b border-gray-200 font-semibold bg-gray-50 rounded-t-xl">
                            Notificaciones
                        </div>
                        <div id="lista-notificaciones" class="p-2 space-y-2">
                            <p class="text-sm text-gray-500 text-center py-4">Sin notificaciones</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="bg-white shadow-sm border-b border-gray-200 sticky top-[73px] z-40">
        <div class="max-w-7xl mx-auto overflow-x-auto">
            <div class="flex min-w-max">
                <button class="tab active" onclick="switchTab('dashboard')"><i class="fas fa-home mr-2"></i>Dashboard</button>
                <button class="tab" onclick="switchTab('caja')"><i class="fas fa-cash-register mr-2"></i>Caja Rápida</button>
                <button class="tab" onclick="switchTab('alumnos')"><i class="fas fa-users mr-2"></i>Alumnos</button>
                <button class="tab" onclick="switchTab('pagos')"><i class="fas fa-money-bill-wave mr-2"></i>Pagos</button>
                <button class="tab" onclick="switchTab('libros')"><i class="fas fa-book mr-2"></i>Libros</button>
                <button class="tab" onclick="switchTab('gastos')"><i class="fas fa-wallet mr-2"></i>Gastos</button>
                <button class="tab" onclick="switchTab('reportes')"><i class="fas fa-chart-bar mr-2"></i>Reportes</button>
                <button class="tab" onclick="switchTab('espera')"><i class="fas fa-clock mr-2"></i>Lista Espera</button>
                <button class="tab" onclick="switchTab('config')"><i class="fas fa-cog mr-2"></i>Config</button>
            </div>
        </div>
    </div>

    <!-- Search Global -->
    <div class="max-w-7xl mx-auto p-4">
        <div class="search-box mb-4">
            <i class="fas fa-search"></i>
            <input type="text" id="global-search" class="input-field" placeholder="Buscar alumno, libro, pago..." oninput="busquedaGlobal(this.value)">
        </div>
        <div id="global-search-results" class="hidden card p-4 mb-4 max-h-64 overflow-y-auto"></div>
    </div>

    <div class="max-w-7xl mx-auto p-4 space-y-6 pb-20">

        <!-- DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="stat-card gradient-bg text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-90">Alumnos Activos</p>
                            <p class="text-3xl font-bold mt-1" id="dash-total-alumnos">0</p>
                        </div>
                        <i class="fas fa-users text-3xl opacity-50"></i>
                    </div>
                </div>
                <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-90">Ingresos Mes</p>
                            <p class="text-3xl font-bold mt-1" id="dash-ingresos">$0</p>
                        </div>
                        <i class="fas fa-arrow-up text-3xl opacity-50"></i>
                    </div>
                </div>
                <div class="stat-card bg-gradient-to-br from-red-500 to-red-600 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-90">Gastos Mes</p>
                            <p class="text-3xl font-bold mt-1" id="dash-gastos">$0</p>
                        </div>
                        <i class="fas fa-arrow-down text-3xl opacity-50"></i>
                    </div>
                </div>
                <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-90">Balance</p>
                            <p class="text-3xl font-bold mt-1" id="dash-balance">$0</p>
                        </div>
                        <i class="fas fa-balance-scale text-3xl opacity-50"></i>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card p-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Mensualidades del Mes Actual</h3>
                        <span class="text-sm text-gray-500" id="mes-actual-nombre"></span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2 text-sm font-semibold text-gray-600">Alumno</th>
                                    <th class="text-left py-2 text-sm font-semibold text-gray-600">Estado</th>
                                    <th class="text-left py-2 text-sm font-semibold text-gray-600">Monto</th>
                                    <th class="text-left py-2 text-sm font-semibold text-gray-600">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="dash-mensualidades"></tbody>
                        </table>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Alertas</h3>
                        <div id="dash-alertas" class="space-y-3">
                            <p class="text-gray-500 text-sm">Cargando alertas...</p>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Cumpleaños</h3>
                        <div id="dash-cumpleanos" class="space-y-2">
                            <p class="text-gray-500 text-sm">Sin cumpleaños este mes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CAJA RÁPIDA (POS) -->
        <div id="tab-caja" class="tab-content">
            <div class="max-w-2xl mx-auto">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Caja Rápida</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Alumno</label>
                            <div class="relative">
                                <input type="text" id="caja-buscar" class="input-field" placeholder="Escriba para buscar..." oninput="buscarAlumnoCaja(this.value)">
                                <div id="caja-resultados" class="absolute w-full bg-white border border-gray-200 rounded-lg mt-1 shadow-lg z-10 hidden max-h-48 overflow-y-auto"></div>
                            </div>
                            <input type="hidden" id="caja-alumno-id">
                        </div>

                        <div id="caja-info-alumno" class="hidden p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <!-- Info dinámica -->
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Concepto</label>
                            <select id="caja-concepto" class="input-field" onchange="actualizarMontoCaja()">
                                <option value="">Seleccione...</option>
                                <option value="mensualidad">Mensualidad</option>
                                <option value="matricula">Matrícula</option>
                                <option value="libro">Libro/Material</option>
                                <option value="examen">Examen</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>

                        <div id="caja-mes-container" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mes a pagar</label>
                            <select id="caja-mes" class="input-field">
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Monto $</label>
                                <input type="number" id="caja-monto" class="input-field text-2xl font-bold text-center" onchange="calcularRecargoDescuento()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                                <input type="date" id="caja-fecha" class="input-field" onchange="calcularRecargoDescuento()">
                            </div>
                        </div>

                        <div id="caja-calculo-info" class="hidden p-3 bg-yellow-50 rounded-lg text-sm"></div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Comentarios</label>
                            <textarea id="caja-comentarios" class="input-field" rows="2" placeholder="Observaciones..."></textarea>
                        </div>

                        <button onclick="procesarPagoCaja()" class="btn-primary w-full py-4 text-lg font-bold mt-4">
                            <i class="fas fa-check-circle mr-2"></i>Registrar Pago
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ALUMNOS -->
        <div id="tab-alumnos" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Gestión de Alumnos</h2>
                <button onclick="abrirModalAlumno()" class="btn-primary">
                    <i class="fas fa-plus mr-2"></i>Nuevo Alumno
                </button>
            </div>

            <div class="card p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="filtro-alumno-nombre" class="input-field" placeholder="Buscar por nombre..." oninput="filtrarAlumnos()">
                    <input type="text" id="filtro-alumno-cedula" class="input-field" placeholder="Buscar por cédula..." oninput="filtrarAlumnos()">
                    <select id="filtro-alumno-nivel" class="input-field" onchange="filtrarAlumnos()">
                        <option value="">Todos los niveles</option>
                    </select>
                    <select id="filtro-alumno-estado" class="input-field" onchange="filtrarAlumnos()">
                        <option value="">Todos los estados</option>
                        <option value="activo">Activo</option>
                        <option value="moroso">Con Deuda</option>
                        <option value="al_dia">Al Día</option>
                    </select>
                </div>
            </div>

            <div class="card overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N°</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alumno</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nivel</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo Mat.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-alumnos" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- PAGOS -->
        <div id="tab-pagos" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Historial de Pagos</h2>
            
            <div class="card p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <input type="date" id="pago-filtro-desde" class="input-field" onchange="cargarPagos()">
                    <input type="date" id="pago-filtro-hasta" class="input-field" onchange="cargarPagos()">
                    <select id="pago-filtro-concepto" class="input-field" onchange="cargarPagos()">
                        <option value="">Todos los conceptos</option>
                        <option value="mensualidad">Mensualidad</option>
                        <option value="matricula">Matrícula</option>
                        <option value="libro">Libro</option>
                        <option value="examen">Examen</option>
                    </select>
                    <select id="pago-filtro-alumno" class="input-field" onchange="cargarPagos()">
                        <option value="">Todos los alumnos</option>
                    </select>
                    <button onclick="exportarPagos()" class="btn-success"><i class="fas fa-download mr-2"></i>Exportar</button>
                </div>
            </div>

            <div class="card overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alumno</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comentarios</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-pagos" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- LIBROS -->
        <div id="tab-libros" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Gestión de Libros</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Asignar Nuevo Libro</h3>
                    <form id="form-libro" onsubmit="guardarLibro(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Alumno</label>
                            <select id="libro-alumno" class="input-field" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Título del Libro</label>
                            <input type="text" id="libro-titulo" class="input-field" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Costo Total $</label>
                            <input type="number" id="libro-costo" class="input-field" required step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Primer Pago (Abono) $</label>
                            <input type="number" id="libro-abono" class="input-field" required step="0.01" onchange="calcularSaldoLibro()">
                        </div>
                        <div class="p-3 bg-gray-100 rounded-lg">
                            <div class="flex justify-between text-sm">
                                <span>Saldo:</span>
                                <span id="libro-saldo-preview" class="font-bold">$0</span>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary w-full">Asignar Libro</button>
                    </form>
                </div>

                <div class="lg:col-span-2 card p-6">
                    <h3 class="text-lg font-bold mb-4">Libros Pendientes de Pago</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Alumno</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Libro</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Total</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Pagado</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Saldo</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-libros-pendientes"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- GASTOS -->
        <div id="tab-gastos" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Control de Gastos</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Nuevo Gasto</h3>
                    <form id="form-gasto" onsubmit="guardarGasto(event)" class="space-y-4">
                        <input type="text" id="gasto-concepto" class="input-field" placeholder="Concepto" required>
                        <input type="number" id="gasto-monto" class="input-field" placeholder="Monto" required step="0.01">
                        <input type="date" id="gasto-fecha" class="input-field" required>
                        <select id="gasto-categoria" class="input-field">
                            <option value="materiales">Materiales</option>
                            <option value="servicios">Servicios</option>
                            <option value="personal">Personal</option>
                            <option value="impuestos">Impuestos</option>
                            <option value="otros">Otros</option>
                        </select>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="gasto-es-cuota" class="w-4 h-4" onchange="toggleCuotasGasto()">
                            <label for="gasto-es-cuota" class="text-sm">Es pago en cuotas</label>
                        </div>
                        <div id="gasto-cuotas-container" class="hidden">
                            <input type="number" id="gasto-numero-cuotas" class="input-field mb-2" placeholder="Número de cuotas" min="2" value="2">
                            <p class="text-xs text-gray-500">Se generarán automáticamente los pagos futuros</p>
                        </div>
                        <button type="submit" class="btn-danger w-full">Registrar Gasto</button>
                    </form>
                </div>

                <div class="lg:col-span-2 card p-6">
                    <h3 class="text-lg font-bold mb-4">Historial de Gastos</h3>
                    <div class="overflow-x-auto max-h-96 overflow-y-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Fecha</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Concepto</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Categoría</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Monto</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-gastos"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- REPORTES -->
        <div id="tab-reportes" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Reportes y Estadísticas</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <button onclick="generarReporte('mensual')" class="card p-6 quick-action text-center hover:bg-blue-50">
                    <i class="fas fa-calendar-alt text-4xl text-blue-600 mb-2"></i>
                    <h3 class="font-bold">Reporte Mensual</h3>
                    <p class="text-sm text-gray-500">Ingresos vs Gastos</p>
                </button>
                <button onclick="generarReporte('morosidad')" class="card p-6 quick-action text-center hover:bg-red-50">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-600 mb-2"></i>
                    <h3 class="font-bold">Morosidad</h3>
                    <p class="text-sm text-gray-500">Deudores detallados</p>
                </button>
                <button onclick="generarReporte('libros')" class="card p-6 quick-action text-center hover:bg-green-50">
                    <i class="fas fa-book text-4xl text-green-600 mb-2"></i>
                    <h3 class="font-bold">Libros</h3>
                    <p class="text-sm text-gray-500">Estado de libros</p>
                </button>
            </div>

            <div id="reporte-container" class="card p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="reporte-titulo" class="text-lg font-bold"></h3>
                    <button onclick="exportarReporteActual()" class="btn-success text-sm">
                        <i class="fas fa-file-export mr-2"></i>Exportar Excel
                    </button>
                </div>
                <div id="reporte-contenido"></div>
            </div>
        </div>

        <!-- LISTA DE ESPERA -->
        <div id="tab-espera" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Pre-inscripciones y Lista de Espera</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Nueva Pre-inscripción</h3>
                    <form id="form-espera" onsubmit="guardarEspera(event)" class="space-y-4">
                        <input type="text" id="espera-nombre" class="input-field" placeholder="Nombre completo" required>
                        <input type="text" id="espera-telefono" class="input-field" placeholder="Teléfono" required>
                        <input type="email" id="espera-email" class="input-field" placeholder="Email (opcional)">
                        <select id="espera-nivel" class="input-field" required>
                            <option value="">Nivel de interés...</option>
                        </select>
                        <input type="text" id="espera-observaciones" class="input-field" placeholder="Observaciones">
                        <button type="submit" class="btn-primary w-full">Agregar a Lista</button>
                    </form>
                </div>

                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Lista de Espera</h3>
                    <div class="space-y-3" id="lista-espera">
                        <!-- Dinámico -->
                    </div>
                </div>
            </div>
        </div>

        <!-- CONFIGURACIÓN -->
        <div id="tab-config" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Configuración y Backup</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-blue-900 mb-4">Backup por Sección</h3>
                    <div class="space-y-2">
                        <button onclick="exportarSeccion('niveles')" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg flex justify-between items-center">
                            <span><i class="fas fa-layer-group mr-2"></i>Niveles</span>
                            <i class="fas fa-download text-blue-600"></i>
                        </button>
                        <button onclick="exportarSeccion('alumnos')" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg flex justify-between items-center">
                            <span><i class="fas fa-users mr-2"></i>Alumnos</span>
                            <i class="fas fa-download text-blue-600"></i>
                        </button>
                        <button onclick="exportarSeccion('libros')" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg flex justify-between items-center">
                            <span><i class="fas fa-book mr-2"></i>Libros</span>
                            <i class="fas fa-download text-blue-600"></i>
                        </button>
                        <button onclick="exportarSeccion('pagos')" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg flex justify-between items-center">
                            <span><i class="fas fa-money-bill-wave mr-2"></i>Pagos</span>
                            <i class="fas fa-download text-blue-600"></i>
                        </button>
                        <button onclick="exportarSeccion('gastos')" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg flex justify-between items-center">
                            <span><i class="fas fa-wallet mr-2"></i>Gastos</span>
                            <i class="fas fa-download text-blue-600"></i>
                        </button>
                        <button onclick="exportarTodo()" class="w-full p-3 bg-blue-600 text-white rounded-lg font-bold mt-4">
                            <i class="fas fa-archive mr-2"></i>Backup Completo
                        </button>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-lg font-bold text-green-900 mb-4">Importar Datos</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Subir archivo JSON</label>
                            <input type="file" id="import-file" class="input-field" accept=".json" onchange="importarArchivo(this)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">O pegar JSON aquí:</label>
                            <textarea id="import-texto" class="input-field" rows="4" placeholder='{"niveles": [...]}'></textarea>
                        </div>
                        <select id="import-tipo" class="input-field">
                            <option value="todo">Importar Todo (Reemplazar)</option>
                            <option value="niveles">Solo Niveles</option>
                            <option value="alumnos">Solo Alumnos</option>
                            <option value="libros">Solo Libros</option>
                            <option value="pagos">Solo Pagos</option>
                            <option value="gastos">Solo Gastos</option>
                            <option value="merge">Fusionar (Agregar a existente)</option>
                        </select>
                        <button onclick="importarTexto()" class="btn-success w-full">Importar Datos</button>
                    </div>
                </div>
            </div>

            <div class="card p-6 border-2 border-red-200 bg-red-50">
                <h3 class="text-lg font-bold text-red-900 mb-4">⚠️ Zona Peligrosa</h3>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-red-800 mb-1">Resetear Sistema</p>
                        <p class="text-xs text-red-600">Elimina TODOS los datos. Requiere confirmación doble.</p>
                    </div>
                    <button onclick="resetearSistemaPaso1()" class="btn-danger" id="btn-reset-1">Resetear Todo</button>
                </div>
                <div id="reset-confirmacion" class="hidden mt-4 p-4 bg-white rounded-lg border border-red-300">
                    <p class="text-sm text-red-800 mb-2">¿Está 100% seguro? Esta acción no se puede deshacer.</p>
                    <p class="text-xs text-gray-500 mb-3">Escriba "ELIMINAR TODO" para confirmar:</p>
                    <input type="text" id="reset-texto" class="input-field mb-2" placeholder="ELIMINAR TODO">
                    <div class="flex gap-2">
                        <button onclick="resetearSistemaPaso2()" class="btn-danger flex-1">Confirmar Eliminación</button>
                        <button onclick="cancelarReset()" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal Alumno -->
    <div class="modal" id="modal-alumno">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold" id="modal-alumno-titulo">Nuevo Alumno</h3>
                <button onclick="cerrarModal('modal-alumno')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <form id="form-alumno" onsubmit="guardarAlumno(event)" class="space-y-4">
                <input type="hidden" id="alumno-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label>
                        <input type="text" id="alumno-nombre" class="input-field" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cédula *</label>
                        <input type="text" id="alumno-cedula" class="input-field" required onblur="validarCedulaExistente()">
                        <p id="cedula-error" class="text-red-500 text-xs hidden">Esta cédula ya existe</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                        <input type="text" id="alumno-telefono" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tel. Alternativo</label>
                        <input type="text" id="alumno-telefono2" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="alumno-email" class="input-field">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Padre/Madre/Tutor</label>
                        <input type="text" id="alumno-tutor" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                        <input type="text" id="alumno-direccion" class="input-field">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Nacimiento</label>
                        <input type="date" id="alumno-nacimiento" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nivel *</label>
                        <select id="alumno-nivel" class="input-field" required>
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Matrícula *</label>
                        <select id="alumno-tipo-matricula" class="input-field" required onchange="verificarTipoHermano()">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inscripción</label>
                        <input type="date" id="alumno-fecha" class="input-field" required>
                    </div>
                    <div class="flex items-center gap-2 mt-8">
                        <input type="checkbox" id="alumno-es-hermano" class="w-4 h-4">
                        <label for="alumno-es-hermano" class="text-sm">¿Es hermano de alumno existente? (No aplica recargos/descuentos)</label>
                    </div>
                </div>

                <div id="alumno-cuota-personalizada-container" class="hidden p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Monto de cuota personalizado (para hermanos)</label>
                    <input type="number" id="alumno-cuota-personalizada" class="input-field" placeholder="Ej: 2000">
                    <p class="text-xs text-gray-500 mt-1">Este monto será fijo sin recargos ni descuentos por fecha</p>
                </div>

                <div class="flex gap-2 pt-4">
                    <button type="submit" class="btn-primary flex-1">Guardar Alumno</button>
                    <button type="button" onclick="cerrarModal('modal-alumno')" class="bg-gray-500 text-white px-6 py-2 rounded-lg">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ficha Alumno -->
    <div class="modal" id="modal-ficha">
        <div class="modal-content p-6 max-w-4xl">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h3 class="text-2xl font-bold text-blue-900" id="ficha-nombre"></h3>
                <div class="flex gap-2">
                    <button onclick="generarMensajeWhatsApp()" class="btn-success text-sm">
                        <i class="fab fa-whatsapp mr-2"></i>Enviar WhatsApp
                    </button>
                    <button onclick="cerrarModal('modal-ficha')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
            </div>
            
            <div id="ficha-contenido" class="space-y-6">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

    <!-- Modal Abono Libro -->
    <div class="modal" id="modal-abono-libro">
        <div class="modal-content p-6 max-w-md">
            <h3 class="text-xl font-bold mb-4">Registrar Abono</h3>
            <div id="abono-libro-info" class="mb-4 p-3 bg-blue-50 rounded-lg"></div>
            
            <form onsubmit="registrarAbonoLibro(event)" class="space-y-4">
                <input type="hidden" id="abono-libro-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Monto a abonar $</label>
                    <input type="number" id="abono-monto" class="input-field" required step="0.01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Comentarios</label>
                    <textarea id="abono-comentarios" class="input-field" rows="2"></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn-primary flex-1">Registrar</button>
                    <button type="button" onclick="cerrarModal('modal-abono-libro')" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // === CONFIGURACIÓN GLOBAL ===
        const ANIO_ACTUAL = new Date().getFullYear();
        let anioSeleccionado = parseInt(localStorage.getItem('alei_anio_activo')) || ANIO_ACTUAL;
        
        // Inicializar datos si no existen
        function initStorage() {
            const keys = ['niveles', 'alumnos', 'libros', 'pagos', 'gastos', 'tiposMatricula', 'espera', 'auditoria'];
            keys.forEach(key => {
                const fullKey = `alei_${key}_${anioSeleccionado}`;
                if (!localStorage.getItem(fullKey)) {
                    localStorage.setItem(fullKey, JSON.stringify([]));
                }
            });
            
            // Cargar datos del JSON de ejemplo si es 2026 y está vacío
            if (anioSeleccionado === 2026 && getData('niveles').length === 0) {
                cargarDatosEjemplo();
            }
        }

        function getData(tipo) {
            const key = `alei_${tipo}_${anioSeleccionado}`;
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function setData(tipo, data) {
            const key = `alei_${tipo}_${anioSeleccionado}`;
            localStorage.setItem(key, JSON.stringify(data));
        }

        function addAudit(action, details) {
            const auditoria = getData('auditoria');
            auditoria.push({
                id: Date.now(),
                fecha: new Date().toISOString(),
                accion: action,
                detalles: details,
                usuario: 'Admin'
            });
            setData('auditoria', auditoria);
        }

        // === DATOS DE EJEMPLO (Del JSON proporcionado) ===
        function cargarDatosEjemplo() {
            const datosEjemplo = {
                niveles: [
                    {id: 1, nombre: "1st CH", precio: 1500},
                    {id: 2, nombre: "2nd CH", precio: 1600},
                    {id: 3, nombre: "3rd CH", precio: 1700},
                    {id: 4, nombre: "4th CH", precio: 1800},
                    {id: 5, nombre: "1st J", precio: 1600},
                    {id: 6, nombre: "2nd J", precio: 1700},
                    {id: 7, nombre: "3rd J", precio: 1900},
                    {id: 8, nombre: "4th J", precio: 2000},
                    {id: 9, nombre: "5th J", precio: 2100},
                    {id: 10, nombre: "PET", precio: 2200},
                    {id: 11, nombre: "FCE", precio: 2300},
                    {id: 12, nombre: "CAE", precio: 2400}
                ],
                tiposMatricula: [
                    {id: 1, nombre: "Regular", costo: 1500, descripcion: "Matrícula estándar"},
                    {id: 2, nombre: "Matricula x 2", costo: 1250, descripcion: ""},
                    {id: 3, nombre: "Matricula x 3", costo: 1300, descripcion: ""}
                ],
                alumnos: [
                    {id: 1, numero_anual: 1, nombre: "ALDANA GARCÍA", cedula: "6.049.977-0", telefono: "097114886", telefono2: "", email: "", tutor: "", direccion: "DOMINGO MORA 7860", fecha_nacimiento: "", nivel_id: 7, tipo_matricula_id: 1, es_hermano: false, cuota_personalizada: null, fecha_inscripcion: "2026-02-02", activo: true},
                    {id: 2, numero_anual: 2, nombre: "INGRID MEDEIROS", cedula: "5.927.213-7", telefono: "097317283", telefono2: "", email: "", tutor: "", direccion: "ROMAN DE ACHA 3275", fecha_nacimiento: "", nivel_id: 6, tipo_matricula_id: 1, es_hermano: false, cuota_personalizada: null, fecha_inscripcion: "2026-02-02", activo: true},
                    {id: 27, numero_anual: 27, nombre: "ISABELLA SCHREIBER", cedula: "6.316.012-0", telefono: "094943322", telefono2: "", email: "", tutor: "", direccion: "Jose Livi 8075 bis", fecha_nacimiento: "", nivel_id: 1, tipo_matricula_id: 2, es_hermano: true, cuota_personalizada: 1250, fecha_inscripcion: "2026-02-18", activo: true}
                ],
                libros: [
                    {id: 1, alumno_id: 1, alumno_nombre: "ALDANA GARCÍA", titulo: "Wider World 2 Wb", costo_total: 700, pagado: 0, saldo: 700, pagos: [], fecha_asignacion: "2026-02-18"},
                    {id: 2, alumno_id: 1, alumno_nombre: "ALDANA GARCÍA", titulo: "Wider World 2 St", costo_total: 900, pagado: 0, saldo: 900, pagos: [], fecha_asignacion: "2026-02-18"}
                ],
                gastos: [
                    {id: 1, fecha: "2026-02-09", concepto: "Marcadores pizarra", monto: 1300, categoria: "materiales", es_cuota: false},
                    {id: 2, fecha: "2026-08-01", concepto: "Impresora (cuota 6)", monto: 2524, categoria: "materiales", es_cuota: true, cuota_numero: 6, total_cuotas: 6}
                ],
                pagos: []
            };
            
            Object.keys(datosEjemplo).forEach(key => {
                setData(key, datosEjemplo[key]);
            });
            
            showToast('Datos de ejemplo cargados para 2026');
        }

        // === UTILIDADES ===
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = type === 'error' ? '#dc2626' : type === 'warning' ? '#d97706' : '#00247D';
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        function formatMoney(amount) {
            return '$' + parseFloat(amount).toLocaleString('es-UY', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }

        function getToday() {
            return new Date().toISOString().split('T')[0];
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getUltimoNumeroAnual() {
            const alumnos = getData('alumnos');
            if (alumnos.length === 0) return 0;
            return Math.max(...alumnos.map(a => a.numero_anual || 0));
        }

        // === CÁLCULO DE RECARGOS/DESCUENTOS ===
        function calcularMontoMensualidad(alumnoId, montoBase, fechaPago, mesPago) {
            const alumno = getData('alumnos').find(a => a.id == alumnoId);
            if (!alumno) return { monto: montoBase, detalle: 'Alumno no encontrado' };
            
            // Si es hermano con cuota personalizada, no aplica recargos/descuentos
            if (alumno.es_hermano && alumno.cuota_personalizada) {
                return { 
                    monto: alumno.cuota_personalizada, 
                    detalle: `Cuota fija hermano: ${formatMoney(alumno.cuota_personalizada)}` 
                };
            }
            
            const fecha = new Date(fechaPago);
            const dia = fecha.getDate();
            const mesActual = fecha.getMonth() + 1;
            const mesPagoInt = parseInt(mesPago);
            
            // Si paga antes del 10 del mes que corresponde: descuento $150
            // Si paga entre 11 y 15: precio exacto
            // Si paga después del 16 del mes que corresponde: recargo $150
            
            // Lógica: si paga el mes anterior o antes del 10 del mes de pago: descuento
            // Si paga después del 15 del mes de pago o meses siguientes: recargo
            
            let montoFinal = montoBase;
            let detalle = `Precio regular: ${formatMoney(montoBase)}`;
            
            if (mesActual < mesPagoInt || (mesActual === mesPagoInt && dia <= 10)) {
                // Pago anticipado o antes del 10
                montoFinal = montoBase - 150;
                detalle = `Descuento pronto pago (-$150): ${formatMoney(montoFinal)}`;
            } else if (mesActual === mesPagoInt && dia >= 11 && dia <= 15) {
                // Pago normal
                montoFinal = montoBase;
                detalle = `Precio exacto (días 11-15): ${formatMoney(montoFinal)}`;
            } else {
                // Pago tarde (despues del 16 o mes siguiente)
                montoFinal = montoBase + 150;
                detalle = `Recargo por mora (+$150): ${formatMoney(montoFinal)}`;
            }
            
            return { monto: montoFinal, detalle };
        }

        // === NAVEGACIÓN ===
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') cargarDashboard();
            if (tabName === 'alumnos') cargarAlumnos();
            if (tabName === 'pagos') { cargarPagos(); cargarSelectAlumnos(); }
            if (tabName === 'libros') cargarLibros();
            if (tabName === 'gastos') cargarGastos();
            if (tabName === 'config') cargarConfiguracion();
            if (tabName === 'espera') cargarEspera();
            if (tabName === 'caja') initCaja();
        }

        function cambiarAnio() {
            anioSeleccionado = parseInt(document.getElementById('year-selector').value);
            localStorage.setItem('alei_anio_activo', anioSeleccionado);
            initStorage();
            cargarDashboard();
            showToast(`Año cambiado a ${anioSeleccionado}`);
        }

        // === DASHBOARD ===
        function cargarDashboard() {
            const alumnos = getData('alumnos').filter(a => a.activo !== false);
            const pagos = getData('pagos');
            const gastos = getData('gastos');
            const libros = getData('libros');
            
            // Stats
            document.getElementById('dash-total-alumnos').textContent = alumnos.length;
            
            const mesActual = new Date().getMonth() + 1;
            const ingresosMes = pagos.filter(p => {
                const fecha = new Date(p.fecha);
                return fecha.getMonth() + 1 === mesActual && fecha.getFullYear() === anioSeleccionado;
            }).reduce((sum, p) => sum + parseFloat(p.monto), 0);
            
            const gastosMes = gastos.filter(g => {
                const fecha = new Date(g.fecha);
                return fecha.getMonth() + 1 === mesActual && fecha.getFullYear() === anioSeleccionado;
            }).reduce((sum, g) => sum + parseFloat(g.monto), 0);
            
            document.getElementById('dash-ingresos').textContent = formatMoney(ingresosMes);
            document.getElementById('dash-gastos').textContent = formatMoney(gastosMes);
            document.getElementById('dash-balance').textContent = formatMoney(ingresosMes - gastosMes);
            
            // Mensualidades del mes
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Setiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('mes-actual-nombre').textContent = meses[mesActual - 1] + ' ' + anioSeleccionado;
            
            let htmlMensualidades = '';
            alumnos.forEach(alumno => {
                const pagoMes = pagos.find(p => p.alumno_id == alumno.id && p.concepto === 'mensualidad' && p.mes == mesActual);
                const nivel = getData('niveles').find(n => n.id == alumno.nivel_id);
                const montoBase = nivel ? nivel.precio : 0;
                
                if (pagoMes) {
                    htmlMensualidades += `<tr class="border-b">
                        <td class="py-2">${alumno.nombre}</td>
                        <td><span class="status-badge status-paid">Pagado</span></td>
                        <td>${formatMoney(pagoMes.monto)}</td>
                        <td>-</td>
                    </tr>`;
                } else {
                    const calculo = calcularMontoMensualidad(alumno.id, montoBase, getToday(), mesActual);
                    htmlMensualidades += `<tr class="border-b bg-red-50">
                        <td class="py-2 font-medium">${alumno.nombre}</td>
                        <td><span class="status-badge status-overdue">Pendiente</span></td>
                        <td class="text-red-600 font-bold">${formatMoney(calculo.monto)}</td>
                        <td><button onclick="registrarPagoRapido(${alumno.id})" class="text-blue-600 hover:underline text-sm">Cobrar</button></td>
                    </tr>`;
                }
            });
            document.getElementById('dash-mensualidades').innerHTML = htmlMensualidades || '<tr><td colspan="4" class="text-center py-4 text-gray-500">No hay alumnos registrados</td></tr>';
            
            // Alertas
            const alertas = [];
            
            // Libros pendientes
            const librosPendientes = libros.filter(l => l.saldo > 0);
            if (librosPendientes.length > 0) {
                alertas.push({
                    tipo: 'warning',
                    mensaje: `${librosPendientes.length} libros con saldo pendiente`,
                    accion: () => switchTab('libros')
                });
            }
            
            // Cumpleaños
            const hoy = new Date();
            const cumpleanos = alumnos.filter(a => {
                if (!a.fecha_nacimiento) return false;
                const fecha = new Date(a.fecha_nacimiento);
                return fecha.getMonth() === hoy.getMonth() && fecha.getDate() === hoy.getDate();
            });
            
            let htmlCumple = '';
            if (cumpleanos.length > 0) {
                cumpleanos.forEach(c => {
                    htmlCumple += `<div class="flex items-center gap-2 p-2 bg-pink-50 rounded-lg">
                        <i class="fas fa-birthday-cake text-pink-500"></i>
                        <span class="text-sm">${c.nombre}</span>
                    </div>`;
                });
            } else {
                htmlCumple = '<p class="text-gray-500 text-sm">Sin cumpleaños hoy</p>';
            }
            document.getElementById('dash-cumpleanos').innerHTML = htmlCumple;
            
            // Actualizar badge de notificaciones
            const totalNotifs = librosPendientes.length + (cumpleanos.length > 0 ? 1 : 0);
            const badge = document.getElementById('notif-badge');
            if (totalNotifs > 0) {
                badge.textContent = totalNotifs;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            // Renderizar alertas
            let htmlAlertas = '';
            alertas.forEach(a => {
                htmlAlertas += `<div class="alert-box alert-warning cursor-pointer" onclick="(${a.accion})()">
                    <i class="fas fa-exclamation-triangle mr-2"></i>${a.mensaje}
                </div>`;
            });
            if (alertas.length === 0) {
                htmlAlertas = '<p class="text-green-600 text-sm"><i class="fas fa-check-circle mr-2"></i>Sin alertas pendientes</p>';
            }
            document.getElementById('dash-alertas').innerHTML = htmlAlertas;
        }

        function toggleNotificaciones() {
            const panel = document.getElementById('notificaciones-panel');
            panel.classList.toggle('hidden');
        }

        // === CAJA RÁPIDA ===
        function initCaja() {
            document.getElementById('caja-fecha').value = getToday();
            document.getElementById('caja-alumno-id').value = '';
            document.getElementById('caja-info-alumno').classList.add('hidden');
        }

        function buscarAlumnoCaja(texto) {
            if (texto.length < 2) {
                document.getElementById('caja-resultados').classList.add('hidden');
                return;
            }
            const alumnos = getData('alumnos').filter(a => a.activo !== false);
            const filtrados = alumnos.filter(a => a.nombre.toLowerCase().includes(texto.toLowerCase()) || a.cedula.includes(texto));
            
            const div = document.getElementById('caja-resultados');
            div.innerHTML = filtrados.map(a => `
                <div class="p-2 hover:bg-blue-50 cursor-pointer border-b" onclick="seleccionarAlumnoCaja(${a.id}, '${a.nombre}')">
                    <div class="font-medium">${a.nombre}</div>
                    <div class="text-xs text-gray-500">${a.cedula}</div>
                </div>
            `).join('');
            div.classList.remove('hidden');
        }

        function seleccionarAlumnoCaja(id, nombre) {
            document.getElementById('caja-alumno-id').value = id;
            document.getElementById('caja-info-alumno').innerHTML = `<strong>Alumno:</strong> ${nombre}`;
            document.getElementById('caja-info-alumno').classList.remove('hidden');
            document.getElementById('caja-resultados').classList.add('hidden');
            document.getElementById('caja-buscar').value = nombre;
            actualizarMontoCaja();
        }

        function actualizarMontoCaja() {
            const concepto = document.getElementById('caja-concepto').value;
            const alumnoId = document.getElementById('caja-alumno-id').value;
            const containerMes = document.getElementById('caja-mes-container');
            
            containerMes.classList.toggle('hidden', concepto !== 'mensualidad');
            
            if (alumnoId && concepto === 'mensualidad') {
                const alumno = getData('alumnos').find(a => a.id == alumnoId);
                const nivel = getData('niveles').find(n => n.id == alumno.nivel_id);
                if (nivel) {
                    const hoy = new Date();
                    document.getElementById('caja-mes').value = hoy.getMonth() + 1;
                    const calculo = calcularMontoMensualidad(alumnoId, nivel.precio, getToday(), hoy.getMonth() + 1);
                    document.getElementById('caja-monto').value = calculo.monto;
                    document.getElementById('caja-calculo-info').textContent = calculo.detalle;
                    document.getElementById('caja-calculo-info').classList.remove('hidden');
                }
            } else if (concepto === 'matricula' && alumnoId) {
                const alumno = getData('alumnos').find(a => a.id == alumnoId);
                const tipoMat = getData('tiposMatricula').find(t => t.id == alumno.tipo_matricula_id);
                const deuda = getDeudaMatricula(alumno);
                document.getElementById('caja-monto').value = deuda;
            }
        }

        function calcularRecargoDescuento() {
            const concepto = document.getElementById('caja-concepto').value;
            if (concepto !== 'mensualidad') return;
            
            const alumnoId = document.getElementById('caja-alumno-id').value;
            const fecha = document.getElementById('caja-fecha').value;
            const mes = document.getElementById('caja-mes').value;
            
            if (!alumnoId || !fecha || !mes) return;
            
            const alumno = getData('alumnos').find(a => a.id == alumnoId);
            const nivel = getData('niveles').find(n => n.id == alumno.nivel_id);
            
            if (nivel) {
                const calculo = calcularMontoMensualidad(alumnoId, nivel.precio, fecha, mes);
                document.getElementById('caja-monto').value = calculo.monto;
                document.getElementById('caja-calculo-info').textContent = calculo.detalle;
                document.getElementById('caja-calculo-info').classList.remove('hidden');
            }
        }

        function procesarPagoCaja() {
            const alumnoId = document.getElementById('caja-alumno-id').value;
            if (!alumnoId) {
                showToast('Seleccione un alumno primero', 'error');
                return;
            }
            
            const pago = {
                id: generateId(),
                alumno_id: alumnoId,
                concepto: document.getElementById('caja-concepto').value,
                monto: parseFloat(document.getElementById('caja-monto').value),
                fecha: document.getElementById('caja-fecha').value,
                mes: document.getElementById('caja-mes').value,
                comentarios: document.getElementById('caja-comentarios').value,
                timestamp: new Date().toISOString()
            };
            
            const pagos = getData('pagos');
            pagos.push(pago);
            setData('pagos', pagos);
            
            addAudit('pago_caja', `Pago registrado para alumno ${alumnoId}, concepto: ${pago.concepto}, monto: ${pago.monto}`);
            
            showToast('Pago registrado correctamente');
            initCaja();
            document.getElementById('caja-buscar').value = '';
            document.getElementById('caja-concepto').value = '';
            document.getElementById('caja-monto').value = '';
            document.getElementById('caja-comentarios').value = '';
        }

        function registrarPagoRapido(alumnoId) {
            switchTab('caja');
            const alumno = getData('alumnos').find(a => a.id == alumnoId);
            seleccionarAlumnoCaja(alumnoId, alumno.nombre);
            document.getElementById('caja-concepto').value = 'mensualidad';
            actualizarMontoCaja();
        }

        // === ALUMNOS ===
        function abrirModalAlumno(alumnoId = null) {
            document.getElementById('form-alumno').reset();
            document.getElementById('alumno-id').value = '';
            document.getElementById('cedula-error').classList.add('hidden');
            document.getElementById('alumno-fecha').value = getToday();
            
            // Cargar selects
            const niveles = getData('niveles');
            const tipos = getData('tiposMatricula');
            
            document.getElementById('alumno-nivel').innerHTML = '<option value="">Seleccione...</option>' + 
                niveles.map(n => `<option value="${n.id}">${n.nombre}</option>`).join('');
            
            document.getElementById('alumno-tipo-matricula').innerHTML = '<option value="">Seleccione...</option>' + 
                tipos.map(t => `<option value="${t.id}">${t.nombre}</option>`).join('');
            
            if (alumnoId) {
                const alumno = getData('alumnos').find(a => a.id == alumnoId);
                document.getElementById('alumno-id').value = alumno.id;
                document.getElementById('alumno-nombre').value = alumno.nombre;
                document.getElementById('alumno-cedula').value = alumno.cedula;
                document.getElementById('alumno-telefono').value = alumno.telefono || '';
                document.getElementById('alumno-telefono2').value = alumno.telefono2 || '';
                document.getElementById('alumno-email').value = alumno.email || '';
                document.getElementById('alumno-tutor').value = alumno.tutor || '';
                document.getElementById('alumno-direccion').value = alumno.direccion || '';
                document.getElementById('alumno-nacimiento').value = alumno.fecha_nacimiento || '';
                document.getElementById('alumno-nivel').value = alumno.nivel_id;
                document.getElementById('alumno-tipo-matricula').value = alumno.tipo_matricula_id;
                document.getElementById('alumno-fecha').value = alumno.fecha_inscripcion;
                document.getElementById('alumno-es-hermano').checked = alumno.es_hermano || false;
                document.getElementById('alumno-cuota-personalizada').value = alumno.cuota_personalizada || '';
                
                if (alumno.es_hermano) {
                    document.getElementById('alumno-cuota-personalizada-container').classList.remove('hidden');
                }
                
                document.getElementById('modal-alumno-titulo').textContent = 'Editar Alumno';
            } else {
                document.getElementById('modal-alumno-titulo').textContent = 'Nuevo Alumno';
            }
            
            document.getElementById('modal-alumno').classList.add('active');
        }

        function validarCedulaExistente() {
            const cedula = document.getElementById('alumno-cedula').value;
            const idActual = document.getElementById('alumno-id').value;
            const alumnos = getData('alumnos');
            
            const existe = alumnos.find(a => a.cedula === cedula && a.id != idActual);
            if (existe) {
                document.getElementById('cedula-error').classList.remove('hidden');
            } else {
                document.getElementById('cedula-error').classList.add('hidden');
            }
        }

        function verificarTipoHermano() {
            const checkbox = document.getElementById('alumno-es-hermano');
            if (checkbox.checked) {
                document.getElementById('alumno-cuota-personalizada-container').classList.remove('hidden');
            } else {
                document.getElementById('alumno-cuota-personalizada-container').classList.add('hidden');
            }
        }

        function guardarAlumno(e) {
            e.preventDefault();
            
            // Validar cédula única
            const cedula = document.getElementById('alumno-cedula').value;
            const idActual = document.getElementById('alumno-id').value;
            const alumnos = getData('alumnos');
            
            if (alumnos.find(a => a.cedula === cedula && a.id != idActual)) {
                showToast('Error: La cédula ya existe', 'error');
                return;
            }
            
            const esHermano = document.getElementById('alumno-es-hermano').checked;
            const alumnoData = {
                id: idActual || generateId(),
                numero_anual: idActual ? alumnos.find(a => a.id == idActual)?.numero_anual : (getUltimoNumeroAnual() + 1),
                nombre: document.getElementById('alumno-nombre').value,
                cedula: cedula,
                telefono: document.getElementById('alumno-telefono').value,
                telefono2: document.getElementById('alumno-telefono2').value,
                email: document.getElementById('alumno-email').value,
                tutor: document.getElementById('alumno-tutor').value,
                direccion: document.getElementById('alumno-direccion').value,
                fecha_nacimiento: document.getElementById('alumno-nacimiento').value,
                nivel_id: parseInt(document.getElementById('alumno-nivel').value),
                tipo_matricula_id: parseInt(document.getElementById('alumno-tipo-matricula').value),
                fecha_inscripcion: document.getElementById('alumno-fecha').value,
                es_hermano: esHermano,
                cuota_personalizada: esHermano ? parseFloat(document.getElementById('alumno-cuota-personalizada').value) || null : null,
                activo: true
            };
            
            if (idActual) {
                const idx = alumnos.findIndex(a => a.id == idActual);
                alumnos[idx] = alumnoData;
                addAudit('alumno_editado', `Alumno editado: ${alumnoData.nombre}`);
            } else {
                alumnos.push(alumnoData);
                addAudit('alumno_nuevo', `Nuevo alumno: ${alumnoData.nombre}`);
            }
            
            setData('alumnos', alumnos);
            cerrarModal('modal-alumno');
            cargarAlumnos();
            showToast('Alumno guardado correctamente');
        }

        function cargarAlumnos() {
            const alumnos = getData('alumnos').filter(a => a.activo !== false);
            const niveles = getData('niveles');
            const tipos = getData('tiposMatricula');
            
            // Actualizar filtros
            document.getElementById('filtro-alumno-nivel').innerHTML = '<option value="">Todos los niveles</option>' + 
                niveles.map(n => `<option value="${n.id}">${n.nombre}</option>`).join('');
            
            renderTablaAlumnos(alumnos);
        }

        function renderTablaAlumnos(alumnos) {
            const niveles = getData('niveles');
            const tipos = getData('tiposMatricula');
            
            let html = '';
            alumnos.forEach(a => {
                const nivel = niveles.find(n => n.id == a.nivel_id);
                const tipo = tipos.find(t => t.id == a.tipo_matricula_id);
                const deudaMat = getDeudaMatricula(a);
                const deudaLibros = getDeudaLibros(a.id);
                
                let estado = '<span class="status-badge status-paid">Al Día</span>';
                if (deudaMat > 0 || deudaLibros > 0) {
                    estado = '<span class="status-badge status-overdue">Con Deuda</span>';
                }
                
                html += `<tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${a.numero_anual}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${a.nombre}</div>
                        <div class="text-xs text-gray-500">${a.cedula}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${nivel?.nombre || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tipo?.nombre || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${estado}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="verFichaAlumno(${a.id})" class="text-blue-600 hover:text-blue-900 mr-3">Ver Ficha</button>
                        <button onclick="abrirModalAlumno(${a.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</button>
                        <button onclick="darDeBajaAlumno(${a.id})" class="text-red-600 hover:text-red-900">Baja</button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('tabla-alumnos').innerHTML = html || '<tr><td colspan="6" class="text-center py-4 text-gray-500">No hay alumnos</td></tr>';
        }

        function filtrarAlumnos() {
            const nombre = document.getElementById('filtro-alumno-nombre').value.toLowerCase();
            const cedula = document.getElementById('filtro-alumno-cedula').value.toLowerCase();
            const nivel = document.getElementById('filtro-alumno-nivel').value;
            const estado = document.getElementById('filtro-alumno-estado').value;
            
            let alumnos = getData('alumnos').filter(a => a.activo !== false);
            
            if (nombre) alumnos = alumnos.filter(a => a.nombre.toLowerCase().includes(nombre));
            if (cedula) alumnos = alumnos.filter(a => a.cedula.toLowerCase().includes(cedula));
            if (nivel) alumnos = alumnos.filter(a => a.nivel_id == nivel);
            
            if (estado === 'moroso') {
                alumnos = alumnos.filter(a => getDeudaMatricula(a) > 0 || getDeudaLibros(a.id) > 0);
            } else if (estado === 'al_dia') {
                alumnos = alumnos.filter(a => getDeudaMatricula(a) === 0 && getDeudaLibros(a.id) === 0);
            }
            
            renderTablaAlumnos(alumnos);
        }

        function getDeudaMatricula(alumno) {
            const tipo = getData('tiposMatricula').find(t => t.id == alumno.tipo_matricula_id);
            const pagos = getData('pagos').filter(p => p.alumno_id == alumno.id && p.concepto === 'matricula');
            const totalPagado = pagos.reduce((sum, p) => sum + parseFloat(p.monto), 0);
            const debe = tipo ? tipo.costo : 0;
            return Math.max(0, debe - totalPagado);
        }

        function getDeudaLibros(alumnoId) {
            const libros = getData('libros').filter(l => l.alumno_id == alumnoId);
            return libros.reduce((sum, l) => sum + l.saldo, 0);
        }

        function darDeBajaAlumno(id) {
            if (!confirm('¿Dar de baja este alumno? Los datos se mantendrán pero no aparecerá en listados activos.')) return;
            
            const alumnos = getData('alumnos');
            const idx = alumnos.findIndex(a => a.id == id);
            alumnos[idx].activo = false;
            setData('alumnos', alumnos);
            cargarAlumnos();
            showToast('Alumno dado de baja');
        }

        function verFichaAlumno(id) {
            const alumno = getData('alumnos').find(a => a.id == id);
            const nivel = getData('niveles').find(n => n.id == alumno.nivel_id);
            const tipoMat = getData('tiposMatricula').find(t => t.id == alumno.tipo_matricula_id);
            const pagos = getData('pagos').filter(p => p.alumno_id == id).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            const libros = getData('libros').filter(l => l.alumno_id == id);
            
            document.getElementById('ficha-nombre').textContent = alumno.nombre;
            
            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <h4 class="font-bold text-gray-700 border-b pb-2">Datos Personales</h4>
                        <p><strong>Cédula:</strong> ${alumno.cedula}</p>
                        <p><strong>Teléfono:</strong> ${alumno.telefono || '-'} ${alumno.telefono2 ? '/ ' + alumno.telefono2 : ''}</p>
                        <p><strong>Email:</strong> ${alumno.email || '-'}</p>
                        <p><strong>Tutor:</strong> ${alumno.tutor || '-'}</p>
                        <p><strong>Dirección:</strong> ${alumno.direccion || '-'}</p>
                        <p><strong>Nivel:</strong> ${nivel?.nombre || '-'}</p>
                        <p><strong>Tipo Matrícula:</strong> ${tipoMat?.nombre || '-'}</p>
                    </div>
                    
                    <div class="space-y-3">
                        <h4 class="font-bold text-gray-700 border-b pb-2">Estado Financiero</h4>
                        <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                            <p class="text-red-800 font-bold">Deuda Matrícula: ${formatMoney(getDeudaMatricula(alumno))}</p>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <p class="text-yellow-800 font-bold">Deuda Libros: ${formatMoney(getDeudaLibros(id))}</p>
                        </div>
                        ${alumno.es_hermano ? '<p class="text-blue-600 text-sm"><i class="fas fa-info-circle mr-1"></i>Alumno es hermano (cuota personalizada)</p>' : ''}
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="font-bold text-gray-700 border-b pb-2 mb-3">Libros Asignados</h4>
                    ${libros.length === 0 ? '<p class="text-gray-500">Sin libros asignados</p>' : 
                        '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">' + 
                        libros.map(l => `
                            <div class="p-3 border rounded-lg ${l.saldo > 0 ? 'bg-yellow-50 border-yellow-300' : 'bg-green-50 border-green-300'}">
                                <div class="font-medium">${l.titulo}</div>
                                <div class="text-sm text-gray-600">Total: ${formatMoney(l.costo_total)} | Pagado: ${formatMoney(l.pagado)}</div>
                                ${l.saldo > 0 ? `<div class="text-red-600 font-bold text-sm">Saldo: ${formatMoney(l.saldo)}</div>` : '<div class="text-green-600 text-sm">Pagado completo</div>'}
                            </div>
                        `).join('') + '</div>'}
                </div>
                
                <div class="mt-6">
                    <h4 class="font-bold text-gray-700 border-b pb-2 mb-3">Historial de Pagos</h4>
                    <div class="max-h-64 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left">Fecha</th>
                                    <th class="px-3 py-2 text-left">Concepto</th>
                                    <th class="px-3 py-2 text-right">Monto</th>
                                    <th class="px-3 py-2 text-left">Comentarios</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pagos.map(p => `
                                    <tr class="border-b">
                                        <td class="px-3 py-2">${p.fecha}</td>
                                        <td class="px-3 py-2 capitalize">${p.concepto}${p.mes ? ' (' + p.mes + ')' : ''}</td>
                                        <td class="px-3 py-2 text-right font-medium">${formatMoney(p.monto)}</td>
                                        <td class="px-3 py-2 text-gray-500 text-xs">${p.comentarios || '-'}</td>
                                    </tr>
                                `).join('') || '<tr><td colspan="4" class="text-center py-4 text-gray-500">Sin pagos registrados</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('ficha-contenido').innerHTML = html;
            document.getElementById('modal-ficha').classList.add('active');
        }

        function generarMensajeWhatsApp() {
            const nombre = document.getElementById('ficha-nombre').textContent;
            const alumno = getData('alumnos').find(a => a.nombre === nombre);
            const deudaMat = getDeudaMatricula(alumno);
            const deudaLibros = getDeudaLibros(alumno.id);
            const total = deudaMat + deudaLibros;
            
            const mensaje = `Hola! Le escribo de ALEI - Instituto de Inglés. Le recordamos que ${nombre} tiene pendiente ${formatMoney(total)} correspondiente a: ${deudaMat > 0 ? 'Matrícula ' + formatMoney(deudaMat) : ''} ${deudaLibros > 0 ? 'Libros ' + formatMoney(deudaLibros) : ''}. Quedamos a su disposición. Gracias!`;
            
            navigator.clipboard.writeText(mensaje).then(() => {
                showToast('Mensaje copiado al portapapeles');
            });
        }

        // === LIBROS ===
        function cargarLibros() {
            const alumnos = getData('alumnos').filter(a => a.activo !== false);
            document.getElementById('libro-alumno').innerHTML = '<option value="">Seleccione...</option>' + 
                alumnos.map(a => `<option value="${a.id}">${a.nombre}</option>`).join('');
            
            const libros = getData('libros').filter(l => l.saldo > 0);
            let html = '';
            libros.forEach(l => {
                const alumno = alumnos.find(a => a.id == l.alumno_id);
                const porcentaje = (l.pagado / l.costo_total) * 100;
                
                html += `<tr>
                    <td class="px-4 py-2">${alumno?.nombre || 'N/A'}</td>
                    <td class="px-4 py-2">${l.titulo}</td>
                    <td class="px-4 py-2">${formatMoney(l.costo_total)}</td>
                    <td class="px-4 py-2 text-green-600">${formatMoney(l.pagado)}</td>
                    <td class="px-4 py-2 text-red-600 font-bold">${formatMoney(l.saldo)}</td>
                    <td class="px-4 py-2">
                        <button onclick="abrirAbonoLibro(${l.id})" class="btn-primary text-xs py-1">Abonar</button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('tabla-libros-pendientes').innerHTML = html || '<tr><td colspan="6" class="text-center py-4">No hay libros pendientes</td></tr>';
        }

        function calcularSaldoLibro() {
            const total = parseFloat(document.getElementById('libro-costo').value) || 0;
            const abono = parseFloat(document.getElementById('libro-abono').value) || 0;
            document.getElementById('libro-saldo-preview').textContent = formatMoney(total - abono);
        }

        function guardarLibro(e) {
            e.preventDefault();
            
            const alumnoId = document.getElementById('libro-alumno').value;
            const alumno = getData('alumnos').find(a => a.id == alumnoId);
            const costo = parseFloat(document.getElementById('libro-costo').value);
            const abono = parseFloat(document.getElementById('libro-abono').value);
            
            const libro = {
                id: generateId(),
                alumno_id: alumnoId,
                alumno_nombre: alumno.nombre,
                titulo: document.getElementById('libro-titulo').value,
                costo_total: costo,
                pagado: abono,
                saldo: costo - abono,
                pagos: [{
                    fecha: getToday(),
                    monto: abono,
                    comentarios: 'Abono inicial'
                }],
                fecha_asignacion: getToday()
            };
            
            const libros = getData('libros');
            libros.push(libro);
            setData('libros', libros);
            
            // Registrar pago también en tabla pagos
            const pagos = getData('pagos');
            pagos.push({
                id: generateId(),
                alumno_id: alumnoId,
                concepto: 'libro',
                monto: abono,
                fecha: getToday(),
                comentarios: `Abono libro: ${libro.titulo}`,
                timestamp: new Date().toISOString()
            });
            setData('pagos', pagos);
            
            showToast('Libro asignado correctamente');
            document.getElementById('form-libro').reset();
            cargarLibros();
        }

        function abrirAbonoLibro(libroId) {
            const libro = getData('libros').find(l => l.id == libroId);
            document.getElementById('abono-libro-id').value = libroId;
            document.getElementById('abono-libro-info').innerHTML = `
                <p class="font-bold">${libro.titulo}</p>
                <p class="text-sm">Saldo actual: <span class="text-red-600 font-bold">${formatMoney(libro.saldo)}</span></p>
            `;
            document.getElementById('abono-monto').value = libro.saldo;
            document.getElementById('modal-abono-libro').classList.add('active');
        }

        function registrarAbonoLibro(e) {
            e.preventDefault();
            
            const libros = getData('libros');
            const libroId = document.getElementById('abono-libro-id').value;
            const libro = libros.find(l => l.id == libroId);
            const monto = parseFloat(document.getElementById('abono-monto').value);
            
            libro.pagado += monto;
            libro.saldo -= monto;
            libro.pagos.push({
                fecha: getToday(),
                monto: monto,
                comentarios: document.getElementById('abono-comentarios').value
            });
            
            setData('libros', libros);
            
            const pagos = getData('pagos');
            pagos.push({
                id: generateId(),
                alumno_id: libro.alumno_id,
                concepto: 'libro',
                monto: monto,
                fecha: getToday(),
                comentarios: `Abono libro: ${libro.titulo}. ${document.getElementById('abono-comentarios').value}`,
                timestamp: new Date().toISOString()
            });
            setData('pagos', pagos);
            
            cerrarModal('modal-abono-libro');
            showToast('Abono registrado');
            cargarLibros();
        }

        // === PAGOS ===
        function cargarSelectAlumnos() {
            const alumnos = getData('alumnos').filter(a => a.activo !== false);
            document.getElementById('pago-filtro-alumno').innerHTML = '<option value="">Todos los alumnos</option>' + 
                alumnos.map(a => `<option value="${a.id}">${a.nombre}</option>`).join('');
        }

        function cargarPagos() {
            let pagos = getData('pagos').sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            const alumnos = getData('alumnos');
            
            const desde = document.getElementById('pago-filtro-desde').value;
            const hasta = document.getElementById('pago-filtro-hasta').value;
            const concepto = document.getElementById('pago-filtro-concepto').value;
            const alumnoId = document.getElementById('pago-filtro-alumno').value;
            
            if (desde) pagos = pagos.filter(p => p.fecha >= desde);
            if (hasta) pagos = pagos.filter(p => p.fecha <= hasta);
            if (concepto) pagos = pagos.filter(p => p.concepto === concepto);
            if (alumnoId) pagos = pagos.filter(p => p.alumno_id == alumnoId);
            
            let html = '';
            pagos.forEach(p => {
                const alumno = alumnos.find(a => a.id == p.alumno_id);
                html += `<tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.fecha}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${alumno?.nombre || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${p.concepto}${p.mes ? ' (' + p.mes + ')' : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${formatMoney(p.monto)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate">${p.comentarios || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarPago('${p.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</button>
                        <button onclick="eliminarPago('${p.id}')" class="text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('tabla-pagos').innerHTML = html || '<tr><td colspan="6" class="text-center py-4 text-gray-500">No hay pagos</td></tr>';
        }

        function eliminarPago(id) {
            if (!confirm('¿Eliminar este pago?')) return;
            const pagos = getData('pagos').filter(p => p.id != id);
            setData('pagos', pagos);
            cargarPagos();
            showToast('Pago eliminado');
        }

        // === GASTOS ===
        function toggleCuotasGasto() {
            const esCuota = document.getElementById('gasto-es-cuota').checked;
            document.getElementById('gasto-cuotas-container').classList.toggle('hidden', !esCuota);
        }

        function cargarGastos() {
            const gastos = getData('gastos').sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            let html = '';
            gastos.forEach(g => {
                html += `<tr>
                    <td class="px-4 py-2">${g.fecha}</td>
                    <td class="px-4 py-2">${g.concepto}</td>
                    <td class="px-4 py-2"><span class="px-2 py-1 bg-gray-100 rounded text-xs">${g.categoria}</span></td>
                    <td class="px-4 py-2 text-red-600 font-medium">${formatMoney(g.monto)}</td>
                    <td class="px-4 py-2">
                        ${g.es_cuota ? `<span class="text-xs text-blue-600">Cuota ${g.cuota_numero}/${g.total_cuotas}</span>` : ''}
                        <button onclick="eliminarGasto(${g.id})" class="text-red-600 hover:text-red-900 ml-2"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('tabla-gastos').innerHTML = html || '<tr><td colspan="5" class="text-center py-4">No hay gastos</td></tr>';
        }

        function guardarGasto(e) {
            e.preventDefault();
            
            const esCuota = document.getElementById('gasto-es-cuota').checked;
            const monto = parseFloat(document.getElementById('gasto-monto').value);
            const numCuotas = parseInt(document.getElementById('gasto-numero-cuotas').value) || 1;
            
            const gastos = getData('gastos');
            const fechaBase = new Date(document.getElementById('gasto-fecha').value);
            
            for (let i = 0; i < (esCuota ? numCuotas : 1); i++) {
                const fechaCuota = new Date(fechaBase);
                fechaCuota.setMonth(fechaCuota.getMonth() + i);
                
                gastos.push({
                    id: generateId(),
                    concepto: document.getElementById('gasto-concepto').value + (esCuota ? ` (cuota ${i+1}/${numCuotas})` : ''),
                    monto: esCuota ? (monto / numCuotas) : monto,
                    fecha: fechaCuota.toISOString().split('T')[0],
                    categoria: document.getElementById('gasto-categoria').value,
                    es_cuota: esCuota,
                    cuota_numero: esCuota ? i + 1 : null,
                    total_cuotas: esCuota ? numCuotas : null
                });
            }
            
            setData('gastos', gastos);
            document.getElementById('form-gasto').reset();
            cargarGastos();
            showToast('Gasto registrado');
        }

        function eliminarGasto(id) {
            if (!confirm('¿Eliminar este gasto?')) return;
            const gastos = getData('gastos').filter(g => g.id != id);
            setData('gastos', gastos);
            cargarGastos();
        }

        // === CONFIG ===
        function exportarSeccion(seccion) {
            const data = getData(seccion);
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alei_${seccion}_${anioSeleccionado}_${getToday()}.json`;
            a.click();
            showToast(`${seccion} exportados`);
        }

        function exportarTodo() {
            const todo = {
                anio: anioSeleccionado,
                fecha_exportacion: new Date().toISOString(),
                niveles: getData('niveles'),
                alumnos: getData('alumnos'),
                libros: getData('libros'),
                pagos: getData('pagos'),
                gastos: getData('gastos'),
                tiposMatricula: getData('tiposMatricula'),
                espera: getData('espera')
            };
            
            const blob = new Blob([JSON.stringify(todo, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alei_backup_completo_${anioSeleccionado}_${getToday()}.json`;
            a.click();
            showToast('Backup completo descargado');
        }

        function importarArchivo(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('import-texto').value = e.target.result;
            };
            reader.readAsText(file);
        }

        function importarTexto() {
            try {
                const texto = document.getElementById('import-texto').value;
                const tipo = document.getElementById('import-tipo').value;
                const data = JSON.parse(texto);
                
                if (tipo === 'todo') {
                    if (data.niveles) setData('niveles', data.niveles);
                    if (data.alumnos) setData('alumnos', data.alumnos);
                    if (data.libros) setData('libros', data.libros);
                    if (data.pagos) setData('pagos', data.pagos);
                    if (data.gastos) setData('gastos', data.gastos);
                    if (data.tiposMatricula) setData('tiposMatricula', data.tiposMatricula);
                    showToast('Datos importados correctamente');
                } else if (tipo === 'merge') {
                    // Fusionar con existentes
                    if (data.niveles) {
                        const existentes = getData('niveles');
                        setData('niveles', [...existentes, ...data.niveles.filter(n => !existentes.find(e => e.id === n.id))]);
                    }
                    if (data.alumnos) {
                        const existentes = getData('alumnos');
                        setData('alumnos', [...existentes, ...data.alumnos.filter(a => !existentes.find(e => e.id === a.id))]);
                    }
                    showToast('Datos fusionados');
                } else {
                    setData(tipo, data);
                    showToast(`${tipo} importados`);
                }
                
                cargarDashboard();
            } catch (err) {
                showToast('Error al importar: ' + err.message, 'error');
            }
        }

        function resetearSistemaPaso1() {
            document.getElementById('reset-confirmacion').classList.remove('hidden');
        }

        function cancelarReset() {
            document.getElementById('reset-confirmacion').classList.add('hidden');
            document.getElementById('reset-texto').value = '';
        }

        function resetearSistemaPaso2() {
            const texto = document.getElementById('reset-texto').value;
            if (texto !== 'ELIMINAR TODO') {
                showToast('Texto de confirmación incorrecto', 'error');
                return;
            }
            
            ['niveles', 'alumnos', 'libros', 'pagos', 'gastos', 'espera', 'auditoria'].forEach(key => {
                setData(key, []);
            });
            
            showToast('Sistema reseteado completamente');
            cancelarReset();
            cargarDashboard();
        }

        // === BÚSQUEDA GLOBAL ===
        function busquedaGlobal(texto) {
            const div = document.getElementById('global-search-results');
            if (texto.length < 2) {
                div.classList.add('hidden');
                return;
            }
            
            const term = texto.toLowerCase();
            const alumnos = getData('alumnos').filter(a => a.activo !== false && (a.nombre.toLowerCase().includes(term) || a.cedula.includes(term)));
            const libros = getData('libros').filter(l => l.titulo.toLowerCase().includes(term));
            
            let html = '';
            
            if (alumnos.length > 0) {
                html += '<h4 class="font-bold text-gray-700 mb-2">Alumnos</h4>';
                alumnos.forEach(a => {
                    html += `<div class="p-2 hover:bg-gray-100 cursor-pointer rounded" onclick="verFichaAlumno(${a.id}); document.getElementById('global-search-results').classList.add('hidden');">
                        <div class="font-medium">${a.nombre}</div>
                        <div class="text-xs text-gray-500">${a.cedula}</div>
                    </div>`;
                });
            }
            
            if (libros.length > 0) {
                html += '<h4 class="font-bold text-gray-700 mb-2 mt-3">Libros</h4>';
                libros.forEach(l => {
                    html += `<div class="p-2 hover:bg-gray-100 rounded">
                        <div class="font-medium">${l.titulo}</div>
                        <div class="text-xs text-gray-500">Saldo: ${formatMoney(l.saldo)}</div>
                    </div>`;
                });
            }
            
            div.innerHTML = html || '<p class="text-gray-500">Sin resultados</p>';
            div.classList.remove('hidden');
        }

        // === UTILIDADES MODALES ===
        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // === INICIALIZACIÓN ===
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('year-selector').value = anioSeleccionado;
            initStorage();
            cargarDashboard();
            
            // Cerrar modales al hacer click fuera
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('active');
                });
            });
        });
    </script>
</body>
</html>
