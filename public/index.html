<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALEI - Sistema de Gestión Integral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ukblue: '#00247D',
                        ukred: '#CF142B',
                        ukgold: '#FFD700'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-uk { background: linear-gradient(135deg, #00247D 0%, #1a3a8a 100%); }
        .gradient-red { background: linear-gradient(135deg, #CF142B 0%, #a00f21 100%); }
        .tab-active { border-bottom: 3px solid #CF142B; color: #00247D; background: #f0f4ff; }
        .card-hover { transition: all 0.3s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal { display: none; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal.active { display: flex; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .status-badge { @apply px-2 py-1 rounded-full text-xs font-bold; }
        .status-paid { @apply bg-green-100 text-green-800; }
        .status-pending { @apply bg-yellow-100 text-yellow-800; }
        .status-overdue { @apply bg-red-100 text-red-800; }
        .status-partial { @apply bg-blue-100 text-blue-800; }
        .alert-critica { @apply bg-red-50 border-l-4 border-red-500 p-4 mb-4; }
        .input-field { @apply w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-ukblue focus:outline-none transition-colors; }
        .btn-primary { @apply bg-ukblue text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition-colors font-medium; }
        .btn-danger { @apply bg-ukred text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-medium; }
        .btn-success { @apply bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium; }
        .btn-warning { @apply bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors font-medium; }
        .progress-bar { @apply w-full bg-gray-200 rounded-full h-2; }
        .progress-fill { @apply bg-ukblue h-2 rounded-full transition-all duration-500; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Navbar -->
    <nav class="gradient-uk text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center space-x-4">
                    <svg class="w-10 h-6" viewBox="0 0 60 30" xmlns="http://www.w3.org/2000/svg">
                        <rect width="60" height="30" fill="#012169"/>
                        <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
                        <path d="M0,0 L60,30 M60,0 L0,30" stroke="#C8102E" stroke-width="4"/>
                        <path d="M30,0 V30 M0,15 H60" stroke="#fff" stroke-width="10"/>
                        <path d="M30,0 V30 M0,15 H60" stroke="#C8102E" stroke-width="6"/>
                    </svg>
                    <div>
                        <h1 class="text-xl font-bold">ALEI - Sistema Integral</h1>
                        <p class="text-xs opacity-80" id="user-info">Usuario: Administrador</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Selector Año Lectivo -->
                    <select id="select-anio" class="bg-white text-gray-800 px-3 py-1 rounded-lg font-medium border-0 focus:ring-2 focus:ring-white" onchange="cambiarAnio()">
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                        <option value="2027">2027</option>
                    </select>

                    <!-- Búsqueda Global -->
                    <div class="relative hidden md:block">
                        <input type="text" id="busqueda-global" placeholder="Buscar alumno, libro..." 
                               class="pl-10 pr-4 py-2 rounded-lg text-gray-800 w-64 focus:outline-none focus:ring-2 focus:ring-white"
                               onkeyup="busquedaGlobal(event)">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>

                    <!-- Botón Caja Rápida -->
                    <button onclick="abrirCajaRapida()" class="bg-ukgold text-ukblue px-4 py-2 rounded-lg font-bold hover:bg-yellow-300 transition-colors">
                        <i class="fas fa-cash-register mr-2"></i>Caja Rápida
                    </button>

                    <!-- Alertas -->
                    <button onclick="mostrarAlertas()" class="relative p-2 hover:bg-blue-800 rounded-lg transition-colors">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="contador-alertas" class="absolute -top-1 -right-1 bg-ukred text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Tabs -->
    <div class="bg-white shadow-sm border-b overflow-x-auto">
        <div class="max-w-7xl mx-auto px-4 flex space-x-1">
            <button onclick="switchTab('dashboard')" class="tab-active px-6 py-4 font-medium text-sm hover:bg-gray-50 transition-colors whitespace-nowrap" data-tab="dashboard">
                <i class="fas fa-chart-line mr-2"></i>Dashboard
            </button>
            <button onclick="switchTab('alumnos')" class="px-6 py-4 font-medium text-sm text-gray-600 hover:bg-gray-50 transition-colors whitespace-nowrap" data-tab="alumnos">
                <i class="fas fa-users mr-2"></i>Alumnos
            </button>
            <button onclick="switchTab('pagos')" class="px-6 py-4 font-medium text-sm text-gray-600 hover:bg-gray-50 transition-colors whitespace-nowrap" data-tab="pagos">
                <i class="fas fa-money-bill-wave mr-2"></i>Pagos
            </button>
            <button onclick="switchTab('libros')" class="px-6 py-4 font-medium text-sm text-gray-600 hover:bg-gray-50 transition-colors whitespace-nowrap" data-tab="libros">
                <i class="fas fa-book mr-2"></i>Libros
            </button>
            <button onclick="switchTab('gastos')" class="px-6 py-4 font-medium text-sm text-gray-600 hover:bg-gray-50 transition-colors whitespace-nowrap" data-tab="gastos">
                <i class="fas fa-receipt mr-2"></i>Gastos
            </button>
            <button onclick="switchTab('preinscripciones')" class="px-6 py-4 font-medium text-sm text-gray-600 hover:bg-gray-50 transition-colors whitespace-nowrap" data-tab="preinscripciones">
                <i class="fas fa-clipboard-list mr-2"></i>Lista Espera
            </button>
            <button onclick="switchTab('data')" class="px-6 py-4 font-medium text-sm text-gray-600 hover:bg-gray-50 transition-colors whitespace-nowrap" data-tab="data">
                <i class="fas fa-database mr-2"></i>Datos
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

        <!-- DASHBOARD -->
        <div id="tab-dashboard" class="tab-content space-y-6">
            <!-- Alertas Importantes -->
            <div id="alertas-container" class="space-y-2"></div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="card-hover bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Alumnos Activos</p>
                            <h3 class="text-3xl font-bold text-ukblue mt-2" id="stat-alumnos">0</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg text-ukblue">
                            <i class="fas fa-users text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="card-hover bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Ingresos Este Mes</p>
                            <h3 class="text-3xl font-bold text-green-600 mt-2" id="stat-ingresos">$0</h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg text-green-600">
                            <i class="fas fa-arrow-up text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="card-hover bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Gastos Este Mes</p>
                            <h3 class="text-3xl font-bold text-ukred mt-2" id="stat-gastos">$0</h3>
                        </div>
                        <div class="bg-red-100 p-3 rounded-lg text-red-600">
                            <i class="fas fa-arrow-down text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="card-hover bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Deuda Total</p>
                            <h3 class="text-3xl font-bold text-orange-600 mt-2" id="stat-deuda">$0</h3>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-lg text-orange-600">
                            <i class="fas fa-exclamation-triangle text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mensualidades del Mes -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-lg text-gray-800">Control de Mensualidades - <span id="mes-actual-nombre"></span></h3>
                    <div class="flex space-x-2">
                        <select id="filtro-mes-mensualidad" class="input-field text-sm py-1 w-40" onchange="renderMensualidadesDashboard()">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 font-medium">
                            <tr>
                                <th class="px-6 py-3">Alumno</th>
                                <th class="px-6 py-3">Nivel</th>
                                <th class="px-6 py-3">Estado</th>
                                <th class="px-6 py-3">Monto</th>
                                <th class="px-6 py-3">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-mensualidades-mes"></tbody>
                    </table>
                </div>
            </div>

            <!-- Deudores y Libros -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                    <div class="px-6 py-4 border-b border-gray-100">
                        <h3 class="font-bold text-lg text-gray-800">Top Deudores</h3>
                    </div>
                    <div id="lista-deudores-rapida" class="p-6 space-y-3 max-h-96 overflow-y-auto">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                    <div class="px-6 py-4 border-b border-gray-100">
                        <h3 class="font-bold text-lg text-gray-800">Libros Pendientes de Pago</h3>
                    </div>
                    <div id="lista-libros-pendientes" class="p-6 space-y-3 max-h-96 overflow-y-auto">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ALUMNOS -->
        <div id="tab-alumnos" class="tab-content hidden space-y-6">
            <!-- Formulario -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-ukblue" id="titulo-form-alumno">Registrar Nuevo Alumno</h3>
                    <button onclick="limpiarFormularioAlumno()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>

                <form id="form-alumno" onsubmit="guardarAlumno(event)" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <input type="hidden" id="alumno-id">
                    
                    <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">N° Anual</label>
                            <input type="number" id="alumno-numero" class="input-field" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label>
                            <input type="text" id="alumno-nombre" class="input-field" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cédula *</label>
                            <input type="text" id="alumno-cedula" class="input-field" required onblur="validarCedulaDuplicada()">
                            <p id="error-cedula" class="text-red-500 text-xs hidden">Esta cédula ya está registrada</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono Principal</label>
                        <input type="text" id="alumno-telefono" class="input-field">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono Alternativo</label>
                        <input type="text" id="alumno-telefono-alt" class="input-field">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="alumno-email" class="input-field">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Edad</label>
                        <input type="number" id="alumno-edad" class="input-field">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                        <input type="text" id="alumno-direccion" class="input-field">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Nacimiento</label>
                        <input type="date" id="alumno-fecha-nac" class="input-field" onchange="calcularEdad()">
                    </div>

                    <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Padre/Tutor</label>
                            <input type="text" id="alumno-padre" class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Madre</label>
                            <input type="text" id="alumno-madre" class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contacto Emergencia</label>
                            <input type="text" id="alumno-emergencia" class="input-field">
                        </div>
                    </div>

                    <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-4 gap-4 border-t pt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nivel *</label>
                            <select id="alumno-nivel" class="input-field" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Matrícula *</label>
                            <select id="alumno-tipo-matricula" class="input-field" required onchange="togglePrecioEspecial()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">¿Es Hermano? (Excepción recargos)</label>
                            <select id="alumno-es-hermano" class="input-field">
                                <option value="false">No</option>
                                <option value="true">Sí (No aplica desc/recargo)</option>
                            </select>
                        </div>
                        <div id="campo-precio-especial" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Precio Mensual Especial $</label>
                            <input type="number" id="alumno-precio-especial" class="input-field" placeholder="Solo para hermanos">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inscripción</label>
                        <input type="date" id="alumno-fecha-insc" class="input-field" required>
                    </div>

                    <div class="lg:col-span-3 flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="generarFichaAlumno()" id="btn-ficha" class="hidden btn-warning">
                            <i class="fas fa-id-card mr-2"></i>Ver Ficha Completa
                        </button>
                        <button type="submit" class="btn-primary px-8">
                            <i class="fas fa-save mr-2"></i>Guardar Alumno
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                <div class="p-6 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                    <h3 class="text-lg font-bold text-gray-800">Lista de Alumnos</h3>
                    <div class="flex space-x-2 w-full md:w-auto">
                        <input type="text" id="buscar-alumno" placeholder="Buscar por nombre, cédula..." 
                               class="input-field w-full md:w-64" onkeyup="filtrarAlumnos()">
                        <button onclick="exportarSeccion('alumnos')" class="btn-success">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 font-medium">
                            <tr>
                                <th class="px-6 py-3">N°</th>
                                <th class="px-6 py-3">Nombre</th>
                                <th class="px-6 py-3">Nivel</th>
                                <th class="px-6 py-3">Contacto</th>
                                <th class="px-6 py-3">Tipo Matr.</th>
                                <th class="px-6 py-3">Estado</th>
                                <th class="px-6 py-3 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-alumnos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PAGOS -->
        <div id="tab-pagos" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Formulario de Pago -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-xl font-bold text-ukblue mb-6">Registrar Pago</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buscar Alumno</label>
                        <div class="relative">
                            <input type="text" id="pago-buscar-alumno" class="input-field pl-10" placeholder="Nombre, cédula o número..." onkeyup="buscarAlumnoPago()">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <div id="pago-resultados-busqueda" class="mt-2 space-y-1 max-h-40 overflow-y-auto"></div>
                    </div>

                    <form id="form-pago" onsubmit="guardarPago(event)" class="hidden space-y-4 border-t pt-4">
                        <input type="hidden" id="pago-alumno-id">
                        <input type="hidden" id="pago-id-editable">
                        
                        <div class="bg-blue-50 p-4 rounded-lg mb-4">
                            <div class="font-bold text-ukblue text-lg" id="pago-nombre-alumno"></div>
                            <div class="text-sm text-gray-600" id="pago-info-alumno-detalle"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Concepto *</label>
                                <select id="pago-concepto" class="input-field" required onchange="cambiarConceptoPago()">
                                    <option value="">Seleccione...</option>
                                    <option value="matricula">Matrícula</option>
                                    <option value="mensualidad">Mensualidad</option>
                                    <option value="libro">Libro/Material</option>
                                    <option value="examen">Examen</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>

                            <div id="campo-mes-pago" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mes a Pagar *</label>
                                <select id="pago-mes" class="input-field" onchange="calcularMontoAutomatico()">
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>

                            <div id="campo-libro-pago" class="hidden md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Libro Pendiente</label>
                                <select id="pago-libro-select" class="input-field" onchange="seleccionarLibroPago()">
                                    <option value="">Seleccione libro...</option>
                                </select>
                                <div id="info-libro-pago" class="mt-2 p-3 bg-yellow-50 rounded-lg text-sm hidden">
                                    <div class="flex justify-between"><span>Total:</span><span id="libro-pago-total" class="font-bold"></span></div>
                                    <div class="flex justify-between"><span>Abonado:</span><span id="libro-pago-abonado" class="font-bold text-green-600"></span></div>
                                    <div class="flex justify-between"><span>Saldo:</span><span id="libro-pago-saldo" class="font-bold text-red-600"></span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Cálculo Automático -->
                        <div id="calculo-automatico" class="hidden bg-gray-50 p-4 rounded-lg border-2 border-gray-200">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-500">Precio Base:</span>
                                    <div id="calc-base" class="font-bold">$0</div>
                                </div>
                                <div>
                                    <span class="text-gray-500">Descuento:</span>
                                    <div id="calc-descuento" class="font-bold text-green-600">-$0</div>
                                </div>
                                <div>
                                    <span class="text-gray-500">Recargo:</span>
                                    <div id="calc-recargo" class="font-bold text-red-600">+$0</div>
                                </div>
                                <div>
                                    <span class="text-gray-500">Sugerido:</span>
                                    <div id="calc-total" class="font-bold text-ukblue text-lg">$0</div>
                                </div>
                            </div>
                            <p id="calc-motivo" class="text-xs text-gray-500 mt-2 italic"></p>
                            <div class="mt-3 flex items-center space-x-2">
                                <input type="checkbox" id="ignorar-recargo" class="rounded" onchange="calcularMontoAutomatico()">
                                <label for="ignorar-recargo" class="text-sm text-gray-600">Aplicar excepción (no calcular recargos/descuentos)</label>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Monto a Pagar $ *</label>
                                <input type="number" id="pago-monto" class="input-field text-lg font-bold" required step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Pago *</label>
                                <input type="date" id="pago-fecha" class="input-field" required onchange="calcularMontoAutomatico()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Método de Pago</label>
                                <select id="pago-metodo" class="input-field">
                                    <option value="efectivo">Efectivo</option>
                                    <option value="transferencia">Transferencia</option>
                                    <option value="tarjeta">Tarjeta</option>
                                    <option value="debito_automatico">Débito Automático</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Comentarios / Observaciones</label>
                            <textarea id="pago-comentarios" class="input-field" rows="2" placeholder="Ej: Me entregó $500, falta el resto para la próxima semana. Pagó $50 de más, se descontará del próximo mes..."></textarea>
                        </div>

                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="limpiarFormularioPago()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                Cancelar
                            </button>
                            <button type="button" onclick="generarMensajeWhatsApp()" class="btn-success" id="btn-whatsapp" type="button">
                                <i class="fab fa-whatsapp mr-2"></i>Mensaje
                            </button>
                            <button type="submit" class="btn-primary px-8">
                                <i class="fas fa-check mr-2"></i>Registrar Pago
                            </button>
                        </div>

                        <!-- Auditoría -->
                        <div id="info-auditoria" class="hidden text-xs text-gray-400 border-t pt-2 mt-2">
                            Creado por: <span id="audit-creacion"></span> | 
                            Modificado por: <span id="audit-modificacion"></span>
                        </div>
                    </form>
                </div>

                <!-- Historial Rápido -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Últimos Pagos</h3>
                    <div id="lista-pagos-rapidos" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Lista completa de pagos -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">Historial Completo de Pagos</h3>
                    <div class="flex space-x-2">
                        <input type="text" id="buscar-pago" placeholder="Buscar..." class="input-field text-sm w-48" onkeyup="filtrarPagos()">
                        <button onclick="exportarSeccion('pagos')" class="btn-success text-sm">
                            <i class="fas fa-download mr-1"></i> Exportar
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 font-medium">
                            <tr>
                                <th class="px-6 py-3">Fecha</th>
                                <th class="px-6 py-3">Alumno</th>
                                <th class="px-6 py-3">Concepto</th>
                                <th class="px-6 py-3">Monto</th>
                                <th class="px-6 py-3">Comentarios</th>
                                <th class="px-6 py-3 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-pagos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- LIBROS -->
        <div id="tab-libros" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-xl font-bold text-ukblue mb-4">Asignar Libro/Material</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buscar Alumno</label>
                        <input type="text" id="libro-buscar-alumno" class="input-field" placeholder="Nombre o cédula..." onkeyup="buscarAlumnoLibro()">
                        <div id="libro-resultados" class="mt-2 space-y-1 max-h-32 overflow-y-auto"></div>
                    </div>

                    <form id="form-libro" onsubmit="guardarLibro(event)" class="hidden space-y-4 border-t pt-4">
                        <input type="hidden" id="libro-alumno-id">
                        
                        <div class="bg-blue-50 p-3 rounded-lg font-medium" id="libro-nombre-alumno"></div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Título del Libro/Material *</label>
                            <input type="text" id="libro-titulo" class="input-field" required placeholder="Ej: Wider World 2 Student's Book">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Costo Total $ *</label>
                                <input type="number" id="libro-costo" class="input-field" required step="0.01" onchange="calcularSaldoLibro()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Abono Inicial $</label>
                                <input type="number" id="libro-abono" class="input-field" value="0" step="0.01" onchange="calcularSaldoLibro()">
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                            <div class="flex justify-between font-bold">
                                <span>Saldo a Financiar:</span>
                                <span id="libro-saldo" class="text-ukred">$0</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
                            <textarea id="libro-observaciones" class="input-field" rows="2"></textarea>
                        </div>

                        <button type="submit" class="btn-primary w-full">
                            <i class="fas fa-book mr-2"></i>Asignar Libro y Registrar Abono
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Resumen de Libros</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-ukblue" id="resumen-total-libros">0</div>
                            <div class="text-sm text-gray-600">Libros Activos</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-ukred" id="resumen-deuda-libros">$0</div>
                            <div class="text-sm text-gray-600">Deuda Total</div>
                        </div>
                    </div>
                    <div id="lista-resumen-libros" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Tabla de libros -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">Todos los Libros</h3>
                    <button onclick="exportarSeccion('libros')" class="btn-success text-sm">
                        <i class="fas fa-download mr-1"></i> Exportar
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 font-medium">
                            <tr>
                                <th class="px-6 py-3">Alumno</th>
                                <th class="px-6 py-3">Libro</th>
                                <th class="px-6 py-3">Total</th>
                                <th class="px-6 py-3">Abonado</th>
                                <th class="px-6 py-3">Saldo</th>
                                <th class="px-6 py-3">Progreso</th>
                                <th class="px-6 py-3 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-libros"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- GASTOS -->
        <div id="tab-gastos" class="tab-content hidden space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-xl font-bold text-ukblue mb-4">Registrar Gasto</h3>
                <form id="form-gasto" onsubmit="guardarGasto(event)" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="hidden" id="gasto-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="gasto-fecha" class="input-field" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Concepto</label>
                        <input type="text" id="gasto-concepto" class="input-field" required placeholder="Ej: Alquiler, Sueldos, Compra de libros...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Monto $</label>
                        <input type="number" id="gasto-monto" class="input-field" required step="0.01">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                        <select id="gasto-categoria" class="input-field">
                            <option value="fijo">Gasto Fijo (Alquiler, Sueldos)</option>
                            <option value="variable">Gasto Variable (Materiales, Servicios)</option>
                            <option value="inversion">Inversión (Equipamiento)</option>
                            <option value="cuota">Compra en Cuotas</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div id="campo-cuotas" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">N° Cuotas</label>
                        <input type="number" id="gasto-cuotas-total" class="input-field" value="1" min="1">
                    </div>
                    <div class="md:col-span-4 flex justify-end space-x-3">
                        <button type="button" onclick="limpiarFormularioGasto()" class="text-gray-600 hover:text-gray-800">Cancelar</button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save mr-2"></i>Guardar Gasto
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">Historial de Gastos</h3>
                    <button onclick="exportarSeccion('gastos')" class="btn-success text-sm">
                        <i class="fas fa-download mr-1"></i> Exportar
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 font-medium">
                            <tr>
                                <th class="px-6 py-3">Fecha</th>
                                <th class="px-6 py-3">Concepto</th>
                                <th class="px-6 py-3">Categoría</th>
                                <th class="px-6 py-3">Monto</th>
                                <th class="px-6 py-3 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-gastos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PREINSCRIPCIONES -->
        <div id="tab-preinscripciones" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-xl font-bold text-ukblue mb-4">Nueva Pre-inscripción</h3>
                    <form id="form-preinscripcion" onsubmit="guardarPreinscripcion(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Interesado *</label>
                            <input type="text" id="pre-nombre" class="input-field" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contacto (Tel/Email) *</label>
                            <input type="text" id="pre-contacto" class="input-field" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nivel de Interés</label>
                            <select id="pre-nivel" class="input-field">
                                <option value="">No especificado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
                            <textarea id="pre-observaciones" class="input-field" rows="2" placeholder="Horario preferido, edad, etc."></textarea>
                        </div>
                        <button type="submit" class="btn-primary w-full">
                            <i class="fas fa-clipboard-list mr-2"></i>Agregar a Lista de Espera
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Estadísticas</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                            <span class="font-medium">Total Pre-inscritos</span>
                            <span id="stat-preinscripciones" class="text-2xl font-bold text-ukblue">0</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg">
                            <span class="font-medium">Convertidos a Alumnos</span>
                            <span id="stat-convertidos" class="text-2xl font-bold text-green-600">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                <div class="p-6 border-b border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800">Lista de Espera</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 font-medium">
                            <tr>
                                <th class="px-6 py-3">Fecha</th>
                                <th class="px-6 py-3">Nombre</th>
                                <th class="px-6 py-3">Contacto</th>
                                <th class="px-6 py-3">Nivel Interés</th>
                                <th class="px-6 py-3">Estado</th>
                                <th class="px-6 py-3 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-preinscripciones"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- DATA / BACKUP -->
        <div id="tab-data" class="tab-content hidden space-y-6">
            
            <!-- Importar/Exportar por secciones -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="font-bold text-lg mb-4 text-ukblue">Alumnos</h3>
                    <div class="space-y-2">
                        <button onclick="exportarSeccion('alumnos')" class="w-full btn-success text-sm py-2">
                            <i class="fas fa-download mr-2"></i>Exportar JSON
                        </button>
                        <div class="relative">
                            <input type="file" id="import-alumnos-file" class="hidden" onchange="importarArchivo('alumnos', this)" accept=".json">
                            <button onclick="document.getElementById('import-alumnos-file').click()" class="w-full btn-primary text-sm py-2">
                                <i class="fas fa-upload mr-2"></i>Subir Archivo
                            </button>
                        </div>
                        <textarea id="import-alumnos-text" class="input-field text-xs h-20 mt-2" placeholder="O pegar JSON aquí..."></textarea>
                        <button onclick="importarTexto('alumnos')" class="w-full bg-gray-600 text-white py-2 rounded text-sm hover:bg-gray-700">
                            Importar desde Texto
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="font-bold text-lg mb-4 text-ukblue">Pagos</h3>
                    <div class="space-y-2">
                        <button onclick="exportarSeccion('pagos')" class="w-full btn-success text-sm py-2">
                            <i class="fas fa-download mr-2"></i>Exportar JSON
                        </button>
                        <div class="relative">
                            <input type="file" id="import-pagos-file" class="hidden" onchange="importarArchivo('pagos', this)" accept=".json">
                            <button onclick="document.getElementById('import-pagos-file').click()" class="w-full btn-primary text-sm py-2">
                                <i class="fas fa-upload mr-2"></i>Subir Archivo
                            </button>
                        </div>
                        <textarea id="import-pagos-text" class="input-field text-xs h-20 mt-2" placeholder="O pegar JSON aquí..."></textarea>
                        <button onclick="importarTexto('pagos')" class="w-full bg-gray-600 text-white py-2 rounded text-sm hover:bg-gray-700">
                            Importar desde Texto
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="font-bold text-lg mb-4 text-ukblue">Libros</h3>
                    <div class="space-y-2">
                        <button onclick="exportarSeccion('libros')" class="w-full btn-success text-sm py-2">
                            <i class="fas fa-download mr-2"></i>Exportar JSON
                        </button>
                        <div class="relative">
                            <input type="file" id="import-libros-file" class="hidden" onchange="importarArchivo('libros', this)" accept=".json">
                            <button onclick="document.getElementById('import-libros-file').click()" class="w-full btn-primary text-sm py-2">
                                <i class="fas fa-upload mr-2"></i>Subir Archivo
                            </button>
                        </div>
                        <textarea id="import-libros-text" class="input-field text-xs h-20 mt-2" placeholder="O pegar JSON aquí..."></textarea>
                        <button onclick="importarTexto('libros')" class="w-full bg-gray-600 text-white py-2 rounded text-sm hover:bg-gray-700">
                            Importar desde Texto
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="font-bold text-lg mb-4 text-ukblue">Gastos</h3>
                    <div class="space-y-2">
                        <button onclick="exportarSeccion('gastos')" class="w-full btn-success text-sm py-2">
                            <i class="fas fa-download mr-2"></i>Exportar JSON
                        </button>
                        <div class="relative">
                            <input type="file" id="import-gastos-file" class="hidden" onchange="importarArchivo('gastos', this)" accept=".json">
                            <button onclick="document.getElementById('import-gastos-file').click()" class="w-full btn-primary text-sm py-2">
                                <i class="fas fa-upload mr-2"></i>Subir Archivo
                            </button>
                        </div>
                        <textarea id="import-gastos-text" class="input-field text-xs h-20 mt-2" placeholder="O pegar JSON aquí..."></textarea>
                        <button onclick="importarTexto('gastos')" class="w-full bg-gray-600 text-white py-2 rounded text-sm hover:bg-gray-700">
                            Importar desde Texto
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="font-bold text-lg mb-4 text-ukblue">Niveles y Config</h3>
                    <div class="space-y-2">
                        <button onclick="exportarSeccion('niveles')" class="w-full btn-success text-sm py-2">
                            <i class="fas fa-download mr-2"></i>Exportar JSON
                        </button>
                        <div class="relative">
                            <input type="file" id="import-niveles-file" class="hidden" onchange="importarArchivo('niveles', this)" accept=".json">
                            <button onclick="document.getElementById('import-niveles-file').click()" class="w-full btn-primary text-sm py-2">
                                <i class="fas fa-upload mr-2"></i>Subir Archivo
                            </button>
                        </div>
                        <textarea id="import-niveles-text" class="input-field text-xs h-20 mt-2" placeholder="O pegar JSON aquí..."></textarea>
                        <button onclick="importarTexto('niveles')" class="w-full bg-gray-600 text-white py-2 rounded text-sm hover:bg-gray-700">
                            Importar desde Texto
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 border-2 border-ukblue">
                    <h3 class="font-bold text-lg mb-4 text-ukblue">Backup Completo</h3>
                    <p class="text-sm text-gray-600 mb-4">Todo el sistema junto</p>
                    <button onclick="exportarBackupCompleto()" class="w-full btn-success mb-2">
                        <i class="fas fa-download mr-2"></i>Descargar Todo
                    </button>
                    <div class="relative">
                        <input type="file" id="import-full-file" class="hidden" onchange="importarBackupCompleto(this)" accept=".json">
                        <button onclick="document.getElementById('import-full-file').click()" class="w-full btn-primary">
                            <i class="fas fa-upload mr-2"></i>Restaurar Todo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Reset Sistema -->
            <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6">
                <h3 class="font-bold text-lg text-red-800 mb-2">⚠️ Zona Peligrosa</h3>
                <p class="text-sm text-red-600 mb-4">Borrar todos los datos para nuevo año lectivo. Esta acción no se puede deshacer.</p>
                <button onclick="resetearSistemaPaso1()" class="btn-danger" id="btn-reset-1">
                    Iniciar Reset del Sistema
                </button>
                <div id="confirmacion-reset" class="hidden mt-4 space-y-3">
                    <p class="text-red-800 font-bold">¿Está seguro? Se borrarán todos los alumnos, pagos y datos del año <span id="anio-reset"></span></p>
                    <input type="text" id="input-confirm-reset" class="input-field border-red-300" placeholder="Escriba BORRAR para confirmar">
                    <div class="flex space-x-3">
                        <button onclick="cancelarReset()" class="px-4 py-2 text-gray-600">Cancelar</button>
                        <button onclick="resetearSistemaConfirmado()" class="btn-danger">Confirmar Borrado Total</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Caja Rápida (POS) -->
    <div id="modal-caja-rapida" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 slide-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-ukblue">Caja Rápida (POS)</h3>
                <button onclick="cerrarModal('modal-caja-rapida')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form onsubmit="procesarCajaRapida(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Alumno *</label>
                    <select id="caja-alumno" class="input-field" required>
                        <option value="">Seleccione...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Concepto *</label>
                    <select id="caja-concepto" class="input-field" required onchange="cajaCalcularMonto()">
                        <option value="">Seleccione...</option>
                        <option value="mensualidad">Mensualidad</option>
                        <option value="matricula">Matrícula</option>
                        <option value="libro">Libro</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>

                <div id="caja-campo-mes" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mes</label>
                    <select id="caja-mes" class="input-field" onchange="cajaCalcularMonto()">
                        <!-- Se llena dinámicamente -->
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Monto $ *</label>
                    <input type="number" id="caja-monto" class="input-field text-2xl font-bold text-center" required step="0.01">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Comentarios</label>
                    <input type="text" id="caja-comentarios" class="input-field" placeholder="Opcional...">
                </div>

                <button type="submit" class="w-full btn-primary py-3 text-lg font-bold">
                    <i class="fas fa-check-circle mr-2"></i>REGISTRAR PAGO
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Ficha Alumno -->
    <div id="modal-ficha" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto slide-in">
            <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                <h3 class="text-xl font-bold text-ukblue">Ficha del Alumno</h3>
                <button onclick="cerrarModal('modal-ficha')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="contenido-ficha" class="p-6 space-y-6">
                <!-- Se llena dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Modal Alertas -->
    <div id="modal-alertas" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto slide-in">
            <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center bg-ukblue text-white rounded-t-xl">
                <h3 class="text-xl font-bold"><i class="fas fa-bell mr-2"></i>Centro de Alertas</h3>
                <button onclick="cerrarModal('modal-alertas')" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="lista-alertas" class="p-6 space-y-3">
                <!-- Se llena dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center">
        <i id="toast-icon" class="fas fa-check-circle mr-2 text-green-400"></i>
        <span id="toast-message">Mensaje</span>
    </div>

    <script>
        // === CONFIGURACIÓN GLOBAL ===
        const APP_VERSION = '3.0';
        let ANIO_LECTIVO = localStorage.getItem('alei_anio_lectivo') || new Date().getFullYear();
        
        // Inicializar año
        document.getElementById('select-anio').value = ANIO_LECTIVO;
        document.getElementById('mes-actual-nombre').textContent = obtenerNombreMes(new Date().getMonth() + 1);
        document.getElementById('filtro-mes-mensualidad').value = new Date().getMonth() + 1;

        // === UTILIDADES ===
        function $(id) { return document.getElementById(id); }
        
        function showToast(msg, type = 'success') {
            const toast = $('toast');
            const icon = $('toast-icon');
            $('toast-message').textContent = msg;
            
            if(type === 'error') {
                icon.className = 'fas fa-exclamation-circle mr-2 text-red-400';
            } else {
                icon.className = 'fas fa-check-circle mr-2 text-green-400';
            }
            
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function formatMoney(amount) {
            return '$' + (parseFloat(amount) || 0).toLocaleString('es-UY', {minimumFractionDigits: 0, maximumFractionDigits: 2});
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getStorageKey(tipo) {
            return `alei_${tipo}_${ANIO_LECTIVO}`;
        }

        function getData(tipo) {
            const key = getStorageKey(tipo);
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function setData(tipo, data) {
            localStorage.setItem(getStorageKey(tipo), JSON.stringify(data));
        }

        function obtenerNombreMes(num) {
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Setiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return meses[num - 1];
        }

        function fechaEsValida(fechaStr) {
            if(!fechaStr) return false;
            const partes = fechaStr.split('/');
            if(partes.length === 3) {
                // Formato DD/MM/YYYY
                const d = parseInt(partes[0]);
                const m = parseInt(partes[1]);
                const a = parseInt(partes[2]);
                return new Date(a, m-1, d).getDate() === d;
            }
            // Formato ISO
            return !isNaN(new Date(fechaStr).getTime());
        }

        function parseFecha(fechaStr) {
            if(!fechaStr) return new Date();
            if(fechaStr.includes('/')) {
                const [d, m, a] = fechaStr.split('/');
                return new Date(a, m-1, d);
            }
            return new Date(fechaStr);
        }

        function formatFechaInput(date) {
            return date.toISOString().split('T')[0];
        }

        // === NAVEGACIÓN ===
        function switchTab(tabName) {
            // Ocultar todos
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[data-tab]').forEach(el => {
                el.classList.remove('tab-active', 'text-ukblue');
                el.classList.add('text-gray-600');
            });
            
            // Mostrar activo
            $(`tab-${tabName}`).classList.remove('hidden');
            const btn = document.querySelector(`[data-tab="${tabName}"]`);
            if(btn) {
                btn.classList.add('tab-active', 'text-ukblue');
                btn.classList.remove('text-gray-600');
            }
            
            // Renderizar contenido específico
            if(tabName === 'dashboard') renderDashboard();
            if(tabName === 'alumnos') { cargarSelects(); renderAlumnos(); }
            if(tabName === 'pagos') { cargarSelects(); renderPagos(); }
            if(tabName === 'libros') renderLibros();
            if(tabName === 'gastos') renderGastos();
            if(tabName === 'preinscripciones') { cargarSelects(); renderPreinscripciones(); }
        }

        function cambiarAnio() {
            ANIO_LECTIVO = $('select-anio').value;
            localStorage.setItem('alei_anio_lectivo', ANIO_LECTIVO);
            showToast(`Año lectivo cambiado a ${ANIO_LECTIVO}`);
            renderDashboard();
        }

        // === DASHBOARD Y ESTADÍSTICAS ===
        function renderDashboard() {
            const alumnos = getData('alumnos');
            const pagos = getData('pagos');
            const gastos = getData('gastos');
            const libros = getData('libros');
            
            // Stats básicas
            $('stat-alumnos').textContent = alumnos.length;
            
            // Ingresos mes actual
            const mesActual = new Date().getMonth() + 1;
            const ingresosMes = pagos
                .filter(p => parseFecha(p.fecha).getMonth() + 1 === mesActual)
                .reduce((sum, p) => sum + parseFloat(p.monto || 0), 0);
            $('stat-ingresos').textContent = formatMoney(ingresosMes);
            
            // Gastos mes
            const gastosMes = gastos
                .filter(g => parseFecha(g.fecha).getMonth() + 1 === mesActual)
                .reduce((sum, g) => sum + parseFloat(g.monto || 0), 0);
            $('stat-gastos').textContent = formatMoney(gastosMes);
            
            // Deuda total
            let deudaTotal = 0;
            alumnos.forEach(a => {
                deudaTotal += calcularDeudaMatricula(a);
            });
            libros.forEach(l => {
                deudaTotal += parseFloat(l.saldo || 0);
            });
            $('stat-deuda').textContent = formatMoney(deudaTotal);
            
            renderMensualidadesDashboard();
            renderDeudoresRapido();
            renderLibrosPendientes();
            generarAlertas();
        }

        function calcularDeudaMatricula(alumno) {
            if(!alumno) return 0;
            const tipoMat = getData('tiposMatricula').find(t => t.id == alumno.tipo_matricula_id) || {costo: 1500};
            const pagosMat = getData('pagos').filter(p => 
                p.alumno_id == alumno.id && 
                (p.concepto === 'matricula' || p.concepto === 'matricula')
            );
            const pagado = pagosMat.reduce((sum, p) => sum + parseFloat(p.monto || 0), 0);
            const debe = parseFloat(tipoMat.costo || 1500);
            return Math.max(0, debe - pagado);
        }

        function renderMensualidadesDashboard() {
            const mes = parseInt($('filtro-mes-mensualidad').value);
            const alumnos = getData('alumnos');
            const pagos = getData('pagos');
            const niveles = getData('niveles');
            
            let html = '';
            alumnos.forEach(a => {
                const pagoMes = pagos.find(p => 
                    p.alumno_id == a.id && 
                    p.concepto === 'mensualidad' && 
                    p.mes == mes
                );
                
                const nivel = niveles.find(n => n.id == a.nivel_id) || {};
                let estado, clase, accion;
                
                if(pagoMes) {
                    estado = 'Pagado';
                    clase = 'status-paid';
                    accion = `<button onclick="verComprobante('${pagoMes.id}')" class="text-blue-600 hover:underline text-xs">Ver</button>`;
                } else {
                    const calculo = calcularMontoMensualidadLogica(a, mes, new Date());
                    estado = 'Pendiente';
                    clase = 'status-pending';
                    accion = `<button onclick="irAPagos('${a.id}', ${mes})" class="btn-primary text-xs py-1 px-2">Registrar</button>`;
                }
                
                html += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-3 font-medium">${a.nombre}</td>
                    <td class="px-6 py-3 text-gray-600">${nivel.nombre || '-'}</td>
                    <td class="px-6 py-3"><span class="${clase} status-badge">${estado}</span></td>
                    <td class="px-6 py-3">${formatMoney(nivel.precio || 0)}</td>
                    <td class="px-6 py-3">${accion}</td>
                </tr>`;
            });
            
            $('tabla-mensualidades-mes').innerHTML = html;
        }

        function calcularMontoMensualidadLogica(alumno, mesPago, fechaPago) {
            // Si es hermano con precio especial
            if(alumno.es_hermano === true || alumno.es_hermano === 'true') {
                const precioEspecial = parseFloat(alumno.precio_especial || 0);
                if(precioEspecial > 0) {
                    return {
                        base: precioEspecial,
                        descuento: 0,
                        recargo: 0,
                        total: precioEspecial,
                        motivo: 'Precio especial hermano (sin recargos)'
                    };
                }
            }
            
            const nivel = getData('niveles').find(n => n.id == alumno.nivel_id);
            const base = parseFloat(nivel?.precio || 1500);
            
            const anio = parseInt(ANIO_LECTIVO);
            const fechaPagoReal = new Date(fechaPago);
            const mesPagoInt = parseInt(mesPago);
            
            // Crear fecha del mes que se está pagando
            const inicioMesPagado = new Date(anio, mesPagoInt - 1, 1);
            const finMesPagado = new Date(anio, mesPagoInt, 0);
            
            let descuento = 0;
            let recargo = 0;
            let motivo = '';
            
            // Si paga antes del inicio del mes (anticipado)
            if(fechaPagoReal < inicioMesPagado) {
                descuento = 150;
                motivo = 'Pronto pago (mes anterior)';
            }
            // Si paga dentro del mes
            else if(fechaPagoReal.getMonth() + 1 === mesPagoInt) {
                const dia = fechaPagoReal.getDate();
                if(dia >= 1 && dia <= 10) {
                    descuento = 150;
                    motivo = 'Pronto pago (días 1-10)';
                } else if(dia >= 11 && dia <= 15) {
                    descuento = 0;
                    motivo = 'Pago oportuno (días 11-15)';
                } else {
                    recargo = 150;
                    motivo = 'Recargo por pago tardío (después del 15)';
                }
            }
            // Si paga después del mes (atrasado)
            else if(fechaPagoReal > finMesPagado) {
                recargo = 150;
                motivo = 'Recargo por pago atrasado';
            }
            
            return {
                base,
                descuento,
                recargo,
                total: base - descuento + recargo,
                motivo
            };
        }

        function renderDeudoresRapido() {
            const alumnos = getData('alumnos');
            const libros = getData('libros');
            
            // Calcular deuda total por alumno
            const deudores = alumnos.map(a => {
                const deudaMat = calcularDeudaMatricula(a);
                const deudaLibros = libros
                    .filter(l => l.alumno_id == a.id)
                    .reduce((sum, l) => sum + parseFloat(l.saldo || 0), 0);
                return {...a, totalDeuda: deudaMat + deudaLibros};
            }).filter(a => a.totalDeuda > 0)
              .sort((a, b) => b.totalDeuda - a.totalDeuda)
              .slice(0, 10);
            
            let html = '';
            deudores.forEach(a => {
                html += `<div class="flex justify-between items-center p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                    <div>
                        <div class="font-medium text-gray-800">${a.nombre}</div>
                        <div class="text-xs text-gray-500">Deuda Total</div>
                    </div>
                    <div class="font-bold text-red-600">${formatMoney(a.totalDeuda)}</div>
                </div>`;
            });
            
            $('lista-deudores-rapida').innerHTML = html || '<p class="text-gray-500 text-center py-4">No hay deudores</p>';
        }

        function renderLibrosPendientes() {
            const libros = getData('libros').filter(l => parseFloat(l.saldo) > 0);
            const alumnos = getData('alumnos');
            
            let html = '';
            libros.forEach(l => {
                const alumno = alumnos.find(a => a.id == l.alumno_id);
                const porcentaje = (parseFloat(l.abonado || 0) / parseFloat(l.costo_total || 1)) * 100;
                
                html += `<div class="p-3 bg-blue-50 rounded-lg">
                    <div class="flex justify-between mb-1">
                        <span class="font-medium text-sm">${alumno?.nombre || 'N/A'}</span>
                        <span class="text-sm font-bold text-ukblue">${formatMoney(l.saldo)}</span>
                    </div>
                    <div class="text-xs text-gray-600 mb-2">${l.titulo}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${porcentaje}%"></div>
                    </div>
                    <div class="text-xs text-right mt-1 text-gray-500">${Math.round(porcentaje)}% pagado</div>
                </div>`;
            });
            
            $('lista-libros-pendientes').innerHTML = html || '<p class="text-gray-500 text-center py-4">No hay libros pendientes</p>';
        }

        // === ALUMNOS ===
        function cargarSelects() {
            // Niveles
            const niveles = getData('niveles');
            const optsNiveles = niveles.map(n => `<option value="${n.id}">${n.nombre}</option>`).join('');
            
            ['alumno-nivel', 'pre-nivel'].forEach(id => {
                const el = $(id);
                if(el) el.innerHTML = '<option value="">Seleccione...</option>' + optsNiveles;
            });
            
            // Tipos matrícula
            const tipos = getData('tiposMatricula');
            const optsTipos = tipos.map(t => `<option value="${t.id}">${t.nombre} ($${t.costo})</option>`).join('');
            const elTipo = $('alumno-tipo-matricula');
            if(elTipo) elTipo.innerHTML = '<option value="">Seleccione...</option>' + optsTipos;
            
            // Alumnos para caja rápida
            const alumnos = getData('alumnos');
            const optsAlumnos = alumnos.map(a => `<option value="${a.id}">${a.numero_anual || ''} - ${a.nombre}</option>`).join('');
            const elCaja = $('caja-alumno');
            if(elCaja) elCaja.innerHTML = '<option value="">Seleccione...</option>' + optsAlumnos;
        }

        function togglePrecioEspecial() {
            const esHermano = $('alumno-es-hermano').value === 'true';
            const campo = $('campo-precio-especial');
            if(esHermano) {
                campo.classList.remove('hidden');
            } else {
                campo.classList.add('hidden');
                $('alumno-precio-especial').value = '';
            }
        }

        function validarCedulaDuplicada() {
            const cedula = $('alumno-cedula').value;
            const idActual = $('alumno-id').value;
            const alumnos = getData('alumnos');
            
            const existe = alumnos.find(a => a.cedula === cedula && a.id !== idActual);
            if(existe) {
                $('error-cedula').classList.remove('hidden');
                $('alumno-cedula').classList.add('border-red-500');
            } else {
                $('error-cedula').classList.add('hidden');
                $('alumno-cedula').classList.remove('border-red-500');
            }
        }

        function guardarAlumno(e) {
            e.preventDefault();
            
            if(!$('error-cedula').classList.contains('hidden')) {
                showToast('Corrija la cédula duplicada', 'error');
                return;
            }
            
            const alumnos = getData('alumnos');
            const id = $('alumno-id').value;
            
            const alumnoData = {
                id: id || generateId(),
                numero_anual: parseInt($('alumno-numero').value),
                nombre: $('alumno-nombre').value,
                cedula: $('alumno-cedula').value,
                telefono: $('alumno-telefono').value,
                telefono_alternativo: $('alumno-telefono-alt').value,
                email: $('alumno-email').value,
                edad: parseInt($('alumno-edad').value) || 0,
                direccion: $('alumno-direccion').value,
                fecha_nacimiento: $('alumno-fecha-nac').value,
                nombre_padre: $('alumno-padre').value,
                nombre_madre: $('alumno-madre').value,
                contacto_emergencia: $('alumno-emergencia').value,
                nivel_id: $('alumno-nivel').value,
                tipo_matricula_id: $('alumno-tipo-matricula').value,
                es_hermano: $('alumno-es-hermano').value === 'true',
                precio_especial: parseFloat($('alumno-precio-especial').value) || 0,
                fecha_inscripcion: $('alumno-fecha-insc').value,
                activo: true,
                anio_lectivo: ANIO_LECTIVO
            };
            
            if(id) {
                const idx = alumnos.findIndex(a => a.id === id);
                alumnos[idx] = {...alumnos[idx], ...alumnoData, modificado: new Date().toISOString()};
                showToast('Alumno actualizado');
            } else {
                alumnoData.creado = new Date().toISOString();
                alumnos.push(alumnoData);
                showToast('Alumno registrado');
            }
            
            setData('alumnos', alumnos);
            limpiarFormularioAlumno();
            renderAlumnos();
        }

        function renderAlumnos() {
            const alumnos = getData('alumnos');
            const niveles = getData('niveles');
            const tiposMat = getData('tiposMatricula');
            
            let html = '';
            alumnos.forEach(a => {
                const nivel = niveles.find(n => n.id == a.nivel_id);
                const tipo = tiposMat.find(t => t.id == a.tipo_matricula_id);
                const deudaMat = calcularDeudaMatricula(a);
                const estado = deudaMat > 0 ? 
                    '<span class="status-pending status-badge">Debe Matrícula</span>' : 
                    '<span class="status-paid status-badge">Al Día</span>';
                
                html += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-3 font-medium">${a.numero_anual || '-'}</td>
                    <td class="px-6 py-3">${a.nombre}</td>
                    <td class="px-6 py-3 text-gray-600">${nivel?.nombre || '-'}</td>
                    <td class="px-6 py-3 text-sm">
                        <div>${a.telefono || '-'}</div>
                        <div class="text-gray-400 text-xs">${a.email || ''}</div>
                    </td>
                    <td class="px-6 py-3">
                        <span class="bg-gray-100 px-2 py-1 rounded text-xs">${tipo?.nombre || 'Regular'}</span>
                        ${a.es_hermano ? '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs ml-1">Hno</span>' : ''}
                    </td>
                    <td class="px-6 py-3">${estado}</td>
                    <td class="px-6 py-3 text-right space-x-2">
                        <button onclick="editarAlumno('${a.id}')" class="text-blue-600 hover:text-blue-800" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="verFichaAlumno('${a.id}')" class="text-green-600 hover:text-green-800" title="Ver Ficha">
                            <i class="fas fa-id-card"></i>
                        </button>
                        <button onclick="generarMensajeWhatsAppAlumno('${a.id}')" class="text-green-500 hover:text-green-700" title="WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            $('tabla-alumnos').innerHTML = html || '<tr><td colspan="7" class="text-center py-8 text-gray-500">No hay alumnos registrados</td></tr>';
        }

        function filtrarAlumnos() {
            const term = $('buscar-alumno').value.toLowerCase();
            const rows = $('tabla-alumnos').querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }

        function editarAlumno(id) {
            const alumnos = getData('alumnos');
            const a = alumnos.find(x => x.id === id);
            if(!a) return;
            
            $('alumno-id').value = a.id;
            $('alumno-numero').value = a.numero_anual;
            $('alumno-nombre').value = a.nombre;
            $('alumno-cedula').value = a.cedula;
            $('alumno-telefono').value = a.telefono || '';
            $('alumno-telefono-alt').value = a.telefono_alternativo || '';
            $('alumno-email').value = a.email || '';
            $('alumno-edad').value = a.edad || '';
            $('alumno-direccion').value = a.direccion || '';
            $('alumno-fecha-nac').value = a.fecha_nacimiento || '';
            $('alumno-padre').value = a.nombre_padre || '';
            $('alumno-madre').value = a.nombre_madre || '';
            $('alumno-emergencia').value = a.contacto_emergencia || '';
            $('alumno-nivel').value = a.nivel_id;
            $('alumno-tipo-matricula').value = a.tipo_matricula_id;
            $('alumno-es-hermano').value = (a.es_hermano === true || a.es_hermano === 'true') ? 'true' : 'false';
            $('alumno-precio-especial').value = a.precio_especial || '';
            $('alumno-fecha-insc').value = a.fecha_inscripcion;
            
            togglePrecioEspecial();
            $('titulo-form-alumno').textContent = 'Editar Alumno';
            $('btn-ficha').classList.remove('hidden');
            
            window.scrollTo(0, 0);
        }

        function limpiarFormularioAlumno() {
            $('form-alumno').reset();
            $('alumno-id').value = '';
            $('alumno-fecha-insc').value = formatFechaInput(new Date());
            $('titulo-form-alumno').textContent = 'Registrar Nuevo Alumno';
            $('btn-ficha').classList.add('hidden');
            $('campo-precio-especial').classList.add('hidden');
        }

        // === PAGOS ===
        function buscarAlumnoPago() {
            const term = $('pago-buscar-alumno').value.toLowerCase();
            const alumnos = getData('alumnos');
            
            if(term.length < 2) {
                $('pago-resultados-busqueda').innerHTML = '';
                return;
            }
            
            const filtrados = alumnos.filter(a => 
                a.nombre.toLowerCase().includes(term) || 
                a.cedula.includes(term) ||
                (a.numero_anual && a.numero_anual.toString().includes(term))
            );
            
            $('pago-resultados-busqueda').innerHTML = filtrados.map(a => `
                <div class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 border border-gray-200 transition" 
                     onclick="seleccionarAlumnoPago('${a.id}')">
                    <div class="font-medium text-gray-800">${a.nombre}</div>
                    <div class="text-sm text-gray-500">CI: ${a.cedula} | N° ${a.numero_anual || '-'}</div>
                </div>
            `).join('');
        }

        function seleccionarAlumnoPago(alumnoId) {
            const alumno = getData('alumnos').find(a => a.id === alumnoId);
            if(!alumno) return;
            
            $('pago-alumno-id').value = alumnoId;
            $('pago-nombre-alumno').textContent = alumno.nombre;
            
            const tipo = getData('tiposMatricula').find(t => t.id == alumno.tipo_matricula_id);
            const esHermano = alumno.es_hermano === true || alumno.es_hermano === 'true';
            
            $('pago-info-alumno-detalle').innerHTML = `
                CI: ${alumno.cedula} | 
                Tipo: <span class="font-medium">${tipo?.nombre || 'Regular'}</span>
                ${esHermano ? '<span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">Hno - Sin recargos</span>' : ''}
            `;
            
            // Cargar libros pendientes
            const libros = getData('libros').filter(l => l.alumno_id == alumnoId && parseFloat(l.saldo) > 0);
            const optsLibros = libros.map(l => `<option value="${l.id}">${l.titulo} (Saldo: $${l.saldo})</option>`).join('');
            $('pago-libro-select').innerHTML = '<option value="">Seleccione libro...</option>' + optsLibros;
            
            $('form-pago').classList.remove('hidden');
            $('pago-resultados-busqueda').innerHTML = '';
            $('pago-buscar-alumno').value = '';
            
            // Fecha default hoy
            $('pago-fecha').value = formatFechaInput(new Date());
            
            // Reset
            $('pago-concepto').value = '';
            $('calculo-automatico').classList.add('hidden');
            $('campo-mes-pago').classList.add('hidden');
            $('campo-libro-pago').classList.add('hidden');
        }

        function cambiarConceptoPago() {
            const concepto = $('pago-concepto').value;
            $('campo-mes-pago').classList.toggle('hidden', concepto !== 'mensualidad');
            $('campo-libro-pago').classList.toggle('hidden', concepto !== 'libro');
            $('calculo-automatico').classList.add('hidden');
            
            if(concepto === 'mensualidad') {
                // Default mes actual
                $('pago-mes').value = new Date().getMonth() + 1;
                calcularMontoAutomatico();
            } else if(concepto === 'matricula') {
                const alumno = getData('alumnos').find(a => a.id === $('pago-alumno-id').value);
                const deuda = calcularDeudaMatricula(alumno);
                $('pago-monto').value = deuda;
            }
        }

        function calcularMontoAutomatico() {
            const concepto = $('pago-concepto').value;
            if(concepto !== 'mensualidad') return;
            
            const alumnoId = $('pago-alumno-id').value;
            const alumno = getData('alumnos').find(a => a.id === alumnoId);
            if(!alumno) return;
            
            const mes = parseInt($('pago-mes').value);
            const fechaPago = $('pago-fecha').value ? new Date($('pago-fecha').value) : new Date();
            
            const calculo = calcularMontoMensualidadLogica(alumno, mes, fechaPago);
            
            $('calc-base').textContent = formatMoney(calculo.base);
            $('calc-descuento').textContent = '-' + formatMoney(calculo.descuento);
            $('calc-recargo').textContent = '+' + formatMoney(calculo.recargo);
            $('calc-total').textContent = formatMoney(calculo.total);
            $('calc-motivo').textContent = calculo.motivo;
            
            $('calculo-automatico').classList.remove('hidden');
            
            // Sugerir monto
            if(!$('pago-monto').value || $('pago-monto').value == 0) {
                $('pago-monto').value = calculo.total;
            }
        }

        function seleccionarLibroPago() {
            const libroId = $('pago-libro-select').value;
            if(!libroId) {
                $('info-libro-pago').classList.add('hidden');
                return;
            }
            
            const libro = getData('libros').find(l => l.id === libroId);
            $('libro-pago-total').textContent = formatMoney(libro.costo_total);
            $('libro-pago-abonado').textContent = formatMoney(libro.abonado);
            $('libro-pago-saldo').textContent = formatMoney(libro.saldo);
            $('info-libro-pago').classList.remove('hidden');
            $('pago-monto').value = libro.saldo;
        }

        function guardarPago(e) {
            e.preventDefault();
            
            const pagos = getData('pagos');
            const id = $('pago-id-editable').value;
            
            const pagoData = {
                id: id || generateId(),
                alumno_id: $('pago-alumno-id').value,
                concepto: $('pago-concepto').value,
                monto: parseFloat($('pago-monto').value),
                fecha: $('pago-fecha').value,
                mes: $('pago-mes').value,
                metodo: $('pago-metodo').value,
                comentarios: $('pago-comentarios').value,
                libro_id: $('pago-libro-select').value || null,
                anio_lectivo: ANIO_LECTIVO
            };
            
            // Auditoría
            if(id) {
                const existente = pagos.find(p => p.id === id);
                pagoData.creado_por = existente.creado_por;
                pagoData.creado_en = existente.creado_en;
                pagoData.modificado_por = 'Admin';
                pagoData.modificado_en = new Date().toISOString();
            } else {
                pagoData.creado_por = 'Admin';
                pagoData.creado_en = new Date().toISOString();
            }
            
            if(id) {
                const idx = pagos.findIndex(p => p.id === id);
                pagos[idx] = pagoData;
                showToast('Pago actualizado');
            } else {
                pagos.push(pagoData);
                showToast('Pago registrado');
                
                // Si es abono de libro, actualizar libro
                if(pagoData.concepto === 'libro' && pagoData.libro_id) {
                    const libros = getData('libros');
                    const libro = libros.find(l => l.id === pagoData.libro_id);
                    if(libro) {
                        libro.abonado = parseFloat(libro.abonado || 0) + pagoData.monto;
                        libro.saldo = Math.max(0, parseFloat(libro.saldo || 0) - pagoData.monto);
                        if(!libro.pagos) libro.pagos = [];
                        libro.pagos.push({
                            fecha: pagoData.fecha,
                            monto: pagoData.monto,
                            comentarios: pagoData.comentarios
                        });
                        setData('libros', libros);
                    }
                }
            }
            
            setData('pagos', pagos);
            limpiarFormularioPago();
            renderPagos();
            renderDashboard();
        }

        function renderPagos() {
            const pagos = getData('pagos').sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            const alumnos = getData('alumnos');
            
            // Lista completa
            let html = '';
            pagos.forEach(p => {
                const alumno = alumnos.find(a => a.id === p.alumno_id);
                const concepto = p.concepto === 'mensualidad' ? 
                    `Mensualidad (${obtenerNombreMes(p.mes)})` : 
                    p.concepto.charAt(0).toUpperCase() + p.concepto.slice(1);
                
                html += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-3 whitespace-nowrap">${p.fecha}</td>
                    <td class="px-6 py-3">${alumno?.nombre || 'N/A'}</td>
                    <td class="px-6 py-3 capitalize">${concepto}</td>
                    <td class="px-6 py-3 font-bold text-green-600">${formatMoney(p.monto)}</td>
                    <td class="px-6 py-3 text-sm text-gray-600 max-w-xs truncate">${p.comentarios || '-'}</td>
                    <td class="px-6 py-3 text-right">
                        <button onclick="editarPago('${p.id}')" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="generarMensajeWhatsAppPago('${p.id}')" class="text-green-600 hover:text-green-800" title="WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            $('tabla-pagos').innerHTML = html || '<tr><td colspan="6" class="text-center py-8 text-gray-500">No hay pagos registrados</td></tr>';
            
            // Lista rápida (últimos 10)
            const recientes = pagos.slice(0, 10);
            $('lista-pagos-rapidos').innerHTML = recientes.map(p => {
                const alumno = alumnos.find(a => a.id === p.alumno_id);
                return `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div>
                        <div class="font-medium text-sm">${alumno?.nombre || 'N/A'}</div>
                        <div class="text-xs text-gray-500 capitalize">${p.concepto}</div>
                    </div>
                    <div class="font-bold text-green-600">${formatMoney(p.monto)}</div>
                </div>`;
            }).join('');
        }

        function limpiarFormularioPago() {
            $('form-pago').classList.add('hidden');
            $('form-pago').reset();
            $('pago-id-editable').value = '';
            $('calculo-automatico').classList.add('hidden');
            $('info-auditoria').classList.add('hidden');
        }

        // === LIBROS ===
        function buscarAlumnoLibro() {
            const term = $('libro-buscar-alumno').value.toLowerCase();
            const alumnos = getData('alumnos');
            
            if(term.length < 2) {
                $('libro-resultados').innerHTML = '';
                return;
            }
            
            const filtrados = alumnos.filter(a => a.nombre.toLowerCase().includes(term));
            $('libro-resultados').innerHTML = filtrados.map(a => `
                <div class="p-2 bg-gray-50 rounded cursor-pointer hover:bg-blue-50 text-sm" onclick="seleccionarAlumnoLibro('${a.id}')">
                    <div class="font-medium">${a.nombre}</div>
                </div>
            `).join('');
        }

        function seleccionarAlumnoLibro(alumnoId) {
            const alumno = getData('alumnos').find(a => a.id === alumnoId);
            $('libro-alumno-id').value = alumnoId;
            $('libro-nombre-alumno').textContent = alumno.nombre;
            $('form-libro').classList.remove('hidden');
            $('libro-resultados').innerHTML = '';
            $('libro-buscar-alumno').value = '';
        }

        function calcularSaldoLibro() {
            const total = parseFloat($('libro-costo').value) || 0;
            const abono = parseFloat($('libro-abono').value) || 0;
            $('libro-saldo').textContent = formatMoney(total - abono);
        }

        function guardarLibro(e) {
            e.preventDefault();
            const libros = getData('libros');
            
            const costoTotal = parseFloat($('libro-costo').value);
            const abonoInicial = parseFloat($('libro-abono').value) || 0;
            
            const libro = {
                id: generateId(),
                alumno_id: $('libro-alumno-id').value,
                titulo: $('libro-titulo').value,
                costo_total: costoTotal,
                abonado: abonoInicial,
                saldo: costoTotal - abonoInicial,
                observaciones: $('libro-observaciones').value,
                pagos: abonoInicial > 0 ? [{
                    fecha: formatFechaInput(new Date()),
                    monto: abonoInicial,
                    comentarios: 'Abono inicial'
                }] : [],
                anio_lectivo: ANIO_LECTIVO
            };
            
            libros.push(libro);
            setData('libros', libros);
            
            // Registrar como pago si hay abono
            if(abonoInicial > 0) {
                const pagos = getData('pagos');
                pagos.push({
                    id: generateId(),
                    alumno_id: libro.alumno_id,
                    concepto: 'libro',
                    monto: abonoInicial,
                    fecha: formatFechaInput(new Date()),
                    comentarios: `Abono inicial - ${libro.titulo}`,
                    libro_id: libro.id,
                    creado_por: 'Admin',
                    creado_en: new Date().toISOString()
                });
                setData('pagos', pagos);
            }
            
            showToast('Libro asignado correctamente');
            $('form-libro').reset();
            $('form-libro').classList.add('hidden');
            renderLibros();
            renderDashboard();
        }

        function renderLibros() {
            const libros = getData('libros');
            const alumnos = getData('alumnos');
            
            // Calcular resumen
            const totalLibros = libros.length;
            const deudaTotal = libros.reduce((sum, l) => sum + parseFloat(l.saldo || 0), 0);
            $('resumen-total-libros').textContent = totalLibros;
            $('resumen-deuda-libros').textContent = formatMoney(deudaTotal);
            
            // Lista resumen
            const pendientes = libros.filter(l => parseFloat(l.saldo) > 0);
            $('lista-resumen-libros').innerHTML = pendientes.slice(0, 5).map(l => {
                const alumno = alumnos.find(a => a.id == l.alumno_id);
                return `<div class="flex justify-between text-sm p-2 bg-gray-50 rounded">
                    <span class="truncate">${alumno?.nombre}: ${l.titulo}</span>
                    <span class="font-bold text-red-600">${formatMoney(l.saldo)}</span>
                </div>`;
            }).join('') || '<p class="text-gray-500 text-center py-4">No hay libros pendientes</p>';
            
            // Tabla completa
            let html = '';
            libros.forEach(l => {
                const alumno = alumnos.find(a => a.id == l.alumno_id);
                const porcentaje = (parseFloat(l.abonado || 0) / parseFloat(l.costo_total || 1)) * 100;
                const saldo = parseFloat(l.saldo || 0);
                
                html += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-3">${alumno?.nombre || 'N/A'}</td>
                    <td class="px-6 py-3">${l.titulo}</td>
                    <td class="px-6 py-3">${formatMoney(l.costo_total)}</td>
                    <td class="px-6 py-3 text-green-600">${formatMoney(l.abonado)}</td>
                    <td class="px-6 py-3 font-bold ${saldo > 0 ? 'text-red-600' : 'text-green-600'}">${formatMoney(saldo)}</td>
                    <td class="px-6 py-3">
                        <div class="w-24 bg-gray-200 rounded-full h-2">
                            <div class="bg-ukblue h-2 rounded-full" style="width: ${porcentaje}%"></div>
                        </div>
                    </td>
                    <td class="px-6 py-3 text-right">
                        ${saldo > 0 ? `<button onclick="abrirAbonoLibro('${l.id}')" class="btn-primary text-xs py-1 px-2">Abonar</button>` : '<span class="text-green-600 text-xs">Pagado</span>'}
                    </td>
                </tr>`;
            });
            
            $('tabla-libros').innerHTML = html || '<tr><td colspan="7" class="text-center py-8 text-gray-500">No hay libros registrados</td></tr>';
        }

        function abrirAbonoLibro(libroId) {
            const libro = getData('libros').find(l => l.id === libroId);
            // Reutilizar modal de pago seleccionando el libro
            const alumno = getData('alumnos').find(a => a.id === libro.alumno_id);
            
            seleccionarAlumnoPago(alumno.id);
            $('pago-concepto').value = 'libro';
            cambiarConceptoPago();
            $('pago-libro-select').value = libroId;
            seleccionarLibroPago();
        }

        // === GASTOS ===
        function guardarGasto(e) {
            e.preventDefault();
            const gastos = getData('gastos');
            const id = $('gasto-id').value;
            
            const gastoData = {
                id: id || generateId(),
                fecha: $('gasto-fecha').value,
                concepto: $('gasto-concepto').value,
                monto: parseFloat($('gasto-monto').value),
                categoria: $('gasto-categoria').value,
                cuotas: $('gasto-categoria').value === 'cuota' ? parseInt($('gasto-cuotas-total').value) : 1,
                anio_lectivo: ANIO_LECTIVO
            };
            
            if(id) {
                const idx = gastos.findIndex(g => g.id === id);
                gastos[idx] = gastoData;
            } else {
                gastos.push(gastoData);
            }
            
            setData('gastos', gastos);
            limpiarFormularioGasto();
            renderGastos();
            renderDashboard();
            showToast('Gasto registrado');
        }

        function renderGastos() {
            const gastos = getData('gastos').sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            let html = '';
            gastos.forEach(g => {
                const badgeColor = {
                    'fijo': 'bg-blue-100 text-blue-800',
                    'variable': 'bg-yellow-100 text-yellow-800',
                    'inversion': 'bg-purple-100 text-purple-800',
                    'cuota': 'bg-orange-100 text-orange-800'
                }[g.categoria] || 'bg-gray-100';
                
                html += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-3">${g.fecha}</td>
                    <td class="px-6 py-3">${g.concepto}</td>
                    <td class="px-6 py-3"><span class="px-2 py-1 rounded text-xs ${badgeColor}">${g.categoria}</span></td>
                    <td class="px-6 py-3 font-bold text-red-600">${formatMoney(g.monto)}</td>
                    <td class="px-6 py-3 text-right">
                        <button onclick="editarGasto('${g.id}')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            $('tabla-gastos').innerHTML = html || '<tr><td colspan="5" class="text-center py-8 text-gray-500">No hay gastos registrados</td></tr>';
        }

        // === PREINSCRIPCIONES ===
        function guardarPreinscripcion(e) {
            e.preventDefault();
            const preinscripciones = getData('preinscripciones');
            
            preinscripciones.push({
                id: generateId(),
                nombre: $('pre-nombre').value,
                contacto: $('pre-contacto').value,
                nivel_interes: $('pre-nivel').value,
                observaciones: $('pre-observaciones').value,
                fecha: formatFechaInput(new Date()),
                estado: 'pendiente',
                anio_lectivo: ANIO_LECTIVO
            });
            
            setData('preinscripciones', preinscripciones);
            $('form-preinscripcion').reset();
            renderPreinscripciones();
            showToast('Pre-inscripción guardada');
        }

        function renderPreinscripciones() {
            const preinscripciones = getData('preinscripciones');
            const niveles = getData('niveles');
            
            $('stat-preinscripciones').textContent = preinscripciones.filter(p => p.estado === 'pendiente').length;
            $('stat-convertidos').textContent = preinscripciones.filter(p => p.estado === 'convertido').length;
            
            let html = '';
            preinscripciones.forEach(p => {
                const nivel = niveles.find(n => n.id == p.nivel_interes);
                const estadoClass = p.estado === 'convertido' ? 'status-paid' : 'status-pending';
                
                html += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-3">${p.fecha}</td>
                    <td class="px-6 py-3 font-medium">${p.nombre}</td>
                    <td class="px-6 py-3">${p.contacto}</td>
                    <td class="px-6 py-3">${nivel?.nombre || '-'}</td>
                    <td class="px-6 py-3"><span class="${estadoClass} status-badge">${p.estado}</span></td>
                    <td class="px-6 py-3 text-right">
                        ${p.estado === 'pendiente' ? `
                            <button onclick="convertirPreinscripcion('${p.id}')" class="btn-success text-xs py-1 px-2 mr-2">Convertir</button>
                            <button onclick="eliminarPreinscripcion('${p.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        ` : '<span class="text-gray-400 text-xs">Completado</span>'}
                    </td>
                </tr>`;
            });
            
            $('tabla-preinscripciones').innerHTML = html || '<tr><td colspan="6" class="text-center py-8 text-gray-500">No hay pre-inscripciones</td></tr>';
        }

        function convertirPreinscripcion(id) {
            const preinscripciones = getData('preinscripciones');
            const pre = preinscripciones.find(p => p.id === id);
            
            // Llenar formulario de alumno con datos
            $('alumno-nombre').value = pre.nombre;
            $('alumno-telefono').value = pre.contacto;
            $('alumno-nivel').value = pre.nivel_interes;
            $('alumno-fecha-insc').value = formatFechaInput(new Date());
            
            // Marcar como convertido
            pre.estado = 'convertido';
            setData('preinscripciones', preinscripciones);
            
            // Ir a pestaña alumnos
            switchTab('alumnos');
            showToast('Datos transferidos al formulario de alumnos. Complete y guarde.');
        }

        // === CAJA RÁPIDA (POS) ===
        function abrirCajaRapida() {
            cargarSelects();
            $('modal-caja-rapida').classList.add('active');
            // Llenar meses
            const meses = Array.from({length: 12}, (_, i) => 
                `<option value="${i+1}" ${i+1 === new Date().getMonth()+1 ? 'selected' : ''}>${obtenerNombreMes(i+1)}</option>`
            ).join('');
            $('caja-mes').innerHTML = meses;
        }

        function cajaCalcularMonto() {
            const concepto = $('caja-concepto').value;
            $('caja-campo-mes').classList.toggle('hidden', concepto !== 'mensualidad');
            
            if(concepto === 'mensualidad') {
                const alumnoId = $('caja-alumno').value;
                const alumno = getData('alumnos').find(a => a.id === alumnoId);
                if(alumno) {
                    const mes = parseInt($('caja-mes').value);
                    const calculo = calcularMontoMensualidadLogica(alumno, mes, new Date());
                    $('caja-monto').value = calculo.total;
                }
            } else if(concepto === 'matricula') {
                const alumnoId = $('caja-alumno').value;
                const alumno = getData('alumnos').find(a => a.id === alumnoId);
                if(alumno) {
                    $('caja-monto').value = calcularDeudaMatricula(alumno);
                }
            }
        }

        function procesarCajaRapida(e) {
            e.preventDefault();
            
            const pago = {
                id: generateId(),
                alumno_id: $('caja-alumno').value,
                concepto: $('caja-concepto').value,
                monto: parseFloat($('caja-monto').value),
                fecha: formatFechaInput(new Date()),
                mes: $('caja-mes').value,
                metodo: 'efectivo',
                comentarios: $('caja-comentarios').value,
                creado_por: 'Admin',
                creado_en: new Date().toISOString(),
                anio_lectivo: ANIO_LECTIVO
            };
            
            const pagos = getData('pagos');
            pagos.push(pago);
            setData('pagos', pagos);
            
            cerrarModal('modal-caja-rapida');
            showToast('Pago registrado en Caja Rápida');
            renderDashboard();
            
            // Limpiar
            $('caja-alumno').value = '';
            $('caja-concepto').value = '';
            $('caja-monto').value = '';
            $('caja-comentarios').value = '';
        }

        // === WHATSAPP Y MENSAJES ===
        function generarMensajeWhatsApp() {
            const alumnoId = $('pago-alumno-id').value;
            const alumno = getData('alumnos').find(a => a.id === alumnoId);
            const monto = $('pago-monto').value;
            const concepto = $('pago-concepto').value;
            
            let mensaje = `Hola! Le recordamos que ${alumno.nombre} tiene registrado un pago de ${formatMoney(monto)} por concepto de ${concepto}. `;
            if($('pago-comentarios').value) {
                mensaje += `Obs: ${$('pago-comentarios').value}. `;
            }
            mensaje += `Gracias! ALEI Instituto.`;
            
            navigator.clipboard.writeText(mensaje).then(() => {
                showToast('Mensaje copiado al portapapeles');
            });
        }

        function generarMensajeWhatsAppAlumno(alumnoId) {
            const alumno = getData('alumnos').find(a => a.id === alumnoId);
            const deudaMat = calcularDeudaMatricula(alumno);
            const deudaLibros = getData('libros')
                .filter(l => l.alumno_id == alumnoId)
                .reduce((sum, l) => sum + parseFloat(l.saldo || 0), 0);
            
            const total = deudaMat + deudaLibros;
            
            let mensaje = `Hola! Le recordamos que ${alumno.nombre} tiene pendiente ${formatMoney(total)}. `;
            if(deudaMat > 0) mensaje += `Matrícula: ${formatMoney(deudaMat)}. `;
            if(deudaLibros > 0) mensaje += `Libros: ${formatMoney(deudaLibros)}. `;
            mensaje += `Por favor regularice su situación. Gracias! ALEI Instituto.`;
            
            navigator.clipboard.writeText(mensaje).then(() => {
                showToast('Mensaje de cobranza copiado');
            });
        }

        // === ALERTAS ===
        function generarAlertas() {
            const alumnos = getData('alumnos');
            const libros = getData('libros');
            const hoy = new Date();
            const alertas = [];
            
            // Cumpleaños
            alumnos.forEach(a => {
                if(a.fecha_nacimiento) {
                    const fechaNac = new Date(a.fecha_nacimiento);
                    if(fechaNac.getDate() === hoy.getDate() && fechaNac.getMonth() === hoy.getMonth()) {
                        alertas.push({
                            tipo: 'cumpleaños',
                            mensaje: `🎂 Hoy es el cumpleaños de ${a.nombre}!`,
                            color: 'bg-purple-100 text-purple-800'
                        });
                    }
                }
            });
            
            // Pagos atrasados (más de 30 días sin pagar mensualidad)
            // Simplificación: si no pagó el mes pasado
            const mesActual = hoy.getMonth() + 1;
            const pagos = getData('pagos');
            
            alumnos.forEach(a => {
                const pagoMesPasado = pagos.find(p => 
                    p.alumno_id == a.id && 
                    p.concepto === 'mensualidad' && 
                    p.mes == mesActual - 1
                );
                if(!pagoMesPasado && mesActual > 1) {
                    alertas.push({
                        tipo: 'atrasado',
                        mensaje: `⚠️ ${a.nombre} no pagó la mensualidad del mes pasado`,
                        color: 'bg-red-100 text-red-800'
                    });
                }
            });
            
            // Libros no retirados (asignados hace más de 7 días sin abonar)
            libros.forEach(l => {
                const fechaAsignacion = new Date(l.fechaAsignacion || l.fecha_asignacion);
                const diasDiff = Math.floor((hoy - fechaAsignacion) / (1000 * 60 * 60 * 24));
                if(diasDiff > 7 && parseFloat(l.abonado || 0) === 0) {
                    const alumno = alumnos.find(a => a.id == l.alumno_id);
                    alertas.push({
                        tipo: 'libro',
                        mensaje: `📚 Libro "${l.titulo}" de ${alumno?.nombre} no retirado (${diasDiff} días)`,
                        color: 'bg-yellow-100 text-yellow-800'
                    });
                }
            });
            
            // Mostrar contador
            const contador = $('contador-alertas');
            if(alertas.length > 0) {
                contador.textContent = alertas.length;
                contador.classList.remove('hidden');
            } else {
                contador.classList.add('hidden');
            }
            
            // Guardar para el modal
            window.alertasSistema = alertas;
            
            // Renderizar alertas en dashboard
            const container = $('alertas-container');
            if(alertas.length > 0) {
                container.innerHTML = alertas.slice(0, 3).map(a => `
                    <div class="${a.color} px-4 py-3 rounded-lg border-l-4 ${a.color.replace('bg-', 'border-').replace('100', '500')}">
                        ${a.mensaje}
                    </div>
                `).join('') + (alertas.length > 3 ? `<div class="text-right text-sm text-gray-500">+${alertas.length - 3} alertas más</div>` : '');
            } else {
                container.innerHTML = '';
            }
        }

        function mostrarAlertas() {
            const alertas = window.alertasSistema || [];
            const lista = $('lista-alertas');
            
            if(alertas.length === 0) {
                lista.innerHTML = '<div class="text-center py-8 text-gray-500">No hay alertas pendientes</div>';
            } else {
                lista.innerHTML = alertas.map(a => `
                    <div class="${a.color} p-4 rounded-lg border-l-4 ${a.color.replace('bg-', 'border-').replace('100', '500')}">
                        ${a.mensaje}
                    </div>
                `).join('');
            }
            
            $('modal-alertas').classList.add('active');
        }

        // === IMPORT / EXPORT ===
        function exportarSeccion(tipo) {
            const data = getData(tipo);
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alei_${tipo}_${ANIO_LECTIVO}_${formatFechaInput(new Date())}.json`;
            a.click();
            showToast(`${tipo} exportados correctamente`);
        }

        function exportarBackupCompleto() {
            const backup = {
                version: APP_VERSION,
                fecha: new Date().toISOString(),
                anio_lectivo: ANIO_LECTIVO,
                alumnos: getData('alumnos'),
                pagos: getData('pagos'),
                libros: getData('libros'),
                gastos: getData('gastos'),
                niveles: getData('niveles'),
                tiposMatricula: getData('tiposMatricula'),
                preinscripciones: getData('preinscripciones')
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alei_backup_completo_${ANIO_LECTIVO}_${formatFechaInput(new Date())}.json`;
            a.click();
            showToast('Backup completo descargado');
        }

        function importarArchivo(tipo, input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // Validación básica
                    if(Array.isArray(data)) {
                        setData(tipo, data);
                        showToast(`${tipo} importados correctamente (${data.length} registros)`);
                        if(tipo === 'alumnos') renderAlumnos();
                        if(tipo === 'pagos') renderPagos();
                        if(tipo === 'libros') renderLibros();
                        if(tipo === 'gastos') renderGastos();
                        if(tipo === 'niveles') cargarSelects();
                    } else {
                        throw new Error('Formato inválido');
                    }
                } catch(err) {
                    showToast('Error al importar: ' + err.message, 'error');
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        function importarTexto(tipo) {
            const textarea = $(`import-${tipo}-text`);
            const text = textarea.value.trim();
            if(!text) return;
            
            try {
                const data = JSON.parse(text);
                if(Array.isArray(data)) {
                    setData(tipo, data);
                    showToast(`${tipo} importados desde texto (${data.length} registros)`);
                    textarea.value = '';
                } else {
                    throw new Error('Debe ser un array JSON');
                }
            } catch(err) {
                showToast('Error: ' + err.message, 'error');
            }
        }

        function importarBackupCompleto(input) {
            const file = input.files[0];
            if(!file) return;
            
            if(!confirm('ADVERTENCIA: Esto reemplazará todos los datos actuales. ¿Continuar?')) {
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if(backup.alumnos) setData('alumnos', backup.alumnos);
                    if(backup.pagos) setData('pagos', backup.pagos);
                    if(backup.libros) setData('libros', backup.libros);
                    if(backup.gastos) setData('gastos', backup.gastos);
                    if(backup.niveles) setData('niveles', backup.niveles);
                    if(backup.tiposMatricula) setData('tiposMatricula', backup.tiposMatricula);
                    if(backup.preinscripciones) setData('preinscripciones', backup.preinscripciones);
                    
                    showToast('Backup completo restaurado correctamente');
                    renderDashboard();
                } catch(err) {
                    showToast('Error al restaurar: ' + err.message, 'error');
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        // === RESET SISTEMA ===
        function resetearSistemaPaso1() {
            $('anio-reset').textContent = ANIO_LECTIVO;
            $('confirmacion-reset').classList.remove('hidden');
            $('btn-reset-1').classList.add('hidden');
        }

        function cancelarReset() {
            $('confirmacion-reset').classList.add('hidden');
            $('btn-reset-1').classList.remove('hidden');
            $('input-confirm-reset').value = '';
        }

        function resetearSistemaConfirmado() {
            if($('input-confirm-reset').value !== 'BORRAR') {
                showToast('Debe escribir BORRAR para confirmar', 'error');
                return;
            }
            
            // Borrar todo del año actual
            ['alumnos', 'pagos', 'libros', 'gastos', 'preinscripciones'].forEach(tipo => {
                localStorage.removeItem(getStorageKey(tipo));
            });
            
            showToast('Sistema reseteado correctamente para nuevo año lectivo');
            cancelarReset();
            renderDashboard();
        }

        // === UTILIDADES MODALES Y EXTRAS ===
        function cerrarModal(id) {
            $(id).classList.remove('active');
        }

        function busquedaGlobal(e) {
            if(e.key === 'Enter') {
                const term = $('busqueda-global').value.toLowerCase();
                if(!term) return;
                
                // Buscar en alumnos y si hay coincidencia, ir a esa pestaña
                const alumnos = getData('alumnos');
                const encontrado = alumnos.find(a => a.nombre.toLowerCase().includes(term) || a.cedula.includes(term));
                
                if(encontrado) {
                    switchTab('alumnos');
                    $('buscar-alumno').value = term;
                    filtrarAlumnos();
                } else {
                    showToast('No se encontraron resultados', 'error');
                }
                
                $('busqueda-global').value = '';
            }
        }

        function irAPagos(alumnoId, mes) {
            switchTab('pagos');
            seleccionarAlumnoPago(alumnoId);
            $('pago-concepto').value = 'mensualidad';
            cambiarConceptoPago();
            if(mes) $('pago-mes').value = mes;
            calcularMontoAutomatico();
        }

        function verFichaAlumno(alumnoId) {
            const alumno = getData('alumnos').find(a => a.id === alumnoId);
            const pagos = getData('pagos').filter(p => p.alumno_id === alumnoId);
            const libros = getData('libros').filter(l => l.alumno_id === alumnoId);
            const deudaMat = calcularDeudaMatricula(alumno);
            
            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-lg text-ukblue mb-4">Datos Personales</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between border-b py-2"><span class="text-gray-500">Nombre:</span> <span class="font-medium">${alumno.nombre}</span></div>
                            <div class="flex justify-between border-b py-2"><span class="text-gray-500">Cédula:</span> <span>${alumno.cedula}</span></div>
                            <div class="flex justify-between border-b py-2"><span class="text-gray-500">Teléfono:</span> <span>${alumno.telefono || '-'}</span></div>
                            <div class="flex justify-between border-b py-2"><span class="text-gray-500">Email:</span> <span>${alumno.email || '-'}</span></div>
                            <div class="flex justify-between border-b py-2"><span class="text-gray-500">Dirección:</span> <span>${alumno.direccion || '-'}</span></div>
                            <div class="flex justify-between border-b py-2"><span class="text-gray-500">Padre/Tutor:</span> <span>${alumno.nombre_padre || '-'}</span></div>
                            <div class="flex justify-between border-b py-2"><span class="text-gray-500">Madre:</span> <span>${alumno.nombre_madre || '-'}</span></div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-lg text-ukblue mb-4">Estado Financiero</h4>
                        <div class="space-y-3">
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                <div class="text-sm text-gray-600">Deuda Matrícula</div>
                                <div class="text-2xl font-bold text-red-600">${formatMoney(deudaMat)}</div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div class="text-sm text-gray-600">Libros Pendientes</div>
                                <div class="text-lg font-bold text-blue-600">${libros.filter(l => parseFloat(l.saldo) > 0).length} libros</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="font-bold text-lg text-ukblue mb-4">Últimos Pagos</h4>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        ${pagos.slice(0, 5).map(p => `
                            <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <div class="font-medium capitalize">${p.concepto}</div>
                                    <div class="text-sm text-gray-500">${p.fecha}</div>
                                </div>
                                <div class="font-bold text-green-600">${formatMoney(p.monto)}</div>
                            </div>
                        `).join('') || '<p class="text-gray-500">Sin pagos registrados</p>'}
                    </div>
                </div>
            `;
            
            $('contenido-ficha').innerHTML = html;
            $('modal-ficha').classList.add('active');
        }

        function generarFichaAlumno() {
            const id = $('alumno-id').value;
            if(id) verFichaAlumno(id);
        }

        // === INICIALIZACIÓN ===
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar datos por defecto si no existen
            if(getData('niveles').length === 0) {
                // Cargar desde el JSON del usuario si existe en localStorage previo
                // o dejar vacío para que configuren
            }
            
            if(getData('tiposMatricula').length === 0) {
                setData('tiposMatricula', [
                    {id: 1, nombre: 'Regular', costo: 1500},
                    {id: 2, nombre: 'Matricula x 2', costo: 1250},
                    {id: 3, nombre: 'Matricula x 3', costo: 1300}
                ]);
            }
            
            renderDashboard();
            cargarSelects();
            
            // Cerrar modales al hacer click fuera
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if(e.target === modal) modal.classList.remove('active');
                });
            });
        });
    </script>
</body>
</html>
