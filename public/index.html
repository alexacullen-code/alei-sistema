<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALEI - Sistema de Gestión 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
        .gradient-blue { background: linear-gradient(135deg, #00247D 0%, #1e40af 100%); }
        .gradient-red { background: linear-gradient(135deg, #CF142B 0%, #b91c1c 100%); }
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
        .card-hover { transition: all 0.3s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .status-badge { @apply px-3 py-1 rounded-full text-xs font-bold; }
        .paid { background: #dcfce7; color: #166534; }
        .pending { background: #fef3c7; color: #92400e; }
        .overdue { background: #fee2e2; color: #991b1b; }
        .partial { background: #dbeafe; color: #1e40af; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 50; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .animate-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-active { border-bottom: 3px solid #CF142B; color: #00247D; background: #eff6ff; }
        .pos-button { @apply p-4 rounded-xl text-white font-bold text-lg transition transform active:scale-95; }
        .debt-card { border-left: 4px solid #dc2626; background: linear-gradient(to right, #fef2f2, white); }
        .income-card { border-left: 4px solid #16a34a; background: linear-gradient(to right, #f0fdf4, white); }
        .search-highlight { background: #fef08a; padding: 0 2px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="gradient-blue text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <svg class="w-10 h-6" viewBox="0 0 60 30"><rect width="60" height="30" fill="#012169"/><path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0 L60,30 M60,0 L0,30" stroke="#C8102E" stroke-width="4"/><path d="M30,0 V30 M0,15 H60" stroke="#fff" stroke-width="10"/><path d="M30,0 V30 M0,15 H60" stroke="#C8102E" stroke-width="6"/></svg>
                <div>
                    <h1 class="text-xl font-bold">ALEI Instituto de Inglés</h1>
                    <div class="text-xs opacity-90 flex gap-3">
                        <span id="current-year-display">Año: 2026</span>
                        <span id="current-date"></span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <select id="global-year-selector" class="bg-white/20 text-white border border-white/30 rounded-lg px-3 py-1 text-sm focus:outline-none focus:bg-white/30">
                    <option value="2025">2025</option>
                    <option value="2026" selected>2026</option>
                    <option value="2027">2027</option>
                </select>
                <button onclick="openCajaRapida()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-semibold transition">
                    <i class="fas fa-cash-register mr-2"></i>Caja Rápida
                </button>
                <div class="relative">
                    <button onclick="toggleAlertas()" class="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg transition relative">
                        <i class="fas fa-bell"></i>
                        <span id="alert-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
                    </button>
                    <div id="alertas-dropdown" class="hidden absolute right-0 top-full mt-2 w-80 bg-white rounded-xl shadow-2xl border border-slate-200 overflow-hidden z-50">
                        <div class="p-3 border-b bg-slate-50 font-semibold text-sm">Notificaciones</div>
                        <div id="alertas-list" class="max-h-64 overflow-y-auto p-2 space-y-2">
                            <p class="text-sm text-slate-500 text-center py-4">Sin alertas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-16 z-30">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex overflow-x-auto hide-scrollbar">
                <button onclick="switchTab('dashboard')" class="tab-btn tab-active px-6 py-4 text-sm font-medium text-slate-600 hover:text-blue-900 whitespace-nowrap transition" data-tab="dashboard">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                <button onclick="switchTab('alumnos')" class="tab-btn px-6 py-4 text-sm font-medium text-slate-600 hover:text-blue-900 whitespace-nowrap transition" data-tab="alumnos">
                    <i class="fas fa-users mr-2"></i>Alumnos
                </button>
                <button onclick="switchTab('pagos')" class="tab-btn px-6 py-4 text-sm font-medium text-slate-600 hover:text-blue-900 whitespace-nowrap transition" data-tab="pagos">
                    <i class="fas fa-dollar-sign mr-2"></i>Pagos
                </button>
                <button onclick="switchTab('libros')" class="tab-btn px-6 py-4 text-sm font-medium text-slate-600 hover:text-blue-900 whitespace-nowrap transition" data-tab="libros">
                    <i class="fas fa-book mr-2"></i>Libros
                </button>
                <button onclick="switchTab('gastos')" class="tab-btn px-6 py-4 text-sm font-medium text-slate-600 hover:text-blue-900 whitespace-nowrap transition" data-tab="gastos">
                    <i class="fas fa-receipt mr-2"></i>Gastos
                </button>
                <button onclick="switchTab('reportes')" class="tab-btn px-6 py-4 text-sm font-medium text-slate-600 hover:text-blue-900 whitespace-nowrap transition" data-tab="reportes">
                    <i class="fas fa-file-alt mr-2"></i>Reportes
                </button>
                <button onclick="switchTab('config')" class="tab-btn px-6 py-4 text-sm font-medium text-slate-600 hover:text-blue-900 whitespace-nowrap transition" data-tab="config">
                    <i class="fas fa-cog mr-2"></i>Config
                </button>
                <button onclick="switchTab('data')" class="tab-btn px-6 py-4 text-sm font-medium text-slate-600 hover:text-blue-900 whitespace-nowrap transition" data-tab="data">
                    <i class="fas fa-database mr-2"></i>Datos
                </button>
            </div>
        </div>
    </nav>

    <!-- Global Search -->
    <div class="max-w-7xl mx-auto px-4 mt-4">
        <div class="relative">
            <input type="text" id="global-search" placeholder="Buscar alumno, libro, pago..." 
                   class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   oninput="globalSearch()">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <div id="search-results" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-slate-200 z-40 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 pb-24">

        <!-- DASHBOARD -->
        <div id="tab-dashboard" class="tab-content animate-fade">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-slate-500 font-medium">Alumnos Activos</p>
                            <h3 class="text-2xl font-bold text-slate-800 mt-1" id="dash-total-alumnos">0</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg text-blue-600"><i class="fas fa-users"></i></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 card-hover income-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-slate-500 font-medium">Ingresos Mes</p>
                            <h3 class="text-2xl font-bold text-green-600 mt-1" id="dash-ingresos">$0</h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg text-green-600"><i class="fas fa-arrow-up"></i></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 card-hover debt-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-slate-500 font-medium">Deuda Total</p>
                            <h3 class="text-2xl font-bold text-red-600 mt-1" id="dash-deuda">$0</h3>
                        </div>
                        <div class="bg-red-100 p-3 rounded-lg text-red-600"><i class="fas fa-arrow-down"></i></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 card-hover">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-slate-500 font-medium">Libros Pendientes</p>
                            <h3 class="text-2xl font-bold text-amber-600 mt-1" id="dash-libros">0</h3>
                        </div>
                        <div class="bg-amber-100 p-3 rounded-lg text-amber-600"><i class="fas fa-book"></i></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Mensualidades del Mes Actual</h3>
                        <div class="space-y-3" id="dash-mensualidades">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Flujo de Caja (Ingresos vs Gastos)</h3>
                        <div class="flex items-end gap-2 h-40 mb-4" id="cash-flow-chart">
                            <!-- Barras dinámicas -->
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="p-3 bg-green-50 rounded-lg">
                                <div class="text-sm text-green-600 font-medium">Ingresos</div>
                                <div class="text-xl font-bold text-green-700" id="cash-in">$0</div>
                            </div>
                            <div class="p-3 bg-red-50 rounded-lg">
                                <div class="text-sm text-red-600 font-medium">Gastos</div>
                                <div class="text-xl font-bold text-red-700" id="cash-out">$0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Alertas Recientes</h3>
                        <div id="dash-alertas" class="space-y-3 max-h-64 overflow-y-auto">
                            <p class="text-sm text-slate-500 text-center py-4">Cargando...</p>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl shadow-lg p-6 text-white">
                        <h3 class="text-lg font-bold mb-2">Acceso Rápido</h3>
                        <div class="space-y-2">
                            <button onclick="switchTab('alumnos')" class="w-full bg-white/20 hover:bg-white/30 py-2 rounded-lg text-sm transition text-left px-4">
                                <i class="fas fa-plus mr-2"></i>Nuevo Alumno
                            </button>
                            <button onclick="openCajaRapida()" class="w-full bg-white/20 hover:bg-white/30 py-2 rounded-lg text-sm transition text-left px-4">
                                <i class="fas fa-cash-register mr-2"></i>Registrar Pago
                            </button>
                            <button onclick="generarMensajesCobranza()" class="w-full bg-white/20 hover:bg-white/30 py-2 rounded-lg text-sm transition text-left px-4">
                                <i class="fab fa-whatsapp mr-2"></i>Mensajes de Cobranza
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ALUMNOS -->
        <div id="tab-alumnos" class="tab-content hidden animate-fade">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800" id="alumno-form-title">Nuevo Alumno</h2>
                    <button onclick="resetAlumnoForm()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Limpiar formulario</button>
                </div>
                
                <form id="form-alumno" onsubmit="guardarAlumno(event)" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <input type="hidden" id="alumno-id">
                    
                    <div class="lg:col-span-2 grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Nombre Completo *</label>
                            <input type="text" id="alumno-nombre" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Cédula *</label>
                            <input type="text" id="alumno-cedula" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent" required onblur="validarCedulaUnica(this.value)">
                            <p id="cedula-error" class="text-xs text-red-600 hidden mt-1">Esta cédula ya está registrada</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">N° Anual</label>
                            <input type="number" id="alumno-numero" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Auto">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Nivel *</label>
                            <select id="alumno-nivel" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Tipo Matrícula *</label>
                            <select id="alumno-tipo-mat" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent" required onchange="mostrarInfoTipoMatricula()">
                                <option value="">Seleccionar...</option>
                            </select>
                            <div id="info-tipo-mat" class="text-xs text-slate-500 mt-1"></div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Teléfono Alumno</label>
                        <input type="tel" id="alumno-telefono" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="alumno-email" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Fecha Inscripción *</label>
                        <input type="date" id="alumno-fecha" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>

                    <div class="lg:col-span-3 border-t pt-4 mt-2">
                        <h4 class="font-semibold text-slate-700 mb-3 text-sm uppercase tracking-wide">Datos del Tutor</h4>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nombre Tutor</label>
                        <input type="text" id="tutor-nombre" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Teléfono Tutor</label>
                        <input type="tel" id="tutor-telefono" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email Tutor</label>
                        <input type="email" id="tutor-email" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div class="lg:col-span-3">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Dirección</label>
                        <input type="text" id="alumno-direccion" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div class="lg:col-span-3 flex gap-3">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition shadow-md hover:shadow-lg">
                            <i class="fas fa-save mr-2"></i>Guardar Alumno
                        </button>
                        <button type="button" onclick="resetAlumnoForm()" class="px-6 py-3 border border-slate-300 rounded-lg hover:bg-slate-50 transition">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h3 class="text-lg font-bold text-slate-800">Lista de Alumnos</h3>
                    <div class="flex gap-2 w-full md:w-auto">
                        <input type="text" id="filter-alumno" placeholder="Filtrar alumnos..." class="px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="renderAlumnos()">
                        <button onclick="switchTab('preinscripciones')" class="bg-amber-100 text-amber-700 px-4 py-2 rounded-lg font-medium hover:bg-amber-200 transition">
                            <i class="fas fa-clock mr-2"></i>Lista Espera <span id="count-espera" class="bg-amber-600 text-white text-xs px-2 py-0.5 rounded-full">0</span>
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">N°</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">Alumno</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">Nivel</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">Tipo Mat</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">Deuda</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">Estado</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-alumnos" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PAGOS -->
        <div id="tab-pagos" class="tab-content hidden animate-fade">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Registrar Pago Detallado</h3>
                        
                        <div class="mb-4">
                            <input type="text" id="pago-buscar" placeholder="Buscar alumno..." class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent" oninput="buscarAlumnoPago(this.value)">
                            <div id="pago-search-results" class="mt-2 space-y-1 max-h-48 overflow-y-auto"></div>
                        </div>

                        <form id="form-pago" onsubmit="guardarPago(event)" class="hidden space-y-4">
                            <input type="hidden" id="pago-alumno-id">
                            
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div class="font-semibold text-blue-900" id="pago-alumno-info"></div>
                                <div class="text-sm text-blue-700 mt-1" id="pago-alumno-deuda"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Concepto *</label>
                                    <select id="pago-concepto" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500" required onchange="cambiarConceptoPago()">
                                        <option value="">Seleccionar...</option>
                                        <option value="matricula">Matrícula</option>
                                        <option value="mensualidad">Mensualidad</option>
                                        <option value="libro">Libro/Material</option>
                                        <option value="examen">Examen</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                </div>
                                
                                <div id="campo-mes-pago" class="hidden">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Mes</label>
                                    <select id="pago-mes" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500">
                                        <option value="1">Enero</option>
                                        <option value="2">Febrero</option>
                                        <option value="3">Marzo</option>
                                        <option value="4">Abril</option>
                                        value="5">Mayo</option>
                                        <option value="6">Junio</option>
                                        <option value="7">Julio</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                </div>

                                <div id="campo-libro-pago" class="hidden col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Libro</label>
                                    <select id="pago-libro-select" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500" onchange="actualizarSaldoLibro()">
                                        <option value="">Seleccionar libro con saldo...</option>
                                    </select>
                                    <div id="info-saldo-libro" class="mt-2 p-3 bg-amber-50 rounded-lg text-sm hidden">
                                        <div class="flex justify-between">
                                            <span>Saldo pendiente:</span>
                                            <span class="font-bold text-amber-700" id="saldo-libro-display">$0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Monto Abonado *</label>
                                    <input type="number" id="pago-monto" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500" required oninput="calcularRecargoDescuento()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Fecha Pago *</label>
                                    <input type="date" id="pago-fecha" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500" required onchange="calcularRecargoDescuento()">
                                </div>
                            </div>

                            <!-- Indicador de Recargo/Descuento Automático -->
                            <div id="indicador-recargo" class="hidden p-3 rounded-lg text-sm font-medium"></div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Comentarios / Observaciones</label>
                                <textarea id="pago-comentarios" rows="2" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500" placeholder="Ej: Me entregó $500, falta el resto para el próximo mes..."></textarea>
                            </div>

                            <div class="flex gap-3">
                                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition shadow-md">
                                    <i class="fas fa-check mr-2"></i>Registrar Pago
                                </button>
                                <button type="button" onclick="document.getElementById('form-pago').reset(); document.getElementById('form-pago').classList.add('hidden');" class="px-6 py-3 border border-slate-300 rounded-lg hover:bg-slate-50">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Historial de Pagos Recientes</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="text-left py-2 px-3 text-xs font-semibold text-slate-600">Fecha</th>
                                        <th class="text-left py-2 px-3 text-xs font-semibold text-slate-600">Alumno</th>
                                        <th class="text-left py-2 px-3 text-xs font-semibold text-slate-600">Concepto</th>
                                        <th class="text-right py-2 px-3 text-xs font-semibold text-slate-600">Monto</th>
                                        <th class="text-left py-2 px-3 text-xs font-semibold text-slate-600">Comentarios</th>
                                        <th class="text-center py-2 px-3 text-xs font-semibold text-slate-600">Acc</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-pagos" class="divide-y divide-slate-100 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl shadow-lg p-6 text-white">
                        <h4 class="font-bold mb-3">Cálculo Automático</h4>
                        <div class="space-y-2 text-sm opacity-90">
                            <div class="flex justify-between border-b border-white/20 pb-2">
                                <span>1-10 del mes:</span>
                                <span class="font-bold text-green-300">-$150 (Desc)</span>
                            </div>
                            <div class="flex justify-between border-b border-white/20 pb-2">
                                <span>11-15 del mes:</span>
                                <span class="font-bold">Precio normal</span>
                            </div>
                            <div class="flex justify-between">
                                <span>16+ del mes:</span>
                                <span class="font-bold text-red-300">+$150 (Rec)</span>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-white/20 text-xs opacity-75">
                            *No aplica a hermanos (precio fijo)
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h4 class="font-bold text-slate-800 mb-3">Generar Cobranza</h4>
                        <select id="whatsapp-tipo" class="w-full mb-3 px-3 py-2 rounded-lg border border-slate-300 text-sm">
                            <option value="atraso">Atraso Mensual</option>
                            <option value="libro">Libro Pendiente</option>
                            <option value="matricula">Matrícula</option>
                        </select>
                        <button onclick="generarMensajeWhatsApp()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition">
                            <i class="fab fa-whatsapp mr-2"></i>Generar Mensaje
                        </button>
                        <textarea id="whatsapp-preview" class="w-full mt-3 p-3 bg-slate-50 rounded-lg text-xs hidden" rows="4" readonly></textarea>
                        <button onclick="copiarWhatsApp()" id="btn-copiar-wa" class="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 rounded-lg hidden">
                            Copiar Mensaje
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- LIBROS -->
        <div id="tab-libros" class="tab-content hidden animate-fade">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Asignar Libro con Pago Parcial</h3>
                    
                    <div class="mb-4">
                        <input type="text" id="libro-buscar-alumno" placeholder="Buscar alumno..." class="w-full px-4 py-2 rounded-lg border border-slate-300" oninput="buscarAlumnoLibro(this.value)">
                        <div id="libro-search-results" class="mt-2 space-y-1 max-h-40 overflow-y-auto"></div>
                    </div>

                    <form id="form-libro" onsubmit="asignarLibro(event)" class="hidden space-y-4">
                        <input type="hidden" id="libro-alumno-id">
                        <div class="bg-blue-50 p-3 rounded-lg text-sm font-medium text-blue-900" id="libro-alumno-info"></div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Título del Libro *</label>
                            <input type="text" id="libro-titulo" class="w-full px-4 py-2 rounded-lg border border-slate-300" required>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Costo Total *</label>
                                <input type="number" id="libro-costo" class="w-full px-4 py-2 rounded-lg border border-slate-300" required oninput="calcularSaldoLibroInicial()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Primer Abono *</label>
                                <input type="number" id="libro-abono" class="w-full px-4 py-2 rounded-lg border border-slate-300" required oninput="calcularSaldoLibroInicial()">
                            </div>
                        </div>

                        <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-600">Saldo a financiar:</span>
                                <span class="font-bold text-amber-700" id="libro-saldo-inicial">$0</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Comentarios</label>
                            <textarea id="libro-comentarios" rows="2" class="w-full px-4 py-2 rounded-lg border border-slate-300"></textarea>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition">
                            Asignar Libro y Registrar Abono
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Libros con Saldos Pendientes</h3>
                    <div class="space-y-3 max-h-96 overflow-y-auto" id="lista-libros-pendientes">
                        <!-- Dinámico -->
                    </div>
                </div>
            </div>

            <div class="mt-6 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Todos los Libros</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="text-left py-2 px-3 text-xs font-semibold">Alumno</th>
                                <th class="text-left py-2 px-3 text-xs font-semibold">Libro</th>
                                <th class="text-right py-2 px-3 text-xs font-semibold">Costo</th>
                                <th class="text-right py-2 px-3 text-xs font-semibold">Pagado</th>
                                <th class="text-right py-2 px-3 text-xs font-semibold">Saldo</th>
                                <th class="text-center py-2 px-3 text-xs font-semibold">%</th>
                                <th class="text-center py-2 px-3 text-xs font-semibold">Acc</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-libros" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- GASTOS -->
        <div id="tab-gastos" class="tab-content hidden animate-fade">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Registrar Gasto</h3>
                <form id="form-gasto" onsubmit="guardarGasto(event)" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-2">
                        <input type="text" id="gasto-concepto" placeholder="Concepto del gasto..." class="w-full px-4 py-2 rounded-lg border border-slate-300" required>
                    </div>
                    <div>
                        <input type="number" id="gasto-monto" placeholder="Monto..." class="w-full px-4 py-2 rounded-lg border border-slate-300" required>
                    </div>
                    <div>
                        <input type="date" id="gasto-fecha" class="w-full px-4 py-2 rounded-lg border border-slate-300" required>
                    </div>
                    <div>
                        <select id="gasto-categoria" class="w-full px-4 py-2 rounded-lg border border-slate-300" required>
                            <option value="materiales">Materiales/Escolar</option>
                            <option value="servicios">Servicios (Luz/Agua/Internet)</option>
                            <option value="mantenimiento">Mantenimiento</option>
                            <option value="personal">Sueldos/Personal</option>
                            <option value="impuestos">Impuestos</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <label class="flex items-center gap-2 text-sm text-slate-600">
                            <input type="checkbox" id="gasto-es-cuota" onchange="toggleCuotaGasto(this.checked)">
                            <span>Es compra en cuotas</span>
                        </label>
                    </div>
                    <div id="campos-cuota" class="hidden md:col-span-4 grid grid-cols-3 gap-4">
                        <input type="number" id="gasto-cuota-numero" placeholder="N° Cuota actual" class="px-4 py-2 rounded-lg border border-slate-300">
                        <input type="number" id="gasto-cuota-total" placeholder="Total de cuotas" class="px-4 py-2 rounded-lg border border-slate-300">
                        <input type="text" id="gasto-cuota-detalle" placeholder="Ej: Cuota 3/6 - Impresora" class="px-4 py-2 rounded-lg border border-slate-300">
                    </div>
                    <div class="md:col-span-4">
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-2 rounded-lg transition">
                            <i class="fas fa-minus-circle mr-2"></i>Registrar Gasto
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Historial de Gastos</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="text-left py-2 px-3 text-xs font-semibold">Fecha</th>
                                <th class="text-left py-2 px-3 text-xs font-semibold">Concepto</th>
                                <th class="text-left py-2 px-3 text-xs font-semibold">Categoría</th>
                                <th class="text-right py-2 px-3 text-xs font-semibold">Monto</th>
                                <th class="text-center py-2 px-3 text-xs font-semibold">Cuota</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-gastos" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- REPORTES -->
        <div id="tab-reportes" class="tab-content hidden animate-fade">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Estado de Cuenta por Mes</h3>
                    <div class="flex gap-2 mb-4">
                        <select id="reporte-mes" class="flex-1 px-4 py-2 rounded-lg border border-slate-300">
                            ${[...Array(12)].map((_,i) => `<option value="${i+1}">${['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Set','Oct','Nov','Dic'][i]}</option>`).join('')}
                        </select>
                        <button onclick="generarEstadoCuenta()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            Generar
                        </button>
                    </div>
                    <div id="estado-cuenta-result" class="hidden space-y-2 max-h-96 overflow-y-auto"></div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Resumen Financiero</h3>
                    <div class="space-y-3" id="resumen-financiero">
                        <!-- Dinámico -->
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Auditoría de Cambios</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="text-left py-2 px-3">Fecha/Hora</th>
                                <th class="text-left py-2 px-3">Usuario</th>
                                <th class="text-left py-2 px-3">Acción</th>
                                <th class="text-left py-2 px-3">Detalle</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-auditoria" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CONFIGURACIÓN -->
        <div id="tab-config" class="tab-content hidden animate-fade">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Niveles y Precios</h3>
                    <form id="form-nivel" onsubmit="guardarNivel(event)" class="flex gap-2 mb-4">
                        <input type="text" id="nivel-nombre" placeholder="Nombre nivel" class="flex-1 px-4 py-2 rounded-lg border border-slate-300" required>
                        <input type="number" id="nivel-precio" placeholder="Precio mensualidad" class="w-32 px-4 py-2 rounded-lg border border-slate-300" required>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+</button>
                    </form>
                    <div class="space-y-2" id="lista-niveles"></div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Tipos de Matrícula</h3>
                    <div class="space-y-3">
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold">Precio Base Matrícula</span>
                                <input type="number" id="config-matricula-base" value="3000" class="w-24 px-2 py-1 rounded border border-slate-300 text-right" onchange="actualizarCostosBase()">
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">Precio Base Mensualidad</span>
                                <input type="number" id="config-mensualidad-base" value="2500" class="w-24 px-2 py-1 rounded border border-slate-300 text-right" onchange="actualizarCostosBase()">
                            </div>
                        </div>
                        
                        <div id="lista-tipos-matricula-config" class="space-y-2">
                            <!-- Dinámico -->
                        </div>
                        
                        <button onclick="agregarTipoMatricula()" class="w-full border-2 border-dashed border-slate-300 text-slate-500 py-2 rounded-lg hover:border-blue-500 hover:text-blue-600 transition">
                            + Agregar Tipo Especial (Hermanos, Becas, etc.)
                        </button>
                    </div>
                </div>

                <div class="md:col-span-2 bg-red-50 rounded-xl shadow-sm border border-red-200 p-6">
                    <h3 class="text-lg font-bold text-red-800 mb-4">⚠️ Zona Peligrosa</h3>
                    <div class="flex gap-4 items-center">
                        <div class="flex-1">
                            <p class="text-sm text-red-700 mb-2">Resetear Sistema para Nuevo Año Lectivo</p>
                            <p class="text-xs text-red-600">Esto eliminará todos los alumnos, pagos y libros. Los niveles y configuraciones se mantienen.</p>
                        </div>
                        <button onclick="resetearSistema()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            Resetear Año
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATOS (Import/Export) -->
        <div id="tab-data" class="tab-content hidden animate-fade">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Exportar Datos (Backup)</h3>
                    <p class="text-sm text-slate-600 mb-4">Descargue la información por secciones o todo junto.</p>
                    
                    <div class="space-y-2">
                        <button onclick="exportarSeccion('completo')" class="w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 transition flex justify-between items-center">
                            <span class="font-medium text-blue-900">📦 Backup Completo</span>
                            <i class="fas fa-download text-blue-600"></i>
                        </button>
                        <button onclick="exportarSeccion('alumnos')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-lg border border-slate-200 transition flex justify-between items-center">
                            <span>👥 Solo Alumnos</span>
                            <i class="fas fa-download text-slate-400"></i>
                        </button>
                        <button onclick="exportarSeccion('pagos')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-lg border border-slate-200 transition flex justify-between items-center">
                            <span>💳 Solo Pagos</span>
                            <i class="fas fa-download text-slate-400"></i>
                        </button>
                        <button onclick="exportarSeccion('libros')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-lg border border-slate-200 transition flex justify-between items-center">
                            <span>📚 Solo Libros</span>
                            <i class="fas fa-download text-slate-400"></i>
                        </button>
                        <button onclick="exportarSeccion('gastos')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-lg border border-slate-200 transition flex justify-between items-center">
                            <span>📉 Solo Gastos</span>
                            <i class="fas fa-download text-slate-400"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Importar Datos</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Seleccionar sección a importar:</label>
                        <select id="import-seccion" class="w-full px-4 py-2 rounded-lg border border-slate-300 mb-3">
                            <option value="completo">Restaurar Backup Completo</option>
                            <option value="alumnos">Solo Alumnos</option>
                            <option value="pagos">Solo Pagos</option>
                            <option value="libros">Solo Libros</option>
                            <option value="gastos">Solo Gastos</option>
                            <option value="niveles">Solo Niveles/Config</option>
                        </select>
                        
                        <div class="flex gap-2 mb-3">
                            <button onclick="setImportMode('file')" id="btn-mode-file" class="flex-1 py-2 rounded-lg bg-blue-600 text-white text-sm">Desde Archivo</button>
                            <button onclick="setImportMode('text')" id="btn-mode-text" class="flex-1 py-2 rounded-lg bg-slate-200 text-slate-700 text-sm">Pegar Texto</button>
                        </div>
                        
                        <div id="import-file-container">
                            <input type="file" id="import-file" accept=".json" class="w-full px-4 py-2 rounded-lg border border-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="previewImport()">
                        </div>
                        
                        <div id="import-text-container" class="hidden">
                            <textarea id="import-textarea" rows="6" class="w-full px-4 py-2 rounded-lg border border-slate-300 font-mono text-xs" placeholder="Pega aquí el JSON..."></textarea>
                            <button onclick="previewImportText()" class="mt-2 w-full bg-blue-600 text-white py-2 rounded-lg text-sm">Previsualizar</button>
                        </div>
                        
                        <div id="import-preview" class="hidden mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 max-h-48 overflow-y-auto">
                            <h4 class="font-semibold text-sm mb-2">Vista previa:</h4>
                            <div id="import-preview-content" class="text-xs text-slate-600"></div>
                        </div>
                        
                        <button onclick="ejecutarImportacion()" id="btn-importar" class="hidden w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition">
                            <i class="fas fa-upload mr-2"></i>Confirmar Importación
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRE-INSCRIPCIONES (Modal-like dentro del flujo) -->
        <div id="tab-preinscripciones" class="tab-content hidden animate-fade">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">Lista de Espera / Pre-inscripciones</h2>
                <button onclick="switchTab('alumnos')" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-arrow-left mr-2"></i>Volver a Alumnos
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Nueva Pre-inscripción</h3>
                <form id="form-espera" onsubmit="guardarEspera(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="espera-nombre" placeholder="Nombre interesado" class="px-4 py-2 rounded-lg border border-slate-300" required>
                    <input type="tel" id="espera-telefono" placeholder="Teléfono contacto" class="px-4 py-2 rounded-lg border border-slate-300" required>
                    <select id="espera-nivel" class="px-4 py-2 rounded-lg border border-slate-300" required>
                        <option value="">Nivel de interés...</option>
                    </select>
                    <div class="md:col-span-3">
                        <textarea id="espera-notas" placeholder="Notas adicionales (horarios preferidos, edad, etc.)" class="w-full px-4 py-2 rounded-lg border border-slate-300" rows="2"></textarea>
                    </div>
                    <div class="md:col-span-3">
                        <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-semibold px-6 py-2 rounded-lg transition">
                            Agregar a Lista de Espera
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Interesados en Curso</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="text-left py-2 px-3 text-xs font-semibold">Fecha</th>
                                <th class="text-left py-2 px-3 text-xs font-semibold">Nombre</th>
                                <th class="text-left py-2 px-3 text-xs font-semibold">Teléfono</th>
                                <th class="text-left py-2 px-3 text-xs font-semibold">Nivel</th>
                                <th class="text-left py-2 px-3 text-xs font-semibold">Estado</th>
                                <th class="text-center py-2 px-3 text-xs font-semibold">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-espera" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal Caja Rápida (POS) -->
    <div id="modal-caja" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden animate-fade">
            <div class="gradient-blue text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-cash-register mr-2"></i>Caja Rápida</h3>
                <button onclick="closeModal('modal-caja')" class="text-white/80 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6">
                <div class="mb-4 relative">
                    <input type="text" id="pos-buscar" placeholder="Buscar alumno..." class="w-full pl-10 pr-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:outline-none text-lg" oninput="buscarPos(this.value)">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <div id="pos-results" class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-slate-200 max-h-48 overflow-y-auto z-10"></div>
                </div>

                <div id="pos-alumno-seleccionado" class="hidden mb-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
                    <div class="font-bold text-blue-900 text-lg" id="pos-nombre"></div>
                    <div class="text-sm text-blue-700" id="pos-deuda"></div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="setPosConcepto('mensualidad')" class="pos-concepto-btn bg-slate-100 hover:bg-blue-100 text-slate-700 py-3 rounded-xl font-medium transition" data-concepto="mensualidad">
                        📅 Mensualidad
                    </button>
                    <button onclick="setPosConcepto('matricula')" class="pos-concepto-btn bg-slate-100 hover:bg-blue-100 text-slate-700 py-3 rounded-xl font-medium transition" data-concepto="matricula">
                        🎓 Matrícula
                    </button>
                    <button onclick="setPosConcepto('libro')" class="pos-concepto-btn bg-slate-100 hover:bg-blue-100 text-slate-700 py-3 rounded-xl font-medium transition" data-concepto="libro">
                        📚 Libro
                    </button>
                    <button onclick="setPosConcepto('examen')" class="pos-concepto-btn bg-slate-100 hover:bg-blue-100 text-slate-700 py-3 rounded-xl font-medium transition" data-concepto="examen">
                        📝 Examen
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Monto $</label>
                    <input type="number" id="pos-monto" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:outline-none text-2xl font-bold text-center" placeholder="0">
                </div>

                <div class="mb-4">
                    <input type="text" id="pos-comentario" placeholder="Comentario (opcional)..." class="w-full px-4 py-2 rounded-lg border border-slate-300 text-sm">
                </div>

                <button onclick="procesarPos()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg transform active:scale-95 transition">
                    <i class="fas fa-check-circle mr-2"></i>CONFIRMAR PAGO
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ficha Alumno -->
    <div id="modal-ficha" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto animate-fade">
            <div class="gradient-blue text-white p-4 sticky top-0 flex justify-between items-center z-10">
                <h3 class="font-bold text-lg"><i class="fas fa-id-card mr-2"></i>Ficha del Alumno</h3>
                <button onclick="closeModal('modal-ficha')" class="text-white/80 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6" id="ficha-contenido">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

    <!-- Modal Confirmación -->
    <div id="modal-confirm" class="modal">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6 animate-fade">
            <div class="text-center mb-4">
                <i class="fas fa-exclamation-triangle text-amber-500 text-4xl mb-2"></i>
                <h3 class="text-xl font-bold text-slate-800" id="confirm-title">Confirmar Acción</h3>
            </div>
            <p class="text-slate-600 text-center mb-6" id="confirm-message">¿Está seguro?</p>
            <div class="flex gap-3">
                <button onclick="closeModal('modal-confirm')" class="flex-1 py-3 border border-slate-300 rounded-lg hover:bg-slate-50 font-medium">Cancelar</button>
                <button id="confirm-btn" class="flex-1 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <i class="fas fa-check-circle text-green-400"></i>
        <span id="toast-message">Operación exitosa</span>
    </div>

    <script>
        // ==================== SISTEMA DE DATOS ====================
        const DB = {
            getYear: () => document.getElementById('global-year-selector').value || new Date().getFullYear(),
            
            get: (key) => {
                const year = DB.getYear();
                const data = localStorage.getItem(`alei_${year}_${key}`);
                return data ? JSON.parse(data) : null;
            },
            
            set: (key, value) => {
                const year = DB.getYear();
                localStorage.setItem(`alei_${year}_${key}`, JSON.stringify(value));
            },
            
            init: () => {
                const year = DB.getYear();
                if (!DB.get('alumnos')) DB.set('alumnos', []);
                if (!DB.get('pagos')) DB.set('pagos', []);
                if (!DB.get('libros')) DB.set('libros', []);
                if (!DB.get('gastos')) DB.set('gastos', []);
                if (!DB.get('espera')) DB.set('espera', []);
                if (!DB.get('niveles')) DB.set('niveles', [
                    {id: 1, nombre: '1st CH', precio: 1500},
                    {id: 2, nombre: '2nd CH', precio: 1600},
                    {id: 3, nombre: '3rd CH', precio: 1700},
                    {id: 4, nombre: '4th CH', precio: 1800},
                    {id: 5, nombre: '1st J', precio: 1600},
                    {id: 6, nombre: '2nd J', precio: 1700},
                    {id: 7, nombre: '3rd J', precio: 1900},
                    {id: 8, nombre: '4th J', precio: 2000},
                    {id: 9, nombre: '5th J', precio: 2100},
                    {id: 10, nombre: 'PET', precio: 2200},
                    {id: 11, nombre: 'FCE', precio: 2300},
                    {id: 12, nombre: 'CAE', precio: 2400}
                ]);
                if (!DB.get('tiposMatricula')) DB.set('tiposMatricula', [
                    {id: 1, nombre: 'Regular', porcentaje: 100, esFijo: false},
                    {id: 2, nombre: 'Hermano (Desc fijo)', porcentaje: 100, esFijo: true, descuentoFijo: 500},
                    {id: 3, nombre: 'Beca 50%', porcentaje: 50, esFijo: false}
                ]);
                if (!DB.get('config')) DB.set('config', {matriculaBase: 1500, mensualidadBase: 2500});
                if (!DB.get('auditoria')) DB.set('auditoria', []);
            }
        };

        // ==================== UTILIDADES ====================
        const utils = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            
            money: (n) => '$' + (n || 0).toLocaleString('es-UY'),
            
            fecha: (date) => {
                if (!date) return '-';
                const d = new Date(date);
                return d.toLocaleDateString('es-UY');
            },
            
            hoy: () => new Date().toISOString().split('T')[0],
            
            mesNombre: (m) => ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Set','Oct','Nov','Dic'][m-1],
            
            toast: (msg, type = 'success') => {
                const t = document.getElementById('toast');
                document.getElementById('toast-message').textContent = msg;
                t.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-2xl transform transition-all duration-300 z-50 flex items-center gap-3 ${type === 'error' ? 'bg-red-600' : 'bg-slate-800'} text-white`;
                t.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
            },
            
            confirm: (title, msg, callback) => {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = msg;
                document.getElementById('confirm-btn').onclick = () => {
                    closeModal('modal-confirm');
                    callback();
                };
                openModal('modal-confirm');
            },
            
            auditar: (accion, detalle) => {
                const aud = DB.get('auditoria') || [];
                aud.unshift({
                    fecha: new Date().toISOString(),
                    usuario: 'Admin',
                    accion,
                    detalle
                });
                DB.set('auditoria', aud.slice(0, 100)); // Mantener últimos 100
            }
        };

        // ==================== NAVEGACIÓN ====================
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('text-slate-600');
            });
            
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            event.target.classList.add('tab-active');
            event.target.classList.remove('text-slate-600');
            
            // Refresh data
            if (tab === 'dashboard') loadDashboard();
            if (tab === 'alumnos') loadAlumnos();
            if (tab === 'pagos') loadPagos();
            if (tab === 'libros') loadLibros();
            if (tab === 'gastos') loadGastos();
            if (tab === 'config') loadConfig();
            if (tab === 'reportes') loadReportes();
            if (tab === 'preinscripciones') loadEspera();
        }

        // ==================== DASHBOARD ====================
        function loadDashboard() {
            const alumnos = DB.get('alumnos');
            const pagos = DB.get('pagos');
            const gastos = DB.get('gastos');
            const libros = DB.get('libros');
            
            // Stats básicas
            document.getElementById('dash-total-alumnos').textContent = alumnos.length;
            
            // Ingresos mes actual
            const mesActual = new Date().getMonth() + 1;
            const ingresosMes = pagos.filter(p => new Date(p.fecha).getMonth() + 1 === mesActual)
                                    .reduce((sum, p) => sum + (p.monto || 0), 0);
            document.getElementById('dash-ingresos').textContent = utils.money(ingresosMes);
            
            // Deuda total
            const deudaMatriculas = alumnos.reduce((sum, a) => sum + getDeudaMatricula(a), 0);
            const deudaLibros = libros.reduce((sum, l) => sum + (l.saldo || 0), 0);
            document.getElementById('dash-deuda').textContent = utils.money(deudaMatriculas + deudaLibros);
            
            // Libros pendientes
            const librosPendientes = libros.filter(l => (l.saldo || 0) > 0).length;
            document.getElementById('dash-libros').textContent = librosPendientes;
            
            // Mensualidades del mes
            renderDashMensualidades(alumnos, pagos, mesActual);
            
            // Flujo de caja
            const gastosMes = gastos.filter(g => new Date(g.fecha).getMonth() + 1 === mesActual)
                                   .reduce((sum, g) => sum + (g.monto || 0), 0);
            document.getElementById('cash-in').textContent = utils.money(ingresosMes);
            document.getElementById('cash-out').textContent = utils.money(gastosMes);
            
            // Alertas
            renderAlertas(alumnos, libros, pagos);
        }

        function renderDashMensualidades(alumnos, pagos, mes) {
            const container = document.getElementById('dash-mensualidades');
            let html = '';
            
            alumnos.slice(0, 10).forEach(a => {
                const pago = pagos.find(p => p.alumnoId === a.id && p.concepto === 'mensualidad' && p.mes == mes);
                const estado = pago ? 
                    `<span class="paid px-2 py-1 rounded text-xs"><i class="fas fa-check mr-1"></i>Pagado</span>` :
                    `<span class="overdue px-2 py-1 rounded text-xs"><i class="fas fa-times mr-1"></i>Pendiente</span>`;
                
                html += `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-medium text-sm">${a.nombre}</div>
                        <div class="text-xs text-slate-500">${DB.get('niveles').find(n => n.id == a.nivelId)?.nombre || '-'}</div>
                    </div>
                    ${estado}
                </div>`;
            });
            
            container.innerHTML = html || '<p class="text-slate-500 text-center py-4">No hay alumnos registrados</p>';
        }

        function renderAlertas(alumnos, libros, pagos) {
            const alertas = [];
            const hoy = new Date();
            
            // Libros no retirados (saldo > 0 hace más de 30 días)
            libros.forEach(l => {
                if (l.saldo > 0 && l.fecha) {
                    const dias = Math.floor((hoy - new Date(l.fecha)) / (1000 * 60 * 60 * 24));
                    if (dias > 30) {
                        const alumno = alumnos.find(a => a.id === l.alumnoId);
                        alertas.push({tipo: 'warning', msg: `${alumno?.nombre || 'Alumno'} - Libro sin finalizar: ${l.titulo} (${dias} días)`});
                    }
                }
            });
            
            // Pagos atrasados +30 días
            pagos.forEach(p => {
                if (p.concepto === 'mensualidad') {
                    const dias = Math.floor((hoy - new Date(p.fecha)) / (1000 * 60 * 60 * 24));
                    if (dias > 30) {
                        const alumno = alumnos.find(a => a.id === p.alumnoId);
                        alertas.push({tipo: 'danger', msg: `${alumno?.nombre || 'Alumno'} - Pago atrasado +${dias} días`});
                    }
                }
            });
            
            // Actualizar badge
            const badge = document.getElementById('alert-badge');
            if (alertas.length > 0) {
                badge.textContent = alertas.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            // Render en dropdown
            const list = document.getElementById('alertas-list');
            list.innerHTML = alertas.length ? alertas.map(a => `
                <div class="p-2 rounded-lg ${a.tipo === 'danger' ? 'bg-red-50 text-red-700' : 'bg-amber-50 text-amber-700'} text-sm">
                    ${a.msg}
                </div>
            `).join('') : '<p class="text-sm text-slate-500 text-center py-4">Sin alertas pendientes</p>';
            
            // Render en dashboard
            document.getElementById('dash-alertas').innerHTML = alertas.slice(0, 5).map(a => `
                <div class="flex items-start gap-2 p-3 ${a.tipo === 'danger' ? 'bg-red-50 border-l-4 border-red-500' : 'bg-amber-50 border-l-4 border-amber-500'} rounded-r-lg">
                    <i class="fas ${a.tipo === 'danger' ? 'fa-exclamation-circle text-red-500' : 'fa-exclamation-triangle text-amber-500'} mt-0.5"></i>
                    <span class="text-sm ${a.tipo === 'danger' ? 'text-red-700' : 'text-amber-700'}">${a.msg}</span>
                </div>
            `).join('') || '<p class="text-slate-500 text-center py-4">No hay alertas activas</p>';
        }

        function toggleAlertas() {
            document.getElementById('alertas-dropdown').classList.toggle('hidden');
        }

        // ==================== ALUMNOS ====================
        function loadAlumnos() {
            const niveles = DB.get('niveles');
            const tipos = DB.get('tiposMatricula');
            
            // Fill selects
            let optsNiveles = niveles.map(n => `<option value="${n.id}">${n.nombre} ($${n.precio})</option>`).join('');
            document.getElementById('alumno-nivel').innerHTML = '<option value="">Seleccionar...</option>' + optsNiveles;
            document.getElementById('espera-nivel').innerHTML = '<option value="">Nivel de interés...</option>' + optsNiveles;
            
            let optsTipos = tipos.map(t => `<option value="${t.id}">${t.nombre} ${t.esFijo ? '(Precio fijo)' : `(${t.porcentaje}%)`}</option>`).join('');
            document.getElementById('alumno-tipo-mat').innerHTML = '<option value="">Seleccionar...</option>' + optsTipos;
            
            renderAlumnos();
            
            // Fecha default hoy
            if (!document.getElementById('alumno-fecha').value) {
                document.getElementById('alumno-fecha').value = utils.hoy();
            }
        }

        function renderAlumnos() {
            const alumnos = DB.get('alumnos');
            const niveles = DB.get('niveles');
            const tipos = DB.get('tiposMatricula');
            const filtro = document.getElementById('filter-alumno')?.value?.toLowerCase() || '';
            
            let html = '';
            alumnos.forEach(a => {
                if (filtro && !a.nombre.toLowerCase().includes(filtro) && !a.cedula?.includes(filtro)) return;
                
                const nivel = niveles.find(n => n.id == a.nivelId);
                const tipo = tipos.find(t => t.id == a.tipoMatriculaId);
                const deuda = getDeudaMatricula(a) + getDeudaLibros(a.id);
                
                const estado = deuda > 0 ? 
                    `<span class="overdue">Deudor</span>` : 
                    `<span class="paid">Al día</span>`;
                
                html += `<tr class="hover:bg-slate-50">
                    <td class="py-3 px-4 text-sm">${a.numeroAnual || '-'}</td>
                    <td class="py-3 px-4">
                        <div class="font-medium text-sm">${a.nombre}</div>
                        <div class="text-xs text-slate-500">${a.cedula || '-'}</div>
                    </td>
                    <td class="py-3 px-4 text-sm">${nivel?.nombre || '-'}</td>
                    <td class="py-3 px-4 text-sm">${tipo?.nombre || 'Regular'}</td>
                    <td class="py-3 px-4 text-sm font-medium ${deuda > 0 ? 'text-red-600' : 'text-green-600'}">${utils.money(deuda)}</td>
                    <td class="py-3 px-4">${estado}</td>
                    <td class="py-3 px-4">
                        <button onclick="editarAlumno('${a.id}')" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar"><i class="fas fa-edit"></i></button>
                        <button onclick="verFicha('${a.id}')" class="text-green-600 hover:text-green-800 mr-2" title="Ver ficha"><i class="fas fa-id-card"></i></button>
                        <button onclick="eliminarAlumno('${a.id}')" class="text-red-600 hover:text-red-800" title="Eliminar"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('tabla-alumnos').innerHTML = html || '<tr><td colspan="7" class="text-center py-8 text-slate-500">No hay alumnos registrados</td></tr>';
            
            // Contador lista espera
            const espera = DB.get('espera') || [];
            document.getElementById('count-espera').textContent = espera.length;
        }

        function validarCedulaUnica(cedula) {
            const alumnos = DB.get('alumnos');
            const existe = alumnos.find(a => a.cedula === cedula && a.id !== document.getElementById('alumno-id').value);
            document.getElementById('cedula-error').classList.toggle('hidden', !existe);
        }

        function guardarAlumno(e) {
            e.preventDefault();
            const id = document.getElementById('alumno-id').value;
            const alumnos = DB.get('alumnos');
            
            const alumno = {
                id: id || utils.id(),
                nombre: document.getElementById('alumno-nombre').value,
                cedula: document.getElementById('alumno-cedula').value,
                numeroAnual: document.getElementById('alumno-numero').value || (alumnos.length + 1),
                nivelId: document.getElementById('alumno-nivel').value,
                tipoMatriculaId: document.getElementById('alumno-tipo-mat').value,
                telefono: document.getElementById('alumno-telefono').value,
                email: document.getElementById('alumno-email').value,
                direccion: document.getElementById('alumno-direccion').value,
                fechaInscripcion: document.getElementById('alumno-fecha').value,
                tutor: {
                    nombre: document.getElementById('tutor-nombre').value,
                    telefono: document.getElementById('tutor-telefono').value,
                    email: document.getElementById('tutor-email').value
                }
            };
            
            if (id) {
                const idx = alumnos.findIndex(a => a.id === id);
                alumnos[idx] = alumno;
                utils.auditar('Edición alumno', alumno.nombre);
            } else {
                alumnos.push(alumno);
                utils.auditar('Nuevo alumno', alumno.nombre);
            }
            
            DB.set('alumnos', alumnos);
            utils.toast('Alumno guardado correctamente');
            resetAlumnoForm();
            renderAlumnos();
        }

        function resetAlumnoForm() {
            document.getElementById('form-alumno').reset();
            document.getElementById('alumno-id').value = '';
            document.getElementById('alumno-fecha').value = utils.hoy();
            document.getElementById('alumno-form-title').textContent = 'Nuevo Alumno';
        }

        function editarAlumno(id) {
            const alumno = DB.get('alumnos').find(a => a.id === id);
            if (!alumno) return;
            
            document.getElementById('alumno-id').value = alumno.id;
            document.getElementById('alumno-nombre').value = alumno.nombre;
            document.getElementById('alumno-cedula').value = alumno.cedula || '';
            document.getElementById('alumno-numero').value = alumno.numeroAnual || '';
            document.getElementById('alumno-nivel').value = alumno.nivelId;
            document.getElementById('alumno-tipo-mat').value = alumno.tipoMatriculaId;
            document.getElementById('alumno-telefono').value = alumno.telefono || '';
            document.getElementById('alumno-email').value = alumno.email || '';
            document.getElementById('alumno-direccion').value = alumno.direccion || '';
            document.getElementById('alumno-fecha').value = alumno.fechaInscripcion || utils.hoy();
            
            if (alumno.tutor) {
                document.getElementById('tutor-nombre').value = alumno.tutor.nombre || '';
                document.getElementById('tutor-telefono').value = alumno.tutor.telefono || '';
                document.getElementById('tutor-email').value = alumno.tutor.email || '';
            }
            
            document.getElementById('alumno-form-title').textContent = 'Editar Alumno';
            window.scrollTo(0, 0);
        }

        function eliminarAlumno(id) {
            utils.confirm('Eliminar Alumno', '¿Está seguro? Se eliminarán también sus pagos y libros.', () => {
                let alumnos = DB.get('alumnos').filter(a => a.id !== id);
                let pagos = DB.get('pagos').filter(p => p.alumnoId !== id);
                let libros = DB.get('libros').filter(l => l.alumnoId !== id);
                
                DB.set('alumnos', alumnos);
                DB.set('pagos', pagos);
                DB.set('libros', libros);
                
                utils.auditar('Eliminación alumno', `ID: ${id}`);
                utils.toast('Alumno eliminado');
                renderAlumnos();
            });
        }

        function verFicha(id) {
            const alumno = DB.get('alumnos').find(a => a.id === id);
            const pagos = DB.get('pagos').filter(p => p.alumnoId === id).sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            const libros = DB.get('libros').filter(l => l.alumnoId === id);
            const nivel = DB.get('niveles').find(n => n.id == alumno.nivelId);
            const tipo = DB.get('tiposMatricula').find(t => t.id == alumno.tipoMatriculaId);
            
            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="text-2xl font-bold text-slate-800 mb-1">${alumno.nombre}</h4>
                        <p class="text-slate-500">${nivel?.nombre || 'Sin nivel'} | ${tipo?.nombre || 'Regular'}</p>
                        <div class="mt-4 space-y-2 text-sm">
                            <p><i class="fas fa-id-card w-6 text-slate-400"></i> ${alumno.cedula || '-'}</p>
                            <p><i class="fas fa-phone w-6 text-slate-400"></i> ${alumno.telefono || '-'}</p>
                            <p><i class="fas fa-envelope w-6 text-slate-400"></i> ${alumno.email || '-'}</p>
                            <p><i class="fas fa-map-marker-alt w-6 text-slate-400"></i> ${alumno.direccion || '-'}</p>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl">
                        <h5 class="font-bold text-slate-700 mb-3">Resumen Financiero</h5>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>Deuda Matrícula:</span>
                                <span class="font-bold text-red-600">${utils.money(getDeudaMatricula(alumno))}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Deuda Libros:</span>
                                <span class="font-bold text-red-600">${utils.money(getDeudaLibros(id))}</span>
                            </div>
                            <div class="border-t pt-2 flex justify-between font-bold">
                                <span>Total Deuda:</span>
                                <span class="text-red-600">${utils.money(getDeudaMatricula(alumno) + getDeudaLibros(id))}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <h5 class="font-bold text-slate-700 border-b pb-2">Historial de Pagos</h5>
                    <div class="max-h-64 overflow-y-auto space-y-2">
                        ${pagos.length ? pagos.map(p => `
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg text-sm">
                                <div>
                                    <div class="font-medium capitalize">${p.concepto} ${p.mes ? '- ' + utils.mesNombre(p.mes) : ''}</div>
                                    <div class="text-xs text-slate-500">${utils.fecha(p.fecha)} ${p.comentarios ? '| ' + p.comentarios : ''}</div>
                                </div>
                                <span class="font-bold text-green-600">${utils.money(p.monto)}</span>
                            </div>
                        `).join('') : '<p class="text-slate-500 text-center py-4">Sin pagos registrados</p>'}
                    </div>
                    
                    <h5 class="font-bold text-slate-700 border-b pb-2 mt-6">Libros Asignados</h5>
                    <div class="space-y-2">
                        ${libros.length ? libros.map(l => `
                            <div class="flex justify-between items-center p-3 ${l.saldo > 0 ? 'bg-amber-50 border border-amber-200' : 'bg-green-50 border border-green-200'} rounded-lg text-sm">
                                <div>
                                    <div class="font-medium">${l.titulo}</div>
                                    <div class="text-xs ${l.saldo > 0 ? 'text-amber-600' : 'text-green-600'}">
                                        ${l.saldo > 0 ? `Saldo: ${utils.money(l.saldo)}` : 'Pagado completo'}
                                    </div>
                                </div>
                                <span class="text-slate-600">${utils.money(l.costoTotal)}</span>
                            </div>
                        `).join('') : '<p class="text-slate-500 text-center py-4">Sin libros asignados</p>'}
                    </div>
                </div>
            `;
            
            document.getElementById('ficha-contenido').innerHTML = html;
            openModal('modal-ficha');
        }

        // ==================== LÓGICA DE DEUDAS ====================
        function getDeudaMatricula(alumno) {
            if (!alumno.tipoMatriculaId) return 0;
            const tipo = DB.get('tiposMatricula').find(t => t.id == alumno.tipoMatriculaId);
            const config = DB.get('config');
            
            let monto = 0;
            if (tipo?.esFijo) {
                // Para hermanos: precio base - descuento fijo
                monto = (config?.matriculaBase || 1500) - (tipo.descuentoFijo || 0);
            } else {
                // Para otros: porcentaje del base
                monto = (config?.matriculaBase || 1500) * (tipo?.porcentaje || 100) / 100;
            }
            
            const pagos = DB.get('pagos').filter(p => p.alumnoId === alumno.id && p.concepto === 'matricula');
            const pagado = pagos.reduce((sum, p) => sum + p.monto, 0);
            
            return Math.max(0, monto - pagado);
        }

        function getDeudaLibros(alumnoId) {
            const libros = DB.get('libros').filter(l => l.alumnoId === alumnoId);
            return libros.reduce((sum, l) => sum + (l.saldo || 0), 0);
        }

        function getDeudaMensualidad(alumnoId, mes) {
            const nivel = DB.get('niveles').find(n => {
                const alumno = DB.get('alumnos').find(a => a.id === alumnoId);
                return n.id == alumno?.nivelId;
            });
            const precio = nivel?.precio || 0;
            const pago = DB.get('pagos').find(p => p.alumnoId === alumnoId && p.concepto === 'mensualidad' && p.mes == mes);
            return pago ? 0 : precio;
        }

        // ==================== PAGOS ====================
        function buscarAlumnoPago(term) {
            if (term.length < 2) {
                document.getElementById('pago-search-results').innerHTML = '';
                return;
            }
            
            const alumnos = DB.get('alumnos').filter(a => 
                a.nombre.toLowerCase().includes(term.toLowerCase()) || 
                a.cedula?.includes(term)
            );
            
            document.getElementById('pago-search-results').innerHTML = alumnos.map(a => `
                <div class="p-3 bg-slate-50 hover:bg-blue-50 rounded-lg cursor-pointer transition flex justify-between items-center" onclick="seleccionarAlumnoPago('${a.id}')">
                    <div>
                        <div class="font-medium text-sm">${a.nombre}</div>
                        <div class="text-xs text-slate-500">${DB.get('niveles').find(n => n.id == a.nivelId)?.nombre || '-'}</div>
                    </div>
                    <div class="text-xs font-bold ${getDeudaMatricula(a) + getDeudaLibros(a.id) > 0 ? 'text-red-600' : 'text-green-600'}">
                        ${utils.money(getDeudaMatricula(a) + getDeudaLibros(a.id))}
                    </div>
                </div>
            `).join('');
        }

        function seleccionarAlumnoPago(id) {
            const alumno = DB.get('alumnos').find(a => a.id === id);
            document.getElementById('pago-alumno-id').value = id;
            document.getElementById('pago-alumno-info').textContent = alumno.nombre;
            document.getElementById('pago-alumno-deuda').textContent = `Deuda actual: ${utils.money(getDeudaMatricula(alumno) + getDeudaLibros(id))}`;
            document.getElementById('pago-fecha').value = utils.hoy();
            document.getElementById('form-pago').classList.remove('hidden');
            document.getElementById('pago-search-results').innerHTML = '';
            document.getElementById('pago-buscar').value = '';
            
            // Default mensualidad mes actual
            document.getElementById('pago-concepto').value = 'mensualidad';
            cambiarConceptoPago();
        }

        function cambiarConceptoPago() {
            const concepto = document.getElementById('pago-concepto').value;
            const alumnoId = document.getElementById('pago-alumno-id').value;
            const alumno = DB.get('alumnos').find(a => a.id === alumnoId);
            
            document.getElementById('campo-mes-pago').classList.toggle('hidden', concepto !== 'mensualidad');
            document.getElementById('campo-libro-pago').classList.add('hidden');
            
            if (concepto === 'mensualidad') {
                document.getElementById('pago-mes').value = new Date().getMonth() + 1;
                const nivel = DB.get('niveles').find(n => n.id == alumno?.nivelId);
                let monto = nivel?.precio || 0;
                
                // Calcular recargo/descuento por fecha solo si NO es hermano (tipo fijo)
                const tipo = DB.get('tiposMatricula').find(t => t.id == alumno?.tipoMatriculaId);
                if (!tipo?.esFijo) {
                    const recargo = calcularRecargoDescuentoFecha(document.getElementById('pago-fecha').value, document.getElementById('pago-mes').value);
                    monto += recargo;
                }
                
                document.getElementById('pago-monto').value = monto;
            } else if (concepto === 'matricula') {
                const tipo = DB.get('tiposMatricula').find(t => t.id == alumno?.tipoMatriculaId);
                const config = DB.get('config');
                let monto = 0;
                
                if (tipo?.esFijo) {
                    monto = config.matriculaBase - (tipo.descuentoFijo || 0);
                } else {
                    monto = config.matriculaBase * (tipo?.porcentaje || 100) / 100;
                }
                
                // Ver cuánto ya pagó
                const pagado = DB.get('pagos')
                    .filter(p => p.alumnoId === alumnoId && p.concepto === 'matricula')
                    .reduce((sum, p) => sum + p.monto, 0);
                
                document.getElementById('pago-monto').value = Math.max(0, monto - pagado);
            } else if (concepto === 'libro') {
                document.getElementById('campo-libro-pago').classList.remove('hidden');
                cargarSelectLibros(alumnoId);
            }
        }

        function calcularRecargoDescuentoFecha(fechaPagoStr, mesPagadoStr) {
            if (!fechaPagoStr || !mesPagadoStr) return 0;
            
            const fechaPago = new Date(fechaPagoStr);
            const dia = fechaPago.getDate();
            const mesPago = parseInt(mesPagadoStr);
            const mesActual = fechaPago.getMonth() + 1;
            
            // Si paga el mes anterior al actual: descuento
            // Si paga el mes posterior al actual: recargo
            // Si paga el mes actual: según el día
            
            let ajuste = 0;
            
            if (mesPago < mesActual) {
                // Paga mes anterior (adelantado): descuento
                ajuste = -150;
            } else if (mesPago > mesActual) {
                // Paga mes posterior (atrasado): recargo
                ajuste = 150;
            } else {
                // Mes actual: según día
                if (dia <= 10) ajuste = -150;
                else if (dia >= 16) ajuste = 150;
            }
            
            // Mostrar indicador
            const ind = document.getElementById('indicador-recargo');
            if (ajuste !== 0) {
                ind.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                if (ajuste < 0) {
                    ind.classList.add('bg-green-100', 'text-green-800');
                    ind.textContent = `✓ Descuento pronto pago: ${utils.money(Math.abs(ajuste))}`;
                } else {
                    ind.classList.add('bg-red-100', 'text-red-800');
                    ind.textContent = `⚠ Recargo por atraso: ${utils.money(ajuste)}`;
                }
            } else {
                ind.classList.add('hidden');
            }
            
            return ajuste;
        }

        function calcularRecargoDescuento() {
            const concepto = document.getElementById('pago-concepto').value;
            if (concepto === 'mensualidad') {
                const ajuste = calcularRecargoDescuentoFecha(
                    document.getElementById('pago-fecha').value,
                    document.getElementById('pago-mes').value
                );
                
                const alumnoId = document.getElementById('pago-alumno-id').value;
                const alumno = DB.get('alumnos').find(a => a.id === alumnoId);
                const nivel = DB.get('niveles').find(n => n.id == alumno?.nivelId);
                const base = nivel?.precio || 0;
                
                // Solo aplicar si no es tipo fijo (hermanos)
                const tipo = DB.get('tiposMatricula').find(t => t.id == alumno?.tipoMatriculaId);
                if (!tipo?.esFijo) {
                    document.getElementById('pago-monto').value = base + ajuste;
                }
            }
        }

        function cargarSelectLibros(alumnoId) {
            const libros = DB.get('libros').filter(l => l.alumnoId === alumnoId && l.saldo > 0);
            const select = document.getElementById('pago-libro-select');
            
            select.innerHTML = '<option value="">Seleccionar libro...</option>' + 
                libros.map(l => `<option value="${l.id}">${l.titulo} (Saldo: ${utils.money(l.saldo)})</option>`).join('');
        }

        function actualizarSaldoLibro() {
            const libroId = document.getElementById('pago-libro-select').value;
            if (!libroId) return;
            
            const libro = DB.get('libros').find(l => l.id === libroId);
            document.getElementById('saldo-libro-display').textContent = utils.money(libro.saldo);
            document.getElementById('info-saldo-libro').classList.remove('hidden');
            document.getElementById('pago-monto').value = libro.saldo;
        }

        function guardarPago(e) {
            e.preventDefault();
            const pagos = DB.get('pagos');
            
            const pago = {
                id: utils.id(),
                alumnoId: document.getElementById('pago-alumno-id').value,
                concepto: document.getElementById('pago-concepto').value,
                monto: parseInt(document.getElementById('pago-monto').value) || 0,
                fecha: document.getElementById('pago-fecha').value,
                mes: document.getElementById('pago-mes').value || null,
                comentarios: document.getElementById('pago-comentarios').value,
                timestamp: new Date().toISOString()
            };
            
            // Si es pago de libro específico
            if (pago.concepto === 'libro') {
                const libroId = document.getElementById('pago-libro-select').value;
                if (libroId) {
                    const libros = DB.get('libros');
                    const libro = libros.find(l => l.id === libroId);
                    libro.abonado = (libro.abonado || 0) + pago.monto;
                    libro.saldo = Math.max(0, (libro.saldo || libro.costoTotal) - pago.monto);
                    libro.pagos = libro.pagos || [];
                    libro.pagos.push({
                        fecha: pago.fecha,
                        monto: pago.monto,
                        comentarios: pago.comentarios
                    });
                    DB.set('libros', libros);
                    pago.libroId = libroId;
                }
            }
            
            pagos.push(pago);
            DB.set('pagos', pagos);
            
            utils.auditar('Pago registrado', `${pago.concepto} - ${utils.money(pago.monto)}`);
            utils.toast('Pago registrado correctamente');
            
            document.getElementById('form-pago').reset();
            document.getElementById('form-pago').classList.add('hidden');
            loadPagos();
            loadDashboard();
        }

        function loadPagos() {
            const pagos = DB.get('pagos').sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 50);
            const alumnos = DB.get('alumnos');
            
            document.getElementById('tabla-pagos').innerHTML = pagos.map(p => {
                const alumno = alumnos.find(a => a.id === p.alumnoId);
                return `<tr>
                    <td class="py-2 px-3 text-xs">${utils.fecha(p.fecha)}</td>
                    <td class="py-2 px-3 font-medium">${alumno?.nombre || 'N/A'}</td>
                    <td class="py-2 px-3 capitalize">${p.concepto} ${p.mes ? '(' + utils.mesNombre(p.mes) + ')' : ''}</td>
                    <td class="py-2 px-3 text-right font-bold text-green-600">${utils.money(p.monto)}</td>
                    <td class="py-2 px-3 text-xs text-slate-500 max-w-xs truncate">${p.comentarios || '-'}</td>
                    <td class="py-2 px-3 text-center">
                        <button onclick="eliminarPago('${p.id}')" class="text-red-400 hover:text-red-600" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="6" class="text-center py-4 text-slate-500">Sin pagos</td></tr>';
        }

        function eliminarPago(id) {
            utils.confirm('Eliminar Pago', '¿Está seguro de eliminar este pago? Se actualizarán los saldos.', () => {
                let pagos = DB.get('pagos');
                const pago = pagos.find(p => p.id === id);
                
                // Si es de libro, revertir
                if (pago?.libroId) {
                    const libros = DB.get('libros');
                    const libro = libros.find(l => l.id === pago.libroId);
                    if (libro) {
                        libro.abonado = Math.max(0, libro.abonado - pago.monto);
                        libro.saldo = libro.costoTotal - libro.abonado;
                        DB.set('libros', libros);
                    }
                }
                
                pagos = pagos.filter(p => p.id !== id);
                DB.set('pagos', pagos);
                utils.toast('Pago eliminado');
                loadPagos();
                loadDashboard();
            });
        }

        // ==================== LIBROS ====================
        function buscarAlumnoLibro(term) {
            if (term.length < 2) {
                document.getElementById('libro-search-results').innerHTML = '';
                return;
            }
            
            const alumnos = DB.get('alumnos').filter(a => a.nombre.toLowerCase().includes(term.toLowerCase()));
            document.getElementById('libro-search-results').innerHTML = alumnos.map(a => `
                <div class="p-2 bg-slate-50 hover:bg-blue-50 rounded cursor-pointer text-sm" onclick="seleccionarAlumnoLibro('${a.id}')">
                    ${a.nombre}
                </div>
            `).join('');
        }

        function seleccionarAlumnoLibro(id) {
            const alumno = DB.get('alumnos').find(a => a.id === id);
            document.getElementById('libro-alumno-id').value = id;
            document.getElementById('libro-alumno-info').textContent = alumno.nombre;
            document.getElementById('form-libro').classList.remove('hidden');
            document.getElementById('libro-search-results').innerHTML = '';
            document.getElementById('libro-buscar-alumno').value = '';
        }

        function calcularSaldoLibroInicial() {
            const total = parseInt(document.getElementById('libro-costo').value) || 0;
            const abono = parseInt(document.getElementById('libro-abono').value) || 0;
            document.getElementById('libro-saldo-inicial').textContent = utils.money(total - abono);
        }

        function asignarLibro(e) {
            e.preventDefault();
            const libros = DB.get('libros');
            
            const libro = {
                id: utils.id(),
                alumnoId: document.getElementById('libro-alumno-id').value,
                titulo: document.getElementById('libro-titulo').value,
                costoTotal: parseInt(document.getElementById('libro-costo').value) || 0,
                abonado: parseInt(document.getElementById('libro-abono').value) || 0,
                saldo: (parseInt(document.getElementById('libro-costo').value) || 0) - (parseInt(document.getElementById('libro-abono').value) || 0),
                fecha: utils.hoy(),
                comentarios: document.getElementById('libro-comentarios').value,
                pagos: [{
                    fecha: utils.hoy(),
                    monto: parseInt(document.getElementById('libro-abono').value) || 0,
                    comentarios: 'Asignación inicial'
                }]
            };
            
            libros.push(libro);
            DB.set('libros', libros);
            
            // Registrar también como pago
            const pagos = DB.get('pagos');
            pagos.push({
                id: utils.id(),
                alumnoId: libro.alumnoId,
                concepto: 'libro',
                monto: libro.abonado,
                fecha: utils.hoy(),
                comentarios: `Abono inicial: ${libro.titulo}`,
                libroId: libro.id
            });
            DB.set('pagos', pagos);
            
            utils.toast('Libro asignado correctamente');
            document.getElementById('form-libro').reset();
            document.getElementById('form-libro').classList.add('hidden');
            loadLibros();
            loadDashboard();
        }

        function loadLibros() {
            const libros = DB.get('libros');
            const alumnos = DB.get('alumnos');
            
            // Pendientes (con saldo)
            const pendientes = libros.filter(l => l.saldo > 0);
            document.getElementById('lista-libros-pendientes').innerHTML = pendientes.map(l => {
                const alumno = alumnos.find(a => a.id === l.alumnoId);
                const porcentaje = Math.round((l.abonado / l.costoTotal) * 100);
                return `<div class="p-3 bg-amber-50 border border-amber-200 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <div class="font-bold text-sm">${l.titulo}</div>
                            <div class="text-xs text-slate-600">${alumno?.nombre || 'N/A'}</div>
                        </div>
                        <button onclick="abonarLibro('${l.id}')" class="bg-blue-600 text-white text-xs px-3 py-1 rounded hover:bg-blue-700">Abonar</button>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2 mb-1">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${porcentaje}%"></div>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span>${porcentaje}% pagado</span>
                        <span class="font-bold text-amber-700">Falta: ${utils.money(l.saldo)}</span>
                    </div>
                </div>`;
            }).join('') || '<p class="text-slate-500 text-center py-4">No hay libros pendientes</p>';
            
            // Tabla completa
            document.getElementById('tabla-libros').innerHTML = libros.map(l => {
                const alumno = alumnos.find(a => a.id === l.alumnoId);
                const porcentaje = Math.round((l.abonado / l.costoTotal) * 100);
                return `<tr>
                    <td class="py-2 px-3">${alumno?.nombre || 'N/A'}</td>
                    <td class="py-2 px-3 text-sm">${l.titulo}</td>
                    <td class="py-2 px-3 text-right text-sm">${utils.money(l.costoTotal)}</td>
                    <td class="py-2 px-3 text-right text-sm text-green-600">${utils.money(l.abonado)}</td>
                    <td class="py-2 px-3 text-right text-sm font-bold ${l.saldo > 0 ? 'text-red-600' : 'text-green-600'}">${utils.money(l.saldo)}</td>
                    <td class="py-2 px-3 text-center text-xs">${porcentaje}%</td>
                    <td class="py-2 px-3 text-center">
                        ${l.saldo > 0 ? `<button onclick="abonarLibro('${l.id}')" class="text-blue-600 hover:text-blue-800" title="Abonar"><i class="fas fa-plus-circle"></i></button>` : '<i class="fas fa-check-circle text-green-500"></i>'}
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="7" class="text-center py-4 text-slate-500">Sin libros registrados</td></tr>';
        }

        function abonarLibro(libroId) {
            const libro = DB.get('libros').find(l => l.id === libroId);
            const monto = prompt(`Ingrese monto a abonar (Saldo actual: ${utils.money(libro.saldo)}):`);
            if (!monto || isNaN(monto) || monto <= 0) return;
            
            const montoNum = parseInt(monto);
            if (montoNum > libro.saldo) {
                utils.toast('El monto no puede superar el saldo', 'error');
                return;
            }
            
            libro.abonado += montoNum;
            libro.saldo -= montoNum;
            libro.pagos.push({
                fecha: utils.hoy(),
                monto: montoNum,
                comentarios: 'Abono parcial'
            });
            
            const libros = DB.get('libros');
            const idx = libros.findIndex(l => l.id === libroId);
            libros[idx] = libro;
            DB.set('libros', libros);
            
            // Registrar pago
            const pagos = DB.get('pagos');
            pagos.push({
                id: utils.id(),
                alumnoId: libro.alumnoId,
                concepto: 'libro',
                monto: montoNum,
                fecha: utils.hoy(),
                comentarios: `Abono libro: ${libro.titulo}`,
                libroId: libro.id
            });
            DB.set('pagos', pagos);
            
            utils.toast('Abono registrado');
            loadLibros();
            loadDashboard();
        }

        // ==================== GASTOS ====================
        function toggleCuotaGasto(esCuota) {
            document.getElementById('campos-cuota').classList.toggle('hidden', !esCuota);
        }

        function guardarGasto(e) {
            e.preventDefault();
            const gastos = DB.get('gastos');
            
            const gasto = {
                id: utils.id(),
                concepto: document.getElementById('gasto-concepto').value,
                monto: parseInt(document.getElementById('gasto-monto').value) || 0,
                fecha: document.getElementById('gasto-fecha').value,
                categoria: document.getElementById('gasto-categoria').value,
                esCuota: document.getElementById('gasto-es-cuota').checked,
                cuotaInfo: document.getElementById('gasto-es-cuota').checked ? {
                    numero: document.getElementById('gasto-cuota-numero').value,
                    total: document.getElementById('gasto-cuota-total').value,
                    detalle: document.getElementById('gasto-cuota-detalle').value
                } : null
            };
            
            gastos.push(gasto);
            DB.set('gastos', gastos);
            
            utils.auditar('Gasto registrado', `${gasto.concepto} - ${utils.money(gasto.monto)}`);
            utils.toast('Gasto registrado');
            
            document.getElementById('form-gasto').reset();
            document.getElementById('gasto-fecha').value = utils.hoy();
            loadGastos();
        }

        function loadGastos() {
            const gastos = DB.get('gastos').sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            
            document.getElementById('tabla-gastos').innerHTML = gastos.map(g => `<tr>
                <td class="py-2 px-3 text-xs">${utils.fecha(g.fecha)}</td>
                <td class="py-2 px-3">${g.concepto}</td>
                <td class="py-2 px-3 text-xs capitalize">${g.categoria}</td>
                <td class="py-2 px-3 text-right font-bold text-red-600">${utils.money(g.monto)}</td>
                <td class="py-2 px-3 text-center text-xs">
                    ${g.esCuota ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${g.cuotaInfo?.detalle || 'Cuota'}</span>` : '-'}
                </td>
            </tr>`).join('') || '<tr><td colspan="5" class="text-center py-4 text-slate-500">Sin gastos registrados</td></tr>';
        }

        // ==================== CAJA RÁPIDA (POS) ====================
        function openCajaRapida() {
            document.getElementById('modal-caja').classList.add('active');
            document.getElementById('pos-buscar').focus();
        }

        function buscarPos(term) {
            if (term.length < 2) {
                document.getElementById('pos-results').innerHTML = '';
                return;
            }
            
            const alumnos = DB.get('alumnos').filter(a => a.nombre.toLowerCase().includes(term.toLowerCase()));
            document.getElementById('pos-results').innerHTML = alumnos.map(a => `
                <div class="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100" onclick="selectPosAlumno('${a.id}', '${a.nombre}')">
                    <div class="font-medium">${a.nombre}</div>
                    <div class="text-xs text-slate-500">${DB.get('niveles').find(n => n.id == a.nivelId)?.nombre || ''}</div>
                </div>
            `).join('');
        }

        function selectPosAlumno(id, nombre) {
            document.getElementById('pos-alumno-seleccionado').classList.remove('hidden');
            document.getElementById('pos-nombre').textContent = nombre;
            
            const alumno = DB.get('alumnos').find(a => a.id === id);
            document.getElementById('pos-deuda').textContent = `Deuda: ${utils.money(getDeudaMatricula(alumno) + getDeudaLibros(id))}`;
            
            document.getElementById('pos-results').innerHTML = '';
            document.getElementById('pos-buscar').value = '';
            
            // Guardar referencia
            document.getElementById('pos-alumno-seleccionado').dataset.id = id;
        }

        function setPosConcepto(concepto) {
            document.querySelectorAll('.pos-concepto-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-slate-100', 'text-slate-700');
            });
            event.target.classList.remove('bg-slate-100', 'text-slate-700');
            event.target.classList.add('bg-blue-600', 'text-white');
            
            document.getElementById('pos-alumno-seleccionado').dataset.concepto = concepto;
            
            // Auto-sugerir monto
            const alumnoId = document.getElementById('pos-alumno-seleccionado').dataset.id;
            const alumno = DB.get('alumnos').find(a => a.id === alumnoId);
            
            if (concepto === 'mensualidad' && alumno) {
                const nivel = DB.get('niveles').find(n => n.id == alumno.nivelId);
                document.getElementById('pos-monto').value = nivel?.precio || '';
            } else if (concepto === 'matricula' && alumno) {
                const tipo = DB.get('tiposMatricula').find(t => t.id == alumno.tipoMatriculaId);
                const config = DB.get('config');
                let monto = config.matriculaBase;
                if (tipo?.esFijo) monto -= tipo.descuentoFijo;
                else monto = monto * (tipo?.porcentaje || 100) / 100;
                document.getElementById('pos-monto').value = monto;
            }
        }

        function procesarPos() {
            const alumnoId = document.getElementById('pos-alumno-seleccionado').dataset.id;
            const concepto = document.getElementById('pos-alumno-seleccionado').dataset.concepto;
            const monto = parseInt(document.getElementById('pos-monto').value);
            const comentario = document.getElementById('pos-comentario').value;
            
            if (!alumnoId || !concepto || !monto) {
                utils.toast('Complete todos los campos', 'error');
                return;
            }
            
            const pagos = DB.get('pagos');
            pagos.push({
                id: utils.id(),
                alumnoId,
                concepto,
                monto,
                fecha: utils.hoy(),
                mes: concepto === 'mensualidad' ? (new Date().getMonth() + 1) : null,
                comentarios: comentario,
                timestamp: new Date().toISOString()
            });
            
            DB.set('pagos', pagos);
            utils.toast('✓ Pago registrado correctamente');
            
            // Reset
            document.getElementById('pos-alumno-seleccionado').classList.add('hidden');
            document.getElementById('pos-monto').value = '';
            document.getElementById('pos-comentario').value = '';
            closeModal('modal-caja');
            loadDashboard();
        }

        // ==================== CONFIGURACIÓN ====================
        function loadConfig() {
            const niveles = DB.get('niveles');
            const tipos = DB.get('tiposMatricula');
            const config = DB.get('config');
            
            document.getElementById('config-matricula-base').value = config.matriculaBase;
            document.getElementById('config-mensualidad-base').value = config.mensualidadBase;
            
            document.getElementById('lista-niveles').innerHTML = niveles.map(n => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                    <div>
                        <div class="font-medium">${n.nombre}</div>
                        <div class="text-xs text-slate-500">${utils.money(n.precio)}/mes</div>
                    </div>
                    <button onclick="eliminarNivel('${n.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
            
            renderTiposMatricula();
        }

        function guardarNivel(e) {
            e.preventDefault();
            const niveles = DB.get('niveles');
            niveles.push({
                id: utils.id(),
                nombre: document.getElementById('nivel-nombre').value,
                precio: parseInt(document.getElementById('nivel-precio').value)
            });
            DB.set('niveles', niveles);
            document.getElementById('form-nivel').reset();
            loadConfig();
            utils.toast('Nivel agregado');
        }

        function eliminarNivel(id) {
            const niveles = DB.get('niveles').filter(n => n.id !== id);
            DB.set('niveles', niveles);
            loadConfig();
        }

        function actualizarCostosBase() {
            DB.set('config', {
                matriculaBase: parseInt(document.getElementById('config-matricula-base').value) || 1500,
                mensualidadBase: parseInt(document.getElementById('config-mensualidad-base').value) || 2500
            });
            utils.toast('Costos base actualizados');
        }

        function renderTiposMatricula() {
            const tipos = DB.get('tiposMatricula');
            document.getElementById('lista-tipos-matricula-config').innerHTML = tipos.map(t => `
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium">${t.nombre}</div>
                            <div class="text-xs text-slate-500">
                                ${t.esFijo ? `Desc. fijo: ${utils.money(t.descuentoFijo)}` : `${t.porcentaje}% del valor`}
                            </div>
                        </div>
                        <button onclick="eliminarTipoMat('${t.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function agregarTipoMatricula() {
            const nombre = prompt('Nombre del tipo (ej: Hermano mayor, Beca deporte):');
            if (!nombre) return;
            
            const esFijo = confirm('¿Es un monto fijo de descuento? (OK=Sí, Cancelar=Porcentaje)');
            let descuento, porcentaje;
            
            if (esFijo) {
                descuento = parseInt(prompt('Monto de descuento fijo ($):'));
                porcentaje = 100;
            } else {
                porcentaje = parseInt(prompt('Porcentaje a pagar (ej: 50 para media beca):'));
                descuento = 0;
            }
            
            const tipos = DB.get('tiposMatricula');
            tipos.push({
                id: utils.id(),
                nombre,
                porcentaje,
                esFijo,
                descuentoFijo: descuento
            });
            
            DB.set('tiposMatricula', tipos);
            renderTiposMatricula();
            utils.toast('Tipo de matrícula agregado');
        }

        function eliminarTipoMat(id) {
            const tipos = DB.get('tiposMatricula').filter(t => t.id !== id);
            DB.set('tiposMatricula', tipos);
            renderTiposMatricula();
        }

        function resetearSistema() {
            utils.confirm('⚠️ RESET COMPLETO', 'Esto eliminará TODOS los alumnos, pagos y libros de ' + DB.getYear() + '. ¿Está absolutamente seguro?', () => {
                // Doble confirmación
                if (!confirm('CONFIRMACIÓN FINAL: Escriba "SI" en el siguiente cuadro para confirmar (función de seguridad)')) return;
                
                DB.set('alumnos', []);
                DB.set('pagos', []);
                DB.set('libros', []);
                DB.set('gastos', []);
                DB.set('espera', []);
                DB.set('auditoria', []);
                
                utils.toast('Sistema reseteado para nuevo año lectivo');
                loadDashboard();
            });
        }

        // ==================== IMPORT/EXPORT ====================
        let importData = null;
        let importMode = 'file';

        function setImportMode(mode) {
            importMode = mode;
            document.getElementById('btn-mode-file').className = mode === 'file' ? 'flex-1 py-2 rounded-lg bg-blue-600 text-white text-sm' : 'flex-1 py-2 rounded-lg bg-slate-200 text-slate-700 text-sm';
            document.getElementById('btn-mode-text').className = mode === 'text' ? 'flex-1 py-2 rounded-lg bg-blue-600 text-white text-sm' : 'flex-1 py-2 rounded-lg bg-slate-200 text-slate-700 text-sm';
            
            document.getElementById('import-file-container').classList.toggle('hidden', mode !== 'file');
            document.getElementById('import-text-container').classList.toggle('hidden', mode !== 'text');
        }

        function exportarSeccion(seccion) {
            const year = DB.getYear();
            let data, filename;
            
            if (seccion === 'completo') {
                data = {
                    version: '2.0',
                    year,
                    fecha: new Date().toISOString(),
                    alumnos: DB.get('alumnos'),
                    pagos: DB.get('pagos'),
                    libros: DB.get('libros'),
                    gastos: DB.get('gastos'),
                    niveles: DB.get('niveles'),
                    tiposMatricula: DB.get('tiposMatricula'),
                    config: DB.get('config'),
                    espera: DB.get('espera')
                };
                filename = `alei_backup_completo_${year}.json`;
            } else {
                data = DB.get(seccion) || [];
                filename = `alei_${seccion}_${year}.json`;
            }
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            utils.toast('Descarga iniciada');
        }

        function previewImport() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    importData = JSON.parse(e.target.result);
                    mostrarPreviewImport();
                } catch (err) {
                    utils.toast('Error: Archivo JSON inválido', 'error');
                }
            };
            reader.readAsText(file);
        }

        function previewImportText() {
            const text = document.getElementById('import-textarea').value;
            if (!text) return;
            
            try {
                importData = JSON.parse(text);
                mostrarPreviewImport();
            } catch (err) {
                utils.toast('Error: Texto JSON inválido', 'error');
            }
        }

        function mostrarPreviewImport() {
            const seccion = document.getElementById('import-seccion').value;
            let preview = '';
            let count = 0;
            
            if (seccion === 'completo' && importData.alumnos) {
                count = importData.alumnos.length;
                preview = `Backup completo detectado:<br>
                          • Alumnos: ${importData.alumnos.length}<br>
                          • Pagos: ${importData.pagos?.length || 0}<br>
                          • Libros: ${importData.libros?.length || 0}<br>
                          • Gastos: ${importData.gastos?.length || 0}<br>
                          • Año: ${importData.year || 'No especificado'}`;
            } else if (importData.length !== undefined) {
                count = importData.length;
                preview = `Array de ${count} registros detectado para importar como: ${seccion}`;
            } else if (importData[seccion]) {
                count = importData[seccion].length;
                preview = `Backup parcial detectado:<br>• ${seccion}: ${count} registros`;
            } else {
                preview = 'Estructura no reconocida. Verifique el formato.';
            }
            
            document.getElementById('import-preview-content').innerHTML = preview;
            document.getElementById('import-preview').classList.remove('hidden');
            document.getElementById('btn-importar').classList.toggle('hidden', count === 0);
        }

        function ejecutarImportacion() {
            const seccion = document.getElementById('import-seccion').value;
            
            try {
                if (seccion === 'completo' && importData.alumnos) {
                    DB.set('alumnos', importData.alumnos);
                    DB.set('pagos', importData.pagos || []);
                    DB.set('libros', importData.libros || []);
                    DB.set('gastos', importData.gastos || []);
                    if (importData.niveles) DB.set('niveles', importData.niveles);
                    if (importData.tiposMatricula) DB.set('tiposMatricula', importData.tiposMatricula);
                    if (importData.config) DB.set('config', importData.config);
                    utils.toast('Backup completo restaurado');
                } else if (importData.length !== undefined) {
                    DB.set(seccion, importData);
                    utils.toast(`${seccion} importados: ${importData.length} registros`);
                } else if (importData[seccion]) {
                    DB.set(seccion, importData[seccion]);
                    utils.toast(`${seccion} importados: ${importData[seccion].length} registros`);
                }
                
                // Limpiar
                importData = null;
                document.getElementById('import-file').value = '';
                document.getElementById('import-textarea').value = '';
                document.getElementById('import-preview').classList.add('hidden');
                document.getElementById('btn-importar').classList.add('hidden');
                
                loadDashboard();
            } catch (err) {
                utils.toast('Error al importar: ' + err.message, 'error');
            }
        }

        // ==================== PRE-INSCRIPCIONES ====================
        function guardarEspera(e) {
            e.preventDefault();
            const espera = DB.get('espera');
            
            espera.push({
                id: utils.id(),
                nombre: document.getElementById('espera-nombre').value,
                telefono: document.getElementById('espera-telefono').value,
                nivelId: document.getElementById('espera-nivel').value,
                notas: document.getElementById('espera-notas').value,
                fecha: utils.hoy(),
                estado: 'pendiente'
            });
            
            DB.set('espera', espera);
            utils.toast('Agregado a lista de espera');
            document.getElementById('form-espera').reset();
            loadEspera();
        }

        function loadEspera() {
            const espera = DB.get('espera').sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            const niveles = DB.get('niveles');
            
            document.getElementById('tabla-espera').innerHTML = espera.map(e => `
                <tr class="${e.estado === 'convertido' ? 'bg-green-50' : ''}">
                    <td class="py-2 px-3 text-xs">${utils.fecha(e.fecha)}</td>
                    <td class="py-2 px-3 font-medium">${e.nombre}</td>
                    <td class="py-2 px-3 text-sm">${e.telefono}</td>
                    <td class="py-2 px-3 text-sm">${niveles.find(n => n.id == e.nivelId)?.nombre || '-'}</td>
                    <td class="py-2 px-3">
                        <span class="px-2 py-1 rounded text-xs ${e.estado === 'convertido' ? 'bg-green-200 text-green-800' : 'bg-amber-200 text-amber-800'}">
                            ${e.estado === 'convertido' ? 'Convertido' : 'Pendiente'}
                        </span>
                    </td>
                    <td class="py-2 px-3 text-center">
                        ${e.estado !== 'convertido' ? `
                            <button onclick="convertirEspera('${e.id}')" class="text-green-600 hover:text-green-800 mr-2" title="Convertir a alumno"><i class="fas fa-user-check"></i></button>
                            <button onclick="eliminarEspera('${e.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        ` : '<i class="fas fa-check text-green-500"></i>'}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6" class="text-center py-4 text-slate-500">Lista de espera vacía</td></tr>';
        }

        function convertirEspera(id) {
            const espera = DB.get('espera');
            const item = espera.find(e => e.id === id);
            if (!item) return;
            
            // Preenlazar formulario de alumno
            switchTab('alumnos');
            document.getElementById('alumno-nombre').value = item.nombre;
            document.getElementById('alumno-nivel').value = item.nivelId;
            
            // Marcar como convertido
            item.estado = 'convertido';
            DB.set('espera', espera);
            loadEspera();
            
            utils.toast('Complete los datos del nuevo alumno');
        }

        function eliminarEspera(id) {
            const espera = DB.get('espera').filter(e => e.id !== id);
            DB.set('espera', espera);
            loadEspera();
        }

        // ==================== WHATSAPP ====================
        function generarMensajeWhatsApp() {
            const tipo = document.getElementById('whatsapp-tipo').value;
            const alumnos = DB.get('alumnos');
            let mensajes = [];
            
            if (tipo === 'atraso') {
                const mes = new Date().getMonth() + 1;
                const pagos = DB.get('pagos');
                
                alumnos.forEach(a => {
                    const pago = pagos.find(p => p.alumnoId === a.id && p.concepto === 'mensualidad' && p.mes == mes);
                    if (!pago) {
                        const nivel = DB.get('niveles').find(n => n.id == a.nivelId);
                        mensajes.push({
                            nombre: a.nombre,
                            msg: `Hola ${a.tutor?.nombre || 'Padres de ' + a.nombre.split(' ')[0]}, le recordamos que la mensualidad de ${utils.mesNombre(mes)} de ${a.nombre} está pendiente. Valor: ${utils.money(nivel?.precio || 0)}. Agradecemos su pronto pago. ALEI Instituto.`
                        });
                    }
                });
            } else if (tipo === 'libro') {
                const libros = DB.get('libros').filter(l => l.saldo > 0);
                libros.forEach(l => {
                    const a = alumnos.find(al => al.id === l.alumnoId);
                    if (a) {
                        mensajes.push({
                            nombre: a.nombre,
                            msg: `Hola, le recordamos que ${a.nombre} tiene saldo pendiente del libro ${l.titulo}: ${utils.money(l.saldo)}. Gracias. ALEI.`
                        });
                    }
                });
            }
            
            if (mensajes.length > 0) {
                document.getElementById('whatsapp-preview').value = mensajes[0].msg;
                document.getElementById('whatsapp-preview').classList.remove('hidden');
                document.getElementById('btn-copiar-wa').classList.remove('hidden');
                window.mensajesPendientes = mensajes;
                utils.toast(`${mensajes.length} mensajes generados`);
            } else {
                utils.toast('No hay deudores para este concepto');
            }
        }

        function copiarWhatsApp() {
            const textarea = document.getElementById('whatsapp-preview');
            textarea.select();
            document.execCommand('copy');
            utils.toast('Mensaje copiado al portapapeles');
        }

        // ==================== REPORTES ====================
        function loadReportes() {
            // Cargar movimientos recientes
            const auditoria = DB.get('auditoria').slice(0, 20);
            document.getElementById('tabla-auditoria').innerHTML = auditoria.map(a => `
                <tr class="text-xs">
                    <td class="py-2 px-3">${new Date(a.fecha).toLocaleString('es-UY')}</td>
                    <td class="py-2 px-3">${a.usuario}</td>
                    <td class="py-2 px-3">${a.accion}</td>
                    <td class="py-2 px-3 text-slate-500">${a.detalle}</td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="text-center py-4">Sin registros</tr>';
            
            // Resumen financiero
            const pagos = DB.get('pagos');
            const gastos = DB.get('gastos');
            const totalIngresos = pagos.reduce((sum, p) => sum + p.monto, 0);
            const totalGastos = gastos.reduce((sum, g) => sum + g.monto, 0);
            
            document.getElementById('resumen-financiero').innerHTML = `
                <div class="flex justify-between p-3 bg-green-50 rounded-lg">
                    <span>Total Ingresos:</span>
                    <span class="font-bold text-green-700">${utils.money(totalIngresos)}</span>
                </div>
                <div class="flex justify-between p-3 bg-red-50 rounded-lg">
                    <span>Total Gastos:</span>
                    <span class="font-bold text-red-700">${utils.money(totalGastos)}</span>
                </div>
                <div class="flex justify-between p-3 bg-blue-50 rounded-lg font-bold">
                    <span>Balance:</span>
                    <span class="${totalIngresos - totalGastos >= 0 ? 'text-green-700' : 'text-red-700'}">${utils.money(totalIngresos - totalGastos)}</span>
                </div>
            `;
        }

        function generarEstadoCuenta() {
            const mes = parseInt(document.getElementById('reporte-mes').value);
            const alumnos = DB.get('alumnos');
            const pagos = DB.get('pagos');
            const niveles = DB.get('niveles');
            
            let html = '<div class="space-y-2">';
            
            alumnos.forEach(a => {
                const pago = pagos.find(p => p.alumnoId === a.id && p.concepto === 'mensualidad' && p.mes == mes);
                const nivel = niveles.find(n => n.id == a.nivelId);
                const estado = pago ? 
                    `<span class="text-green-600 font-bold"><i class="fas fa-check mr-1"></i>Pagó ${utils.money(pago.monto)}</span>` :
                    `<span class="text-red-600 font-bold"><i class="fas fa-times mr-1"></i>Debe ${utils.money(nivel?.precio || 0)}</span>`;
                
                html += `<div class="flex justify-between items-center p-3 ${pago ? 'bg-green-50' : 'bg-red-50'} rounded-lg">
                    <div>
                        <div class="font-medium text-sm">${a.nombre}</div>
                        <div class="text-xs text-slate-500">${nivel?.nombre || ''}</div>
                    </div>
                    ${estado}
                </div>`;
            });
            
            html += '</div>';
            document.getElementById('estado-cuenta-result').innerHTML = html;
            document.getElementById('estado-cuenta-result').classList.remove('hidden');
        }

        // ==================== BÚSQUEDA GLOBAL ====================
        function globalSearch() {
            const term = document.getElementById('global-search').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            
            if (term.length < 2) {
                resultsDiv.classList.add('hidden');
                return;
            }
            
            const alumnos = DB.get('alumnos').filter(a => a.nombre.toLowerCase().includes(term));
            const libros = DB.get('libros').filter(l => l.titulo.toLowerCase().includes(term));
            
            let html = '';
            
            if (alumnos.length) {
                html += '<div class="p-2 bg-slate-100 text-xs font-bold text-slate-600">ALUMNOS</div>';
                html += alumnos.map(a => `
                    <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-100" onclick="verFicha('${a.id}'); document.getElementById('search-results').classList.add('hidden');">
                        <div class="font-medium">${a.nombre.replace(new RegExp(term, 'gi'), match => `<span class="search-highlight">${match}</span>`)}</div>
                        <div class="text-xs text-slate-500">${DB.get('niveles').find(n => n.id == a.nivelId)?.nombre || ''}</div>
                    </div>
                `).join('');
            }
            
            if (libros.length) {
                html += '<div class="p-2 bg-slate-100 text-xs font-bold text-slate-600">LIBROS</div>';
                html += libros.map(l => {
                    const a = DB.get('alumnos').find(al => al.id === l.alumnoId);
                    return `<div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-100">
                        <div class="font-medium">${l.titulo.replace(new RegExp(term, 'gi'), match => `<span class="search-highlight">${match}</span>`)}</div>
                        <div class="text-xs text-slate-500">${a?.nombre || ''} - Saldo: ${utils.money(l.saldo)}</div>
                    </div>`;
                }).join('');
            }
            
            resultsDiv.innerHTML = html || '<div class="p-4 text-center text-slate-500">Sin resultados</div>';
            resultsDiv.classList.remove('hidden');
        }

        // ==================== MODALES ====================
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ==================== INICIALIZACIÓN ====================
        document.addEventListener('DOMContentLoaded', () => {
            DB.init();
            
            // Actualizar fecha
            const hoy = new Date();
            document.getElementById('current-date').textContent = hoy.toLocaleDateString('es-UY', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
            
            // Cambio de año
            document.getElementById('global-year-selector').addEventListener('change', (e) => {
                DB.init();
                loadDashboard();
                utils.toast(`Trabajando en año: ${e.target.value}`);
            });
            
            loadDashboard();
            
            // Cerrar modales al click fuera
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('active');
                });
            });
            
            // Click outside search
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#global-search') && !e.target.closest('#search-results')) {
                    document.getElementById('search-results').classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
